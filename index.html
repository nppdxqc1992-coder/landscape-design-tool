<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™¯è§‚è®¾è®¡æ–‡æœ¬æ’ç‰ˆå·¥å…·</title>
  <!-- PDF.jsï¼šç”¨äºä»PDFæ–‡ä»¶ä¸­æå–æ–‡å­—å†…å®¹ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <style>
    /* ================================================
       å…¨å±€å˜é‡ & Reset
    ================================================ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f5f5f7;
      --surface: #ffffff;
      --surface-2: #f2f2f2;
      --border: #d2d2d7;
      --text-primary: #1d1d1f;
      --text-secondary: #6e6e73;
      --accent: #0071e3;
      --accent-hover: #0077ed;
      --radius: 10px;
      --panel-w: 360px;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Helvetica Neue', sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
    }

    /* ================================================
       é¡¶éƒ¨å¯¼èˆªæ 
    ================================================ */
    .navbar {
      height: 52px;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      flex-shrink: 0;
      z-index: 100;
    }
    .navbar-title { font-size: 15px; font-weight: 600; letter-spacing: -0.3px; }
    .navbar-sub { font-size: 12px; color: var(--text-secondary); margin-left: 10px; }
    .navbar-left { display: flex; align-items: center; }
    .navbar-right { display: flex; gap: 8px; }

    /* ================================================
       é€šç”¨æŒ‰é’®
    ================================================ */
    .btn {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 7px 14px; border-radius: 8px;
      font-size: 13px; font-weight: 500;
      cursor: pointer; border: none; font-family: inherit;
      transition: all 0.15s; white-space: nowrap;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
    .btn-secondary { background: var(--surface); color: var(--text-primary); border: 1px solid var(--border); }
    .btn-secondary:hover:not(:disabled) { background: var(--surface-2); }
    .btn-ghost { background: transparent; color: var(--accent); }
    .btn-ghost:hover:not(:disabled) { background: rgba(0,113,227,0.08); }
    .btn-block { width: 100%; justify-content: center; }

    /* ================================================
       ä¸»ä½“å¸ƒå±€
    ================================================ */
    .app-body { display: flex; flex: 1; overflow: hidden; }

    /* ================================================
       å·¦ä¾§é¢æ¿
    ================================================ */
    .left-panel {
      width: var(--panel-w);
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0;
    }

    /* Tabæ  */
    .tab-bar {
      display: flex; padding: 12px 16px 0; gap: 4px;
      border-bottom: 1px solid var(--border); flex-shrink: 0;
    }
    .tab {
      padding: 8px 14px; border-radius: 8px 8px 0 0;
      font-size: 12px; font-weight: 500; cursor: pointer;
      color: var(--text-secondary);
      border: 1px solid transparent; border-bottom: none;
      transition: all 0.15s; white-space: nowrap;
    }
    .tab.active {
      color: var(--accent); background: var(--bg);
      border-color: var(--border); border-bottom-color: var(--bg);
      position: relative; top: 1px;
    }

    /* ================================================
       ç¬¬ä¸€ç« ï¼šæ–°ä¸‰æ®µå¼å¸ƒå±€
       ä¸Šï¼šè¾“å…¥åŒºï¼ˆå›ºå®šï¼‰
       ä¸­ï¼šå¯¹è¯åŒºï¼ˆæ»šåŠ¨ï¼‰
       ä¸‹ï¼šè¾“å…¥æ¡†ï¼ˆå›ºå®šï¼‰
    ================================================ */
    #panel-ch1 {
      display: flex; flex-direction: column; flex: 1; overflow: hidden;
    }

    /* ä¸Šæ®µï¼šè¾“å…¥åŒº */
    .ch1-input-section {
      padding: 14px 16px 12px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    /* APIçŠ¶æ€æ  */
    .api-bar {
      background: var(--bg); border-radius: var(--radius);
      padding: 8px 12px;
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 12px;
    }
    .api-status { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); }
    .status-dot { width: 7px; height: 7px; border-radius: 50%; background: #ff3b30; flex-shrink: 0; }
    .status-dot.on { background: #34c759; }

    /* è¾“å…¥æ–¹å¼é€‰æ‹©å™¨ */
    .input-modes {
      display: flex; background: var(--surface-2);
      border-radius: 8px; padding: 3px; margin-bottom: 12px; gap: 2px;
    }
    .im-btn {
      flex: 1; padding: 5px 4px; border-radius: 6px;
      font-size: 11px; font-weight: 500; cursor: pointer;
      border: none; background: transparent; color: var(--text-secondary);
      font-family: inherit; transition: all 0.15s; text-align: center;
    }
    .im-btn.active {
      background: white; color: var(--text-primary);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    /* æ–‡æœ¬ç²˜è´´ */
    .input, .textarea, .select {
      width: 100%; padding: 8px 11px; border-radius: var(--radius);
      border: 1px solid var(--border); font-size: 13px; font-family: inherit;
      background: var(--bg); color: var(--text-primary);
      outline: none; transition: border-color 0.15s, background 0.15s;
    }
    .input:focus, .textarea:focus { border-color: var(--accent); background: white; }
    .textarea { resize: vertical; min-height: 90px; line-height: 1.6; }

    /* ä¸Šä¼ åŒºåŸŸ */
    .upload-zone {
      border: 1.5px dashed var(--border); border-radius: var(--radius);
      padding: 18px 12px; text-align: center; cursor: pointer;
      transition: all 0.15s; background: var(--bg);
    }
    .upload-zone:hover { border-color: var(--accent); background: rgba(0,113,227,0.04); }
    .upload-zone-icon { margin-bottom: 8px; opacity: 0.4; }
    .upload-zone-title { font-size: 13px; font-weight: 500; margin-bottom: 3px; }
    .upload-zone-hint { font-size: 11px; color: var(--text-secondary); line-height: 1.5; }

    /* å›¾ç‰‡é¢„è§ˆ */
    .img-preview-wrap { position: relative; border-radius: var(--radius); overflow: hidden; }
    .img-preview-wrap img { width: 100%; display: block; border-radius: var(--radius); }
    .img-preview-clear {
      position: absolute; top: 6px; right: 6px;
      background: rgba(0,0,0,0.55); color: white;
      border: none; border-radius: 20px;
      padding: 3px 9px; font-size: 11px; cursor: pointer; font-family: inherit;
    }

    /* æ–‡ä»¶å·²åŠ è½½æç¤º */
    .file-loaded {
      background: rgba(52,199,89,0.1); border: 1px solid rgba(52,199,89,0.3);
      border-radius: var(--radius); padding: 10px 12px;
      display: flex; align-items: center; gap: 8px;
    }
    .file-loaded-name { font-size: 12px; font-weight: 500; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .file-loaded-clear { font-size: 11px; color: var(--text-secondary); cursor: pointer; text-decoration: underline; }

    /* åˆ†ææŒ‰é’® */
    .analyze-btn {
      width: 100%; display: flex; align-items: center; justify-content: center;
      gap: 6px; padding: 9px; border-radius: 9px;
      background: var(--accent); color: white;
      border: none; font-size: 13px; font-weight: 600;
      cursor: pointer; font-family: inherit; transition: all 0.15s;
      margin-top: 10px;
    }
    .analyze-btn:hover:not(:disabled) { background: var(--accent-hover); }
    .analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ================================================
       ä¸­æ®µï¼šå¯¹è¯åŒº
    ================================================ */
    .chat-area {
      flex: 1; overflow-y: auto; padding: 14px 14px;
      display: flex; flex-direction: column; gap: 14px;
    }
    .chat-area::-webkit-scrollbar { width: 4px; }
    .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* ç©ºçŠ¶æ€æç¤º */
    .chat-empty {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; height: 100%; gap: 10px; color: var(--text-secondary);
      text-align: center; padding: 20px;
    }
    .chat-empty svg { opacity: 0.3; }
    .chat-empty p { font-size: 12px; line-height: 1.7; }

    /* æ¶ˆæ¯æ¡ */
    .chat-msg { display: flex; gap: 7px; align-items: flex-start; }
    .chat-msg.user-msg { flex-direction: row-reverse; }

    /* å¤´åƒ */
    .msg-avatar {
      width: 26px; height: 26px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 700; flex-shrink: 0; color: white;
    }
    .msg-avatar.ai { background: var(--accent); }
    .msg-avatar.user { background: #34c759; }

    /* æ°”æ³¡å®¹å™¨ */
    .msg-body { display: flex; flex-direction: column; gap: 6px; max-width: calc(100% - 36px); }

    /* çº¯æ–‡å­—æ°”æ³¡ */
    .msg-bubble {
      padding: 9px 12px; border-radius: 10px;
      font-size: 12px; line-height: 1.7;
    }
    .ai-bubble { background: var(--bg); color: var(--text-primary); border-radius: 2px 10px 10px 10px; }
    .user-bubble { background: var(--accent); color: white; border-radius: 10px 2px 10px 10px; }

    /* åˆ†æç»“æœå¡ç‰‡ */
    .sec-card { border: 1px solid var(--border); border-radius: 9px; overflow: hidden; margin-top: 4px; }
    .sec-card-head {
      display: flex; align-items: center; justify-content: space-between;
      padding: 7px 11px; background: var(--surface-2);
      border-bottom: 1px solid var(--border);
    }
    .sec-card-label { font-size: 11px; font-weight: 600; color: var(--text-secondary); display: flex; align-items: center; gap: 5px; }
    .sec-card-dot { width: 8px; height: 8px; border-radius: 50%; }
    .sec-card-body { padding: 10px 11px; }
    .sec-card-title { font-size: 12px; font-weight: 600; margin-bottom: 5px; }
    .sec-card-text { font-size: 11.5px; color: #3a3a3c; line-height: 1.7; margin-bottom: 8px; }
    .sec-card-kws { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }
    .kw-tag {
      font-size: 10px; padding: 2px 8px;
      background: rgba(0,113,227,0.1); color: var(--accent);
      border-radius: 20px; font-weight: 500;
    }
    .apply-btn-sm {
      font-size: 11px; padding: 4px 11px; border-radius: 6px;
      border: 1px solid var(--accent); color: var(--accent);
      background: transparent; cursor: pointer; font-family: inherit; transition: all 0.15s;
    }
    .apply-btn-sm:hover { background: rgba(0,113,227,0.08); }
    .apply-btn-sm.applied { background: #34c759; border-color: #34c759; color: white; }

    /* è·Ÿè¿›å›å¤çš„åº”ç”¨æŒ‰é’®è¡Œ */
    .apply-row {
      display: flex; flex-wrap: wrap; gap: 5px; align-items: center;
      padding: 6px 12px 9px;
    }
    .apply-row-label { font-size: 10px; color: var(--text-secondary); margin-right: 2px; }
    .apply-to-btn {
      font-size: 10px; padding: 3px 9px; border-radius: 5px;
      border: 1px solid var(--border); background: var(--surface-2);
      color: var(--text-secondary); cursor: pointer; font-family: inherit; transition: all 0.15s;
    }
    .apply-to-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* åŠ è½½ä¸­æ°”æ³¡ */
    .typing-bubble {
      display: flex; align-items: center; gap: 5px;
      padding: 10px 14px; background: var(--bg);
      border-radius: 2px 10px 10px 10px;
    }
    .typing-dot {
      width: 6px; height: 6px; border-radius: 50%; background: var(--text-secondary);
      animation: typing 1.2s ease-in-out infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%,60%,100% { opacity: 0.3; transform: translateY(0); } 30% { opacity: 1; transform: translateY(-3px); } }

    /* ================================================
       ä¸‹æ®µï¼šèŠå¤©è¾“å…¥æ¡†
    ================================================ */
    .chat-input-row {
      border-top: 1px solid var(--border);
      padding: 10px 12px;
      display: flex; gap: 7px; align-items: flex-end;
      flex-shrink: 0; background: white;
    }
    .chat-textarea {
      flex: 1; border: 1px solid var(--border); border-radius: 8px;
      padding: 7px 10px; font-size: 12px; font-family: inherit;
      resize: none; outline: none;
      max-height: 72px; min-height: 34px;
      line-height: 1.5; overflow-y: auto;
      transition: border-color 0.15s;
    }
    .chat-textarea:focus { border-color: var(--accent); }
    .send-btn {
      background: var(--accent); color: white; border: none;
      border-radius: 8px; width: 34px; height: 34px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; flex-shrink: 0; transition: background 0.15s;
    }
    .send-btn:hover { background: var(--accent-hover); }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* è¾“å…¥æç¤º */
    .chat-hint-text {
      font-size: 11px; color: var(--text-secondary);
      text-align: center; padding: 5px 0; flex-shrink: 0;
    }

    /* ================================================
       ç¬¬äºŒç« ï¼šé¢æ¿ï¼ˆåŸæœ‰é€»è¾‘ä¿ç•™ï¼‰
    ================================================ */
    .panel-scroll {
      flex: 1; overflow-y: auto; padding: 16px;
    }
    .panel-scroll::-webkit-scrollbar { width: 4px; }
    .panel-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .field-group { margin-bottom: 14px; }
    .field-label { display: block; font-size: 12px; font-weight: 500; color: var(--text-primary); margin-bottom: 5px; }
    .field-sub { font-size: 11px; color: var(--text-secondary); font-weight: 400; margin-left: 4px; }
    .section-header { font-size: 11px; font-weight: 600; letter-spacing: 0.5px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; margin-top: 4px; }
    .divider { height: 1px; background: var(--border); margin: 14px 0; }

    .steps { display: flex; align-items: center; margin-bottom: 18px; }
    .step-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text-secondary); }
    .step-num { width: 20px; height: 20px; border-radius: 50%; background: var(--border); color: white; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background 0.2s; }
    .step-item.active .step-num { background: var(--accent); }
    .step-item.done .step-num { background: #34c759; }
    .step-line { flex: 1; height: 1px; background: var(--border); margin: 0 6px; }

    .version-card { border: 1.5px solid var(--border); border-radius: var(--radius); padding: 13px; cursor: pointer; transition: all 0.15s; margin-bottom: 8px; }
    .version-card:hover { border-color: var(--accent); }
    .version-card.selected { border-color: var(--accent); background: rgba(0,113,227,0.04); }
    .version-tag { font-size: 11px; font-weight: 600; color: var(--accent); background: rgba(0,113,227,0.1); padding: 2px 8px; border-radius: 20px; display: inline-block; margin-bottom: 7px; }
    .version-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .version-tagline { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }

    /* ================================================
       å³ä¾§é¢„è§ˆåŒº
    ================================================ */
    .preview-area {
      flex: 1; background: #e0e0e5; overflow: auto;
      display: flex; flex-direction: column; align-items: center;
      padding: 24px 40px; gap: 20px;
    }
    .preview-area::-webkit-scrollbar { width: 6px; height: 6px; }
    .preview-area::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }

    .preview-toolbar {
      background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
      border-radius: var(--radius); padding: 8px 16px;
      display: flex; align-items: center; gap: 12px;
      width: 100%; max-width: 1100px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky; top: 0; z-index: 10; flex-shrink: 0;
    }
    .zoom-btns { display: flex; align-items: center; gap: 6px; margin-left: auto; font-size: 12px; }

    .pages-wrap { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; }
    .page-wrap { position: relative; flex-shrink: 0; }
    .page-num-label { position: absolute; left: -28px; top: 50%; transform: translateY(-50%); font-size: 11px; color: #9a9a9e; writing-mode: vertical-rl; }
    .a3-page { background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.18); position: relative; overflow: hidden; flex-shrink: 0; }
    .img-slot { background: #f0f0f5; border: 1.5px dashed #c7c7cc; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.15s; overflow: hidden; flex-shrink: 0; }
    .img-slot:hover { background: #e8e8f0; border-color: var(--accent); }
    .img-slot img { width: 100%; height: 100%; object-fit: cover; display: block; }

    /* ================================================
       è®¾ç½®æ¨¡æ€æ¡†
    ================================================ */
    .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 1000; align-items: center; justify-content: center; }
    .overlay.show { display: flex; }
    .modal { background: white; border-radius: 16px; padding: 28px; width: 460px; box-shadow: 0 20px 60px rgba(0,0,0,0.25); }
    .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 20px; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }
    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    /* Toast */
    .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(60px); background: #1d1d1f; color: white; padding: 10px 18px; border-radius: 10px; font-size: 13px; z-index: 2000; transition: transform 0.25s ease; white-space: nowrap; pointer-events: none; }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* æ—‹è½¬åŠ¨ç”» */
    .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.4); border-top-color: white; border-radius: 50%; animation: spin 0.7s linear infinite; display: inline-block; flex-shrink: 0; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ================================================
       æ‹–æ”¾è¦†ç›–å±‚
    ================================================ */
    .drop-overlay {
      position: fixed; inset: 0; z-index: 900;
      background: rgba(0,113,227,0.08);
      border: 3px dashed var(--accent);
      display: flex; align-items: center; justify-content: center;
      pointer-events: none;
      opacity: 0; transition: opacity 0.15s;
    }
    .drop-overlay.show { opacity: 1; }
    .drop-overlay-card {
      background: white; border-radius: 20px;
      padding: 28px 48px; text-align: center;
      box-shadow: 0 16px 48px rgba(0,113,227,0.2);
      border: 2px solid var(--accent);
    }
    .drop-overlay-icon { margin-bottom: 12px; }
    .drop-overlay-title { font-size: 18px; font-weight: 700; color: var(--accent); margin-bottom: 6px; }
    .drop-overlay-sub { font-size: 13px; color: var(--text-secondary); }

    /* å¯¹è¯åŒºæ‹–æ”¾é«˜äº® */
    .chat-area.drag-over {
      background: rgba(0,113,227,0.05);
      border-radius: 10px;
    }
  </style>
</head>
<body>

<!-- æ‹–æ”¾è¦†ç›–å±‚ï¼ˆå…¨å±ï¼‰ -->
<div class="drop-overlay" id="drop-overlay">
  <div class="drop-overlay-card">
    <div class="drop-overlay-icon">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#0071e3" stroke-width="1.5">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
    </div>
    <div class="drop-overlay-title">æ¾å¼€é¼ æ ‡å³å¯å¯¼å…¥</div>
    <div class="drop-overlay-sub" id="drop-overlay-sub">æ”¯æŒ PDFã€å›¾ç‰‡æˆªå›¾ã€.txt æ–‡ä»¶</div>
  </div>
</div>

<!-- ====== é¡¶éƒ¨å¯¼èˆª ====== -->
<nav class="navbar">
  <div class="navbar-left">
    <span class="navbar-title">æ™¯è§‚è®¾è®¡æ–‡æœ¬æ’ç‰ˆå·¥å…·</span>
    <span class="navbar-sub">A3æ¨ªå‘ Â· 420Ã—297mm Â· é¡µè¾¹è·20mm</span>
  </div>
  <div class="navbar-right">
    <button class="btn btn-secondary" onclick="testMinimalIDML()" title="å¯¼å‡ºæœ€ç®€å•çš„æµ‹è¯•IDMLï¼Œç”¨æ¥åˆ¤æ–­é—®é¢˜åœ¨å“ª">
      ğŸ§ª æœ€å°æµ‹è¯•
    </button>
    <button class="btn btn-secondary" onclick="openSettings()">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      è®¾ç½®
    </button>
    <button class="btn btn-primary" onclick="exportIDML()">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      å¯¼å‡º IDML â†’ InDesign
    </button>
  </div>
</nav>

<!-- ====== ä¸»ä½“ ====== -->
<div class="app-body">

  <!-- ===== å·¦ä¾§é¢æ¿ ===== -->
  <div class="left-panel">
    <div class="tab-bar">
      <div class="tab active" onclick="switchTab('ch1', this)">ç¬¬ä¸€ç« ï¼šå‰æœŸåˆ†æ</div>
      <div class="tab" onclick="switchTab('ch2', this)">ç¬¬äºŒç« ï¼šè®¾è®¡æ„æ€</div>
    </div>

    <!-- ===== ç¬¬ä¸€ç« ï¼šä¸‰æ®µå¼å¸ƒå±€ ===== -->
    <div id="panel-ch1" style="display:flex;flex-direction:column;flex:1;overflow:hidden;">

      <!-- ä¸Šæ®µï¼šè¾“å…¥åŒºï¼ˆå›ºå®šï¼‰ -->
      <div class="ch1-input-section">

        <!-- APIçŠ¶æ€ -->
        <div class="api-bar">
          <div class="api-status">
            <div class="status-dot" id="dot1"></div>
            <span id="dot1-text">æœªé…ç½® API Key</span>
          </div>
          <button class="btn btn-ghost" style="padding:3px 8px;font-size:12px;" onclick="openSettings()">å»é…ç½®</button>
        </div>

        <!-- è¾“å…¥æ–¹å¼é€‰æ‹© -->
        <div class="input-modes">
          <button class="im-btn active" onclick="setInputMode(this,'text')">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:3px;vertical-align:-1px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
            ç²˜è´´æ–‡å­—
          </button>
          <button class="im-btn" onclick="setInputMode(this,'file')">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:3px;vertical-align:-1px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            ä¸Šä¼ æ–‡ä»¶
          </button>
          <button class="im-btn" onclick="setInputMode(this,'image')">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:3px;vertical-align:-1px;"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            æˆªå›¾è¯†åˆ«
          </button>
        </div>

        <!-- æ¨¡å¼Aï¼šç²˜è´´æ–‡å­— -->
        <div id="mode-text">
          <textarea class="textarea" id="raw-text" rows="5"
            placeholder="å°†å»ºç­‘è¯´æ˜ä¹¦æˆ–è®¾è®¡ä»»åŠ¡ä¹¦çš„æ–‡å­—å†…å®¹ç²˜è´´åˆ°è¿™é‡Œï¼ŒAI å°†è‡ªåŠ¨åˆ†æå¹¶åŒæ—¶å¡«å†™åŒºä½ã€åŸºåœ°ã€å»ºç­‘åˆ†æä¸‰ä¸ªé¡µé¢â€¦"></textarea>
        </div>

        <!-- æ¨¡å¼Bï¼šä¸Šä¼ æ–‡ä»¶ -->
        <div id="mode-file" style="display:none;">
          <div class="upload-zone" id="file-zone" onclick="document.getElementById('file-input').click()">
            <div class="upload-zone-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#aeaeb2" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            </div>
            <div class="upload-zone-title">ç‚¹å‡»ä¸Šä¼ æ–‡æœ¬æ–‡ä»¶</div>
            <div class="upload-zone-hint">æ”¯æŒ .txt æ ¼å¼<br>
              <span style="color:#ff9500;font-weight:500;">âš  PDF / Word è¯·åœ¨åŸè½¯ä»¶ä¸­å…¨é€‰å¤åˆ¶ï¼Œåˆ‡æ¢åˆ°ã€Œç²˜è´´æ–‡å­—ã€æ¨¡å¼ç²˜è´´</span>
            </div>
          </div>
          <!-- PDFé”™è¯¯æç¤º -->
          <div id="file-pdf-error" style="display:none;background:rgba(255,59,48,0.08);border:1px solid rgba(255,59,48,0.25);border-radius:9px;padding:10px 12px;font-size:12px;line-height:1.6;color:#c0392b;margin-top:8px;">
            <strong>æ£€æµ‹åˆ° PDF æ–‡ä»¶</strong><br>
            PDF æ˜¯å›¾ç‰‡+ä»£ç çš„æ··åˆæ ¼å¼ï¼Œä¸èƒ½ç›´æ¥ä¸Šä¼ ã€‚<br>
            è¯·è¿™æ ·æ“ä½œï¼šæ‰“å¼€ PDF â†’ å…¨é€‰æ–‡å­—ï¼ˆCtrl+Aï¼‰â†’ å¤åˆ¶ï¼ˆCtrl+Cï¼‰â†’ åˆ‡æ¢åˆ°ã€Œç²˜è´´æ–‡å­—ã€æ¨¡å¼ â†’ ç²˜è´´
          </div>
          <div id="file-loaded" class="file-loaded" style="display:none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#34c759" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
            <span class="file-loaded-name" id="file-name"></span>
            <span class="file-loaded-clear" onclick="clearFile()">é‡æ–°ä¸Šä¼ </span>
          </div>
          <input type="file" id="file-input" accept=".txt,.md" style="display:none;" onchange="handleFileUpload(this)">
        </div>

        <!-- æ¨¡å¼Cï¼šæˆªå›¾è¯†åˆ« -->
        <div id="mode-image" style="display:none;">
          <div class="upload-zone" id="img-zone" onclick="document.getElementById('img-input').click()">
            <div class="upload-zone-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#aeaeb2" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            </div>
            <div class="upload-zone-title">ç‚¹å‡»ä¸Šä¼ æˆªå›¾</div>
            <div class="upload-zone-hint">AI å°†è‡ªåŠ¨è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—å†…å®¹</div>
          </div>
          <div id="img-preview-wrap" class="img-preview-wrap" style="display:none;">
            <img id="img-preview-src" src="" alt="">
            <button class="img-preview-clear" onclick="clearImage()">é‡æ–°ä¸Šä¼ </button>
          </div>
          <input type="file" id="img-input" accept="image/*" style="display:none;" onchange="handleImageUpload(this)">
        </div>

        <!-- ä¸€é”®åˆ†ææŒ‰é’® -->
        <button class="analyze-btn" id="analyze-btn" onclick="analyzeAll()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          AI ä¸€é”®åˆ†æå‰æœŸåˆ†æä¸‰é¡µ
        </button>
      </div><!-- /ch1-input-section -->

      <!-- ä¸­æ®µï¼šå¯¹è¯åŒºï¼ˆå¯æ»šåŠ¨ï¼‰ -->
      <div class="chat-area" id="chat-area">
        <div class="chat-empty" id="chat-empty">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#aeaeb2" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <p>æä¾›åŸå§‹æ–‡æœ¬åï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®<br>AI å°†åŒæ—¶åˆ†æä¸‰ä¸ªåˆ†æé¡µé¢çš„å†…å®¹<br>åˆ†æå®Œæˆåå¯åœ¨è¿™é‡Œç»§ç»­å¯¹è¯ä¿®æ”¹</p>
          <p style="margin-top:10px;font-size:11px;color:#c7c7cc;">
            ğŸ’¡ ä¹Ÿå¯ä»¥ç›´æ¥å°† PDF / æˆªå›¾æ‹–å…¥æ­¤åŒºåŸŸ
          </p>
        </div>
        <!-- æ¶ˆæ¯åˆ—è¡¨ï¼ˆåŠ¨æ€æ’å…¥ï¼‰ -->
      </div>

      <!-- ä¸‹æ®µï¼šè¾“å…¥æ¡†ï¼ˆå›ºå®šï¼‰ -->
      <div class="chat-input-row">
        <textarea class="chat-textarea" id="chat-input"
          placeholder="ç»§ç»­å‘ AI æé—®ï¼Œå¦‚"åŒºä½åˆ†æèƒ½æ›´è¯¦ç»†ä¸€äº›"â€¦"
          onkeydown="handleChatKey(event)" rows="1"></textarea>
        <button class="send-btn" id="send-btn" onclick="sendChat()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>

    </div><!-- /panel-ch1 -->

    <!-- ===== ç¬¬äºŒç« ï¼šè®¾è®¡æ„æ€ ===== -->
    <div class="panel-scroll" id="panel-ch2" style="display:none;flex:1;">

      <div class="api-bar">
        <div class="api-status">
          <div class="status-dot" id="dot2"></div>
          <span id="dot2-text">æœªé…ç½® API Key</span>
        </div>
        <button class="btn btn-ghost" style="padding:3px 8px;font-size:12px;" onclick="openSettings()">å»é…ç½®</button>
      </div>

      <div class="steps">
        <div class="step-item active" id="s1"><div class="step-num">1</div><span>é¡¹ç›®ä¿¡æ¯</span></div>
        <div class="step-line"></div>
        <div class="step-item" id="s2"><div class="step-num">2</div><span>é€‰ç‰ˆæœ¬</span></div>
        <div class="step-line"></div>
        <div class="step-item" id="s3"><div class="step-num">3</div><span>ç¡®è®¤</span></div>
      </div>

      <!-- æ­¥éª¤1 -->
      <div id="ch2-s1">
        <div class="field-group">
          <label class="field-label">é¡¹ç›®åç§°</label>
          <input class="input" id="proj-name" placeholder="å¦‚ï¼šç¢§æ¹–èŠ±å›­æ™¯è§‚è®¾è®¡æ–¹æ¡ˆ">
        </div>
        <div class="field-group">
          <label class="field-label">é¡¹ç›®åœ°ç‚¹</label>
          <input class="input" id="proj-loc" placeholder="å¦‚ï¼šæµ™æ±Ÿçœæ­å·å¸‚è¥¿æ¹–åŒº">
        </div>
        <div class="field-group">
          <label class="field-label">é¡¹ç›®ç±»å‹</label>
          <select class="input" id="proj-type">
            <option value="å±…ä½åŒºæ™¯è§‚">å±…ä½åŒºæ™¯è§‚</option>
            <option value="å…¬å›­ç»¿åœ°">å…¬å›­ç»¿åœ°</option>
            <option value="å•†ä¸šå¹¿åœº">å•†ä¸šå¹¿åœº</option>
            <option value="åŠå…¬å›­åŒº">åŠå…¬å›­åŒº</option>
            <option value="å†å²æ–‡åŒ–è¡—åŒº">å†å²æ–‡åŒ–è¡—åŒº</option>
            <option value="æ»¨æ°´æ™¯è§‚">æ»¨æ°´æ™¯è§‚</option>
            <option value="æ ¡å›­æ™¯è§‚">æ ¡å›­æ™¯è§‚</option>
          </select>
        </div>
        <div class="field-group">
          <label class="field-label">é£æ ¼å…³é”®è¯<span class="field-sub">å¯é€‰</span></label>
          <input class="input" id="proj-kw" placeholder="å¦‚ï¼šæ±Ÿå—æ°´ä¹¡ï¼Œç°ä»£ç®€çº¦ï¼Œç”Ÿæ€è‡ªç„¶">
        </div>
        <div class="field-group">
          <label class="field-label">è¡¥å……è¯´æ˜<span class="field-sub">å¯é€‰</span></label>
          <textarea class="textarea" id="proj-extra" rows="3" placeholder="ä¸šä¸»éœ€æ±‚ã€åœºåœ°ç‰¹ç‚¹ç­‰â€¦"></textarea>
        </div>
        <button class="btn btn-primary btn-block" id="gen-btn" onclick="generateConcepts()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
          ç”Ÿæˆä¸‰ä¸ªè®¾è®¡æ„æ€ç‰ˆæœ¬
        </button>
      </div>

      <!-- æ­¥éª¤2 -->
      <div id="ch2-s2" style="display:none;">
        <div class="section-header" style="margin-bottom:12px;">é€‰æ‹©ä¸€ä¸ªæ–¹å‘</div>
        <div id="version-list"></div>
        <div class="divider"></div>
        <button class="btn btn-primary btn-block" onclick="confirmVersion()" style="margin-bottom:8px;">ç¡®è®¤å¹¶è¿›å…¥ç¼–è¾‘</button>
        <button class="btn btn-secondary btn-block" onclick="backToStep1()">é‡æ–°ç”Ÿæˆ</button>
      </div>

      <!-- æ­¥éª¤3 -->
      <div id="ch2-s3" style="display:none;">
        <div class="field-group">
          <label class="field-label">çµæ„Ÿæ¥æº</label>
          <textarea class="textarea" id="inspo" rows="4" placeholder="çµæ„Ÿæ¥æºå†…å®¹â€¦"></textarea>
        </div>
        <div class="field-group">
          <label class="field-label">è®¾è®¡ç†å¿µ</label>
          <textarea class="textarea" id="concept" rows="5" placeholder="è®¾è®¡ç†å¿µå†…å®¹â€¦"></textarea>
        </div>
        <div class="field-group">
          <label class="field-label">ä¸»é¢˜è½ä½åˆ†åŒº<span class="field-sub">æ¯è¡Œï¼šåˆ†åŒºåï¼šä¸»é¢˜æè¿°</span></label>
          <textarea class="textarea" id="zones" rows="5" placeholder="å…¥å£å¹¿åœºï¼šæ´»åŠ›è¿å®¾&#10;ä¸­å¿ƒè‰åªï¼šç”Ÿæ€ä¼‘æ†©&#10;æ»¨æ°´æ ˆé“ï¼šäº²æ°´ä½“éªŒ"></textarea>
        </div>
        <button class="btn btn-primary btn-block" onclick="applyToPage('ch2')" style="margin-bottom:8px;">åº”ç”¨åˆ°é¢„è§ˆé¡µé¢</button>
        <button class="btn btn-ghost btn-block" onclick="backToStep2()">è¿”å›é‡æ–°é€‰æ‹©</button>
      </div>

    </div><!-- /panel-ch2 -->
  </div><!-- /left-panel -->

  <!-- ===== å³ä¾§é¢„è§ˆåŒº ===== -->
  <div class="preview-area">
    <div class="preview-toolbar">
      <span style="font-size:13px;font-weight:600;">é¡µé¢é¢„è§ˆ</span>
      <span style="font-size:11px;color:var(--text-secondary);">å…± <span id="pg-count">6</span> é¡µ Â· ç‚¹å‡»å›¾ç‰‡åŒºåŸŸå¯ä¸Šä¼ æœ¬åœ°å›¾ç‰‡</span>
      <div class="zoom-btns">
        <button class="btn btn-secondary" style="padding:4px 10px;" onclick="doZoom(-1)">âˆ’</button>
        <span id="zoom-txt" style="min-width:38px;text-align:center;font-size:12px;">60%</span>
        <button class="btn btn-secondary" style="padding:4px 10px;" onclick="doZoom(1)">+</button>
      </div>
    </div>
    <div class="pages-wrap" id="pages-wrap"></div>
  </div>

</div><!-- /app-body -->

<!-- ====== è®¾ç½®æ¨¡æ€æ¡† ====== -->
<div class="overlay" id="modal-settings">
  <div class="modal">
    <div class="modal-title">è®¾ç½®</div>
    <div class="field-group">
      <label class="field-label">AI æœåŠ¡å•†</label>
      <select class="input" id="s-provider" onchange="updateModelList()">
        <option value="deepseek">DeepSeek</option>
        <option value="doubao">è±†åŒ…ï¼ˆå­—èŠ‚è·³åŠ¨ï¼‰</option>
        <option value="openai">OpenAI</option>
      </select>
    </div>
    <div class="field-group">
      <label class="field-label">API Key</label>
      <input class="input" id="s-apikey" type="password" placeholder="sk-â€¦">
    </div>
    <div class="field-group">
      <label class="field-label">æ¨¡å‹</label>
      <select class="input" id="s-model">
        <option value="deepseek-chat">deepseek-chatï¼ˆæ¨èï¼‰</option>
        <option value="deepseek-reasoner">deepseek-reasonerï¼ˆæ›´å¼ºï¼Œæ›´æ…¢ï¼‰</option>
      </select>
    </div>
    <div class="field-group" id="s-doubao-row" style="display:none;">
      <label class="field-label">è±†åŒ… Endpoint ID<span class="field-sub">è±†åŒ…ä¸“ç”¨</span></label>
      <input class="input" id="s-endpoint" placeholder="ep-xxxxxxxxxx">
    </div>
    <div class="divider"></div>
    <div class="section-header">InDesigné¡µé¢è§„æ ¼</div>
    <div class="settings-grid">
      <div class="field-group">
        <label class="field-label">é¡µå®½ (mm)</label>
        <input class="input" id="s-pw" value="420" type="number">
      </div>
      <div class="field-group">
        <label class="field-label">é¡µé«˜ (mm)</label>
        <input class="input" id="s-ph" value="297" type="number">
      </div>
      <div class="field-group">
        <label class="field-label">é¡µè¾¹è· (mm)</label>
        <input class="input" id="s-pm" value="20" type="number">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ================================================
   å…¨å±€çŠ¶æ€
================================================ */
const S = {
  zoom: 0.6,
  pageW: 420, pageH: 297, pageMargin: 20,
  apiKey: '', provider: 'deepseek', model: 'deepseek-chat', endpoint: '',

  inputMode: 'text',      // å½“å‰è¾“å…¥æ¨¡å¼
  fileText: null,         // æ–‡ä»¶æ¨¡å¼ï¼šè¯»å–åˆ°çš„æ–‡å­—
  imageData: null,        // æˆªå›¾æ¨¡å¼ï¼š{ base64url, mimeType }

  chatHistory: [],        // å¯¹è¯å†å² [{role, content}]
  isChatting: false,      // æ­£åœ¨ç­‰å¾…AIå›å¤

  // å„é¡µå†…å®¹
  pages: {
    location:  { title: 'åŒºä½åˆ†æ',  content: '', keywords: [] },
    site:      { title: 'åŸºåœ°åˆ†æ',  content: '', keywords: [] },
    building:  { title: 'å»ºç­‘åˆ†æ',  content: '', keywords: [] },
    inspo:     { content: '' },
    concept:   { content: '' },
    zones:     { content: '' },
  },

  // ç¬¬äºŒç« 
  genVersions: [], selVersion: null,
};

/* ================================================
   åˆå§‹åŒ–
================================================ */
document.addEventListener('DOMContentLoaded', () => {
  loadSettings();
  render();
  initDragDrop();
});

/* ================================================
   æ‹–æ”¾æ–‡ä»¶æ”¯æŒ
   æ”¯æŒï¼šPDFï¼ˆæå–æ–‡å­—ï¼‰/ å›¾ç‰‡ï¼ˆæˆªå›¾è¯†åˆ«ï¼‰/ TXT
================================================ */
function initDragDrop() {
  // é…ç½® PDF.js workerï¼ˆCDNè·¯å¾„éœ€ä¸ä¸»åº“ç‰ˆæœ¬ä¸€è‡´ï¼‰
  if (window['pdfjs-dist/build/pdf']) {
    window['pdfjs-dist/build/pdf'].GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }

  let dragCounter = 0; // ç”¨è®¡æ•°å™¨é¿å…å­å…ƒç´ è§¦å‘ dragleave æ—¶è¯¯éšè—

  document.addEventListener('dragenter', e => {
    e.preventDefault();
    dragCounter++;
    if (dragCounter === 1) showDropOverlay(e.dataTransfer);
  });

  document.addEventListener('dragover', e => {
    e.preventDefault(); // å¿…é¡»é˜»æ­¢é»˜è®¤è¡Œä¸ºæ‰èƒ½è§¦å‘ drop
  });

  document.addEventListener('dragleave', e => {
    dragCounter--;
    if (dragCounter === 0) hideDropOverlay();
  });

  document.addEventListener('drop', e => {
    e.preventDefault();
    dragCounter = 0;
    hideDropOverlay();
    const file = e.dataTransfer?.files?.[0];
    if (file) handleDroppedFile(file);
  });
}

function showDropOverlay(dataTransfer) {
  // æ ¹æ®æ–‡ä»¶ç±»å‹æ›´æ–°æç¤ºæ–‡å­—
  const overlay = document.getElementById('drop-overlay');
  const sub = document.getElementById('drop-overlay-sub');
  overlay.classList.add('show');

  // å°è¯•è¯»å–æ‹–å…¥æ–‡ä»¶çš„ç±»å‹
  const item = dataTransfer?.items?.[0];
  if (item) {
    if (item.type === 'application/pdf') {
      sub.textContent = 'PDF æ–‡ä»¶ â€” å°†è‡ªåŠ¨æå–æ–‡å­—å†…å®¹';
    } else if (item.type.startsWith('image/')) {
      sub.textContent = 'å›¾ç‰‡æˆªå›¾ â€” å°†é€šè¿‡ AI è¯†åˆ«æ–‡å­—';
    } else {
      sub.textContent = 'æ”¯æŒ PDFã€å›¾ç‰‡æˆªå›¾ã€.txt æ–‡ä»¶';
    }
  }
}
function hideDropOverlay() {
  document.getElementById('drop-overlay').classList.remove('show');
}

/* ç»Ÿä¸€å¤„ç†æ‹–å…¥çš„æ–‡ä»¶ */
async function handleDroppedFile(file) {
  const name = file.name.toLowerCase();
  const type = file.type;

  // è‡ªåŠ¨åˆ‡æ¢åˆ°ç¬¬ä¸€ç«  Tabï¼ˆå¦‚æœå½“å‰ä¸åœ¨ï¼‰
  const ch1Tab = document.querySelector('.tab');
  if (!document.getElementById('panel-ch1').style.display || document.getElementById('panel-ch1').style.display === 'flex') {
    // å·²åœ¨ç¬¬ä¸€ç« ï¼Œæ— éœ€åˆ‡æ¢
  } else {
    ch1Tab.click();
  }

  if (type === 'application/pdf' || name.endsWith('.pdf')) {
    await handleDroppedPDF(file);
  } else if (type.startsWith('image/')) {
    handleDroppedImage(file);
  } else if (type === 'text/plain' || name.endsWith('.txt') || name.endsWith('.md')) {
    handleDroppedText(file);
  } else {
    toast('ä¸æ”¯æŒæ­¤æ ¼å¼ï¼Œè¯·ä½¿ç”¨ PDFã€å›¾ç‰‡æˆ– .txt æ–‡ä»¶');
  }
}

/* ------ æ‹–å…¥ PDFï¼šæå–æ–‡å­—åè‡ªåŠ¨åˆ†æ ------ */
async function handleDroppedPDF(file) {
  const pdfjs = window['pdfjs-dist/build/pdf'];
  if (!pdfjs) {
    // PDF.js æœªåŠ è½½ï¼ˆå¯èƒ½æ— ç½‘ç»œï¼‰ï¼Œæç¤ºç”¨æˆ·
    hideChatEmpty();
    addAiMsg('PDF.js åº“æœªèƒ½åŠ è½½ï¼ˆéœ€è¦è”ç½‘ï¼‰ï¼Œæ— æ³•è‡ªåŠ¨æå–æ–‡å­—ã€‚\n\nè¯·æ‰‹åŠ¨æ“ä½œï¼šæ‰“å¼€ PDF â†’ å…¨é€‰ï¼ˆCtrl+Aï¼‰â†’ å¤åˆ¶ï¼ˆCtrl+Cï¼‰â†’ åˆ‡æ¢ã€Œç²˜è´´æ–‡å­—ã€æ¨¡å¼ â†’ ç²˜è´´ã€‚');
    return;
  }

  hideChatEmpty();
  addUserMsg(`[æ‹–å…¥æ–‡ä»¶] ${file.name}`);
  const typingId = addTypingBubble();

  try {
    // è¯»å–æ–‡ä»¶ä¸º ArrayBuffer
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjs.getDocument({ data: arrayBuffer }).promise;
    const totalPages = pdf.numPages;

    let fullText = '';
    // é€é¡µæå–æ–‡å­—ï¼ˆæœ€å¤šå‰20é¡µï¼Œé¿å…å¤ªé•¿ï¼‰
    const maxPages = Math.min(totalPages, 20);
    for (let i = 1; i <= maxPages; i++) {
      const page = await pdf.getPage(i);
      const textContent = await page.getTextContent();
      const pageText = textContent.items
        .map(item => item.str)
        .join(' ')
        .replace(/\s+/g, ' ')
        .trim();
      if (pageText) fullText += pageText + '\n\n';
    }

    removeTypingBubble(typingId);

    if (fullText.trim().length < 30) {
      // å¯èƒ½æ˜¯æ‰«æç‰ˆPDFï¼ˆå›¾ç‰‡ï¼‰
      addAiMsg(`"${file.name}" æ˜¯æ‰«æç‰ˆ PDFï¼ˆå›¾ç‰‡æ ¼å¼ï¼‰ï¼Œæ— æ³•ç›´æ¥æå–æ–‡å­—ã€‚\n\nè¯·å°† PDF ç”¨æˆªå›¾å·¥å…·æˆªå›¾ï¼Œç„¶åæ‹–å…¥æ­¤åŒºåŸŸï¼ŒAI å°†é€šè¿‡è§†è§‰è¯†åˆ«è¯»å–å†…å®¹ã€‚`);
      return;
    }

    const charCount = fullText.length;
    addAiMsg(`å·²ä» "${file.name}" æå–åˆ° ${charCount} å­—ï¼ˆå…±${totalPages}é¡µï¼Œè¯»å–å‰${maxPages}é¡µï¼‰ã€‚\n\næ­£åœ¨è‡ªåŠ¨å¼€å§‹åˆ†æä¸‰ä¸ªå‰æœŸåˆ†æé¡µé¢â€¦`);

    // è‡ªåŠ¨è§¦å‘åˆ†æ
    await analyzeAllWithText(fullText);

  } catch(e) {
    removeTypingBubble(typingId);
    addAiMsg(`PDF è§£æå‡ºé”™ï¼š${e.message}\n\nè¯·å°è¯•æ‰‹åŠ¨å¤åˆ¶æ–‡å­—ç²˜è´´ï¼Œæˆ–å°† PDF æˆªå›¾åæ‹–å…¥ã€‚`);
  }
}

/* ------ æ‹–å…¥å›¾ç‰‡ï¼šåˆ‡æ¢åˆ°æˆªå›¾æ¨¡å¼å¹¶é¢„å¡« ------ */
function handleDroppedImage(file) {
  const reader = new FileReader();
  reader.onload = e => {
    // åˆ‡æ¢åˆ°æˆªå›¾æ¨¡å¼
    const imgBtn = document.querySelectorAll('.im-btn')[2];
    setInputMode(imgBtn, 'image');

    S.imageData = { base64url: e.target.result, mimeType: file.type };
    document.getElementById('img-zone').style.display = 'none';
    const wrap = document.getElementById('img-preview-wrap');
    wrap.style.display = '';
    document.getElementById('img-preview-src').src = e.target.result;
    toast('æˆªå›¾å·²åŠ è½½ï¼Œç‚¹å‡»ã€ŒAI ä¸€é”®åˆ†æä¸‰é¡µã€å¼€å§‹åˆ†æ');
  };
  reader.readAsDataURL(file);
}

/* ------ æ‹–å…¥æ–‡æœ¬æ–‡ä»¶ ------ */
function handleDroppedText(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result;
    // åˆ‡æ¢åˆ°ç²˜è´´æ–‡å­—æ¨¡å¼
    const textBtn = document.querySelectorAll('.im-btn')[0];
    setInputMode(textBtn, 'text');
    document.getElementById('raw-text').value = text;
    toast(`"${file.name}" å·²åŠ è½½ï¼Œç‚¹å‡»ã€ŒAI ä¸€é”®åˆ†æä¸‰é¡µã€å¼€å§‹åˆ†æ`);
  };
  reader.readAsText(file, 'UTF-8');
}

/* ================================================
   å°†æå–å¥½çš„æ–‡å­—ç›´æ¥é€å…¥åˆ†æï¼ˆæ— éœ€ç”¨æˆ·å†ç‚¹æŒ‰é’®ï¼‰
================================================ */
async function analyzeAllWithText(text) {
  if (!S.apiKey) {
    toast('è¯·å…ˆé…ç½® API Key');
    openSettings();
    return;
  }

  const prompt = `ä½ æ˜¯ä¸“ä¸šæ™¯è§‚è®¾è®¡æ–‡æ¡ˆæ•´ç†å¸ˆï¼Œè¯·åˆ†æä»¥ä¸‹å»ºç­‘/é¡¹ç›®è¯´æ˜æ–‡æœ¬ï¼ŒåŒæ—¶æå–ä¸‰ä¸ªåˆ†æé¡µé¢çš„å†…å®¹ï¼š

1. åŒºä½åˆ†æï¼šåœ°ç†ä½ç½®ã€å‘¨è¾¹ç¯å¢ƒã€äº¤é€šæ¡ä»¶ã€åŒºåŸŸé…å¥—
2. åŸºåœ°åˆ†æï¼šåœºåœ°æ¡ä»¶ã€åœ°å½¢åœ°è²Œã€æ¤è¢«æ°´ä½“ã€ç°çŠ¶ç‰¹ç‚¹
3. å»ºç­‘åˆ†æï¼šå»ºç­‘é£æ ¼ã€ç©ºé—´å¸ƒå±€ã€ç«‹é¢æè´¨ã€ä¸æ™¯è§‚çš„å…³ç³»

æ¯é¡µæä¾›ï¼š
- titleï¼šæ ‡é¢˜ï¼ˆ3-6å­—ï¼‰
- contentï¼šæ­£æ–‡ï¼ˆ150-220å­—ï¼Œä¸“ä¸šç®€æ´ï¼Œå¯ç›´æ¥ç”¨äºæ™¯è§‚è®¾è®¡è¯´æ˜ä¹¦ï¼‰
- keywordsï¼š3-5ä¸ªå…³é”®è¯æ•°ç»„

ä»…è¿”å›JSONï¼š
{
  "location": {"title":"","content":"","keywords":[]},
  "site":     {"title":"","content":"","keywords":[]},
  "building": {"title":"","content":"","keywords":[]}
}

åŸå§‹æ–‡æœ¬å†…å®¹ï¼š
${text.slice(0, 6000)}`; // é™åˆ¶6000å­—é¿å…è¶…token

  const typingId = addTypingBubble();
  setBtnLoading(true);

  try {
    const messages = [{ role: 'user', content: prompt }];
    const raw = await callAI(messages);
    const match = raw.match(/\{[\s\S]*\}/);
    const data = JSON.parse(match ? match[0] : raw);

    removeTypingBubble(typingId);

    // æ›´æ–°çŠ¶æ€
    ['location','site','building'].forEach(key => {
      if (data[key]) {
        S.pages[key].title    = data[key].title    || S.pages[key].title;
        S.pages[key].content  = data[key].content  || '';
        S.pages[key].keywords = data[key].keywords || [];
      }
    });

    addAnalysisResultMsg(data);

    S.chatHistory = [
      { role: 'user', content: prompt },
      { role: 'assistant', content: raw }
    ];

    render();
    toast('åˆ†æå®Œæˆï¼ç‚¹å‡»ã€Œä¸€é”®å…¨éƒ¨åº”ç”¨ã€å¡«å…¥é¢„è§ˆé¡µé¢');

  } catch(e) {
    removeTypingBubble(typingId);
    let errMsg = 'åˆ†æå¤±è´¥ï¼š' + e.message;
    if (e.message === 'Failed to fetch') {
      errMsg = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ã€‚\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæˆ–ç¡®è®¤ API Key æ˜¯å¦æ­£ç¡®ã€‚';
    }
    addAiMsg(errMsg);
    toast('åˆ†æå¤±è´¥');
  } finally {
    setBtnLoading(false);
  }
}

/* ================================================
   è®¾ç½®
================================================ */
function loadSettings() {
  try {
    const d = JSON.parse(localStorage.getItem('ld-tool-cfg') || '{}');
    ['pageW','pageH','pageMargin','apiKey','provider','model','endpoint'].forEach(k => {
      if (d[k] !== undefined) S[k] = d[k];
    });
  } catch(e){}
  syncDots();
}
function saveSettings() {
  S.apiKey   = document.getElementById('s-apikey').value.trim();
  S.provider = document.getElementById('s-provider').value;
  S.model    = document.getElementById('s-model').value;
  S.endpoint = document.getElementById('s-endpoint').value.trim();
  S.pageW    = +document.getElementById('s-pw').value;
  S.pageH    = +document.getElementById('s-ph').value;
  S.pageMargin = +document.getElementById('s-pm').value;
  localStorage.setItem('ld-tool-cfg', JSON.stringify({
    apiKey:S.apiKey, provider:S.provider, model:S.model,
    endpoint:S.endpoint, pageW:S.pageW, pageH:S.pageH, pageMargin:S.pageMargin
  }));
  syncDots(); closeSettings(); render(); toast('è®¾ç½®å·²ä¿å­˜');
}
function openSettings() {
  document.getElementById('s-apikey').value   = S.apiKey;
  document.getElementById('s-provider').value = S.provider;
  document.getElementById('s-model').value    = S.model;
  document.getElementById('s-endpoint').value = S.endpoint || '';
  document.getElementById('s-pw').value  = S.pageW;
  document.getElementById('s-ph').value  = S.pageH;
  document.getElementById('s-pm').value  = S.pageMargin;
  updateModelList();
  document.getElementById('modal-settings').classList.add('show');
}
function closeSettings() { document.getElementById('modal-settings').classList.remove('show'); }
function updateModelList() {
  const p = document.getElementById('s-provider').value;
  const m = document.getElementById('s-model');
  document.getElementById('s-doubao-row').style.display = p==='doubao' ? '' : 'none';
  if (p==='deepseek') {
    m.innerHTML = '<option value="deepseek-chat">deepseek-chatï¼ˆæ¨èï¼‰</option><option value="deepseek-reasoner">deepseek-reasonerï¼ˆæ›´å¼ºï¼Œæ›´æ…¢ï¼‰</option>';
  } else if (p==='doubao') {
    m.innerHTML = '<option value="doubao-pro-32k">Doubao-pro-32k</option><option value="doubao-lite-32k">Doubao-lite-32k</option>';
  } else {
    m.innerHTML = '<option value="gpt-4o">gpt-4o</option><option value="gpt-4o-mini">gpt-4o-mini</option>';
  }
}
function syncDots() {
  const on = !!S.apiKey;
  ['1','2'].forEach(n => {
    const dot = document.getElementById('dot'+n);
    const txt = document.getElementById('dot'+n+'-text');
    if(dot) dot.className = 'status-dot' + (on?' on':'');
    if(txt) txt.textContent = on ? `å·²è¿æ¥ ${S.provider}` : 'æœªé…ç½® API Key';
  });
}

/* ================================================
   Tab åˆ‡æ¢
================================================ */
function switchTab(tab, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('panel-ch1').style.display = tab==='ch1' ? 'flex' : 'none';
  document.getElementById('panel-ch2').style.display = tab==='ch2' ? '' : 'none';
}

/* ================================================
   è¾“å…¥æ¨¡å¼åˆ‡æ¢
================================================ */
function setInputMode(el, mode) {
  document.querySelectorAll('.im-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  S.inputMode = mode;
  document.getElementById('mode-text').style.display  = mode==='text'  ? '' : 'none';
  document.getElementById('mode-file').style.display  = mode==='file'  ? '' : 'none';
  document.getElementById('mode-image').style.display = mode==='image' ? '' : 'none';
}

/* ------ æ–‡ä»¶ä¸Šä¼ ï¼ˆ.txt / .mdï¼Œæ‹¦æˆª PDFï¼‰ ------ */
function handleFileUpload(input) {
  const file = input.files[0];
  if (!file) return;

  // å…ˆè¯»å–å‰å‡ ä¸ªå­—èŠ‚ï¼Œæ£€æµ‹æ˜¯å¦æ˜¯ PDF
  const sniffReader = new FileReader();
  sniffReader.onload = e => {
    const head = e.target.result;
    const isPDF = head.startsWith('%PDF') || file.name.toLowerCase().endsWith('.pdf');
    document.getElementById('file-pdf-error').style.display = isPDF ? '' : 'none';

    if (isPDF) {
      // æç¤ºç”¨æˆ·åˆ‡æ¢åˆ°ç²˜è´´æ¨¡å¼
      input.value = '';
      return;
    }

    // æ­£å¸¸è¯»å–æ–‡æœ¬
    const textReader = new FileReader();
    textReader.onload = ev => {
      S.fileText = ev.target.result;
      document.getElementById('file-zone').style.display = 'none';
      document.getElementById('file-loaded').style.display = 'flex';
      document.getElementById('file-name').textContent = file.name;
      document.getElementById('file-pdf-error').style.display = 'none';
    };
    textReader.readAsText(file, 'UTF-8');
  };
  // åªè¯»å‰ 8 å­—èŠ‚ç”¨äºå—…æ¢æ–‡ä»¶ç±»å‹
  sniffReader.readAsText(file.slice(0, 8));
  input.value = '';
}
function clearFile() {
  S.fileText = null;
  document.getElementById('file-zone').style.display = '';
  document.getElementById('file-loaded').style.display = 'none';
}

/* ------ æˆªå›¾ä¸Šä¼  ------ */
function handleImageUpload(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    S.imageData = { base64url: e.target.result, mimeType: file.type };
    document.getElementById('img-zone').style.display = 'none';
    const wrap = document.getElementById('img-preview-wrap');
    wrap.style.display = '';
    document.getElementById('img-preview-src').src = e.target.result;
  };
  reader.readAsDataURL(file);
  input.value = '';
}
function clearImage() {
  S.imageData = null;
  document.getElementById('img-zone').style.display = '';
  document.getElementById('img-preview-wrap').style.display = 'none';
}

/* ================================================
   è·å–å½“å‰è¾“å…¥å†…å®¹ï¼ˆæ–‡å­— or æ–‡ä»¶ or æˆªå›¾ï¼‰
   è¿”å› { text, imageUrl }
================================================ */
function getInput() {
  if (S.inputMode === 'text') {
    const t = document.getElementById('raw-text').value.trim();
    return { text: t, imageUrl: null };
  } else if (S.inputMode === 'file') {
    return { text: S.fileText || '', imageUrl: null };
  } else {
    // image mode
    return { text: '', imageUrl: S.imageData?.base64url || null };
  }
}

/* ================================================
   ç¬¬ä¸€ç« ï¼šAI ä¸€é”®åˆ†æä¸‰é¡µ
================================================ */
async function analyzeAll() {
  if (!S.apiKey) { toast('è¯·å…ˆé…ç½® API Key'); openSettings(); return; }

  const { text, imageUrl } = getInput();
  if (!text && !imageUrl) {
    toast(S.inputMode==='image' ? 'è¯·å…ˆä¸Šä¼ æˆªå›¾' : 'è¯·å…ˆæä¾›åŸå§‹æ–‡æœ¬å†…å®¹');
    return;
  }

  const prompt = `ä½ æ˜¯ä¸“ä¸šæ™¯è§‚è®¾è®¡æ–‡æ¡ˆæ•´ç†å¸ˆï¼Œè¯·åˆ†æä»¥ä¸‹å»ºç­‘/é¡¹ç›®è¯´æ˜æ–‡æœ¬ï¼ŒåŒæ—¶æå–ä¸‰ä¸ªåˆ†æé¡µé¢çš„å†…å®¹ï¼š

1. åŒºä½åˆ†æï¼šåœ°ç†ä½ç½®ã€å‘¨è¾¹ç¯å¢ƒã€äº¤é€šæ¡ä»¶ã€åŒºåŸŸé…å¥—
2. åŸºåœ°åˆ†æï¼šåœºåœ°æ¡ä»¶ã€åœ°å½¢åœ°è²Œã€æ¤è¢«æ°´ä½“ã€ç°çŠ¶ç‰¹ç‚¹
3. å»ºç­‘åˆ†æï¼šå»ºç­‘é£æ ¼ã€ç©ºé—´å¸ƒå±€ã€ç«‹é¢æè´¨ã€ä¸æ™¯è§‚çš„å…³ç³»

æ¯é¡µæä¾›ï¼š
- titleï¼šæ ‡é¢˜ï¼ˆ3-6å­—ï¼‰
- contentï¼šæ­£æ–‡ï¼ˆ150-220å­—ï¼Œä¸“ä¸šç®€æ´ï¼Œå¯ç›´æ¥ç”¨äºæ™¯è§‚è®¾è®¡è¯´æ˜ä¹¦ï¼‰
- keywordsï¼š3-5ä¸ªå…³é”®è¯æ•°ç»„

ä»…è¿”å›JSONï¼Œæ ¼å¼ï¼š
{
  "location": {"title":"","content":"","keywords":[]},
  "site":     {"title":"","content":"","keywords":[]},
  "building": {"title":"","content":"","keywords":[]}
}

åŸå§‹æ–‡æœ¬å†…å®¹ï¼š
${text || '[å›¾ç‰‡å†…å®¹ï¼Œè¯·è¯†åˆ«å¹¶åˆ†æ]'}`;

  // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆæ–‡æœ¬æˆ–å›¾ç‰‡ï¼‰
  hideChatEmpty();
  if (imageUrl) {
    addUserMsg('[æˆªå›¾] è¯·åˆ†æè¿™å¼ å›¾ç‰‡å¹¶æå–ä¸‰ä¸ªåˆ†æé¡µé¢çš„å†…å®¹');
  } else {
    addUserMsg('è¯·åˆ†æä»¥ä¸‹å†…å®¹å¹¶åŒæ—¶å¡«å†™ä¸‰ä¸ªå‰æœŸåˆ†æé¡µé¢ï¼š\n\n' + text.slice(0, 100) + (text.length > 100 ? 'â€¦' : ''));
  }

  // æ˜¾ç¤ºç­‰å¾…æ°”æ³¡
  const typingId = addTypingBubble();
  setBtnLoading(true);

  try {
    // æ„å»ºæ¶ˆæ¯ï¼ˆæ”¯æŒå›¾ç‰‡ï¼‰
    let messages;
    if (imageUrl) {
      messages = [{
        role: 'user',
        content: [
          { type: 'image_url', image_url: { url: imageUrl } },
          { type: 'text', text: prompt }
        ]
      }];
    } else {
      messages = [{ role: 'user', content: prompt }];
    }

    const raw = await callAI(messages);
    let data;
    try {
      // æå–JSONï¼ˆé˜²æ­¢AIåœ¨JSONå¤–åŠ äº†æ–‡å­—ï¼‰
      const match = raw.match(/\{[\s\S]*\}/);
      data = JSON.parse(match ? match[0] : raw);
    } catch(e) {
      throw new Error('AI è¿”å›æ ¼å¼å¼‚å¸¸ï¼Œè¯·é‡è¯•');
    }

    removeTypingBubble(typingId);

    // æ›´æ–°çŠ¶æ€
    ['location','site','building'].forEach(key => {
      if (data[key]) {
        S.pages[key].title    = data[key].title    || S.pages[key].title;
        S.pages[key].content  = data[key].content  || '';
        S.pages[key].keywords = data[key].keywords || [];
      }
    });

    // æ¸²æŸ“ç»“æœå¡ç‰‡
    addAnalysisResultMsg(data);

    // æ›´æ–°å¯¹è¯å†å²ï¼ˆç”¨æ–‡å­—æ‘˜è¦ï¼Œä¸å¸¦å›¾ç‰‡ï¼‰
    S.chatHistory = [
      { role: 'user', content: imageUrl ? '[ç”¨æˆ·ä¸Šä¼ äº†æˆªå›¾]' : prompt },
      { role: 'assistant', content: raw }
    ];

    render();
    toast('ä¸‰é¡µå†…å®¹å·²åŒæ—¶åˆ†æå®Œæˆï¼Œå¯ç»§ç»­å¯¹è¯ä¿®æ”¹ï¼');

  } catch(e) {
    removeTypingBubble(typingId);
    let errMsg = 'åˆ†æå¤±è´¥ï¼š' + e.message;
    if (e.message === 'Failed to fetch') {
      errMsg = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼ˆFailed to fetchï¼‰\n\nå¯èƒ½åŸå› ï¼š\nâ‘  ç½‘ç»œé—®é¢˜ï¼Œè¯·æ£€æŸ¥æ˜¯å¦èƒ½æ­£å¸¸è®¿é—®äº’è”ç½‘\nâ‘¡ API Key å¡«å†™æœ‰è¯¯ï¼Œè¯·ç‚¹å³ä¸Šè§’ã€Œè®¾ç½®ã€é‡æ–°ç¡®è®¤\nâ‘¢ éƒ¨åˆ†ä¼ä¸š/å­¦æ ¡ç½‘ç»œä¼šå±è”½ AI æ¥å£ï¼Œå¯å°è¯•ç”¨æ‰‹æœºçƒ­ç‚¹';
    } else if (e.message.includes('401') || e.message.includes('Unauthorized')) {
      errMsg = 'API Key æ— æ•ˆï¼ˆ401é”™è¯¯ï¼‰\n\nè¯·ç‚¹å³ä¸Šè§’ã€Œè®¾ç½®ã€é‡æ–°å¡«å†™æ­£ç¡®çš„ API Keyã€‚';
    } else if (e.message.includes('429')) {
      errMsg = 'è¯·æ±‚é¢‘ç‡è¶…é™ï¼ˆ429é”™è¯¯ï¼‰\n\nè¯·ç­‰å¾…å‡ ç§’åå†è¯•ã€‚';
    }
    addAiMsg(errMsg);
    toast('åˆ†æå¤±è´¥ï¼Œè¯·æŸ¥çœ‹å¯¹è¯æ¡†ä¸­çš„é”™è¯¯è¯´æ˜');
  } finally {
    setBtnLoading(false);
  }
}

/* ================================================
   ç¬¬ä¸€ç« ï¼šç»§ç»­å¯¹è¯
================================================ */
async function sendChat() {
  if (S.isChatting) return;
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  if (!S.apiKey) { toast('è¯·å…ˆé…ç½® API Key'); openSettings(); return; }
  if (S.chatHistory.length === 0) {
    toast('è¯·å…ˆç‚¹å‡»"AIä¸€é”®åˆ†æä¸‰é¡µ"å¼€å§‹åˆ†æ');
    return;
  }

  input.value = '';
  input.style.height = 'auto';

  hideChatEmpty();
  addUserMsg(msg);
  const typingId = addTypingBubble();
  S.isChatting = true;
  document.getElementById('send-btn').disabled = true;

  // æ„å»ºå¯¹è¯å†å²ï¼ˆåªç”¨æ–‡å­—ï¼Œä¸å«å›¾ç‰‡ï¼‰
  const messages = [
    // ç³»ç»ŸæŒ‡ä»¤ï¼ˆä»¥useræ¶ˆæ¯å½¢å¼åµŒå…¥ï¼Œå› éƒ¨åˆ†APIä¸æ”¯æŒsystem roleï¼‰
    ...S.chatHistory,
    {
      role: 'user',
      content: msg + '\n\nï¼ˆå¦‚æœä½ ä¿®æ”¹äº†æŸä¸ªåˆ†æé¡µé¢çš„å†…å®¹ï¼Œè¯·åœ¨å›å¤æœ«å°¾ç”¨å¦‚ä¸‹æ ¼å¼é™„ä¸Šæ›´æ–°åçš„å®Œæ•´å†…å®¹ï¼Œæ–¹ä¾¿æˆ‘åº”ç”¨ï¼š\n[æ›´æ–°å†…å®¹]\nåŒºä½åˆ†æï¼šxxx\nåŸºåœ°åˆ†æï¼šxxx\nå»ºç­‘åˆ†æï¼šxxxï¼‰'
    }
  ];

  try {
    const raw = await callAI(messages);
    removeTypingBubble(typingId);

    // æ›´æ–°å¯¹è¯å†å²
    S.chatHistory.push({ role: 'user', content: msg });
    S.chatHistory.push({ role: 'assistant', content: raw });

    // å°è¯•ä»å›å¤ä¸­è§£ææ›´æ–°å†…å®¹
    const updated = parseUpdatesFromReply(raw);

    addFollowupMsg(raw, updated);

    if (Object.keys(updated).length > 0) {
      // è‡ªåŠ¨åº”ç”¨è§£æåˆ°çš„æ›´æ–°
      Object.keys(updated).forEach(key => {
        if (S.pages[key] !== undefined) {
          S.pages[key].content = updated[key];
        }
      });
      render();
    }

  } catch(e) {
    removeTypingBubble(typingId);
    addAiMsg('å›å¤å¤±è´¥ï¼š' + e.message);
  } finally {
    S.isChatting = false;
    document.getElementById('send-btn').disabled = false;
  }
}

/* è§£æAIå›å¤ä¸­çš„æ›´æ–°å†…å®¹æ ‡è®° */
function parseUpdatesFromReply(text) {
  const result = {};
  const map = { 'åŒºä½åˆ†æ': 'location', 'åŸºåœ°åˆ†æ': 'site', 'å»ºç­‘åˆ†æ': 'building' };
  Object.keys(map).forEach(label => {
    // åŒ¹é… "åŒºä½åˆ†æï¼šxxx" æˆ– "åŒºä½åˆ†æ:\nxxx"
    const regex = new RegExp(label + '[ï¼š:][\\s]*(.*?)(?=åŒºä½åˆ†æ|åŸºåœ°åˆ†æ|å»ºç­‘åˆ†æ|$)', 's');
    const m = text.match(regex);
    if (m && m[1] && m[1].trim().length > 30) {
      result[map[label]] = m[1].trim();
    }
  });
  return result;
}

/* Enterå‘é€ */
function handleChatKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendChat();
  }
  // è‡ªåŠ¨é«˜åº¦
  const ta = e.target;
  ta.style.height = 'auto';
  ta.style.height = Math.min(ta.scrollHeight, 72) + 'px';
}

/* ================================================
   èŠå¤©UIæ“ä½œ
================================================ */
function hideChatEmpty() {
  const el = document.getElementById('chat-empty');
  if (el) el.style.display = 'none';
}

function addUserMsg(text) {
  const area = document.getElementById('chat-area');
  const div = document.createElement('div');
  div.className = 'chat-msg user-msg';
  div.innerHTML = `
    <div class="msg-avatar user">æˆ‘</div>
    <div class="msg-body">
      <div class="msg-bubble user-bubble" style="white-space:pre-wrap;">${escHtml(text)}</div>
    </div>`;
  area.appendChild(div);
  scrollChatBottom();
}

function addAiMsg(text) {
  const area = document.getElementById('chat-area');
  const div = document.createElement('div');
  div.className = 'chat-msg';
  div.innerHTML = `
    <div class="msg-avatar ai">AI</div>
    <div class="msg-body">
      <div class="msg-bubble ai-bubble" style="white-space:pre-wrap;">${escHtml(text)}</div>
    </div>`;
  area.appendChild(div);
  scrollChatBottom();
}

/* æ¸²æŸ“åˆå§‹åˆ†æç»“æœï¼ˆä¸‰ä¸ªç»“æ„åŒ–å¡ç‰‡ + ä¸€é”®å…¨éƒ¨åº”ç”¨ï¼‰ */
function addAnalysisResultMsg(data) {
  const area = document.getElementById('chat-area');
  const secs = [
    { key:'location', label:'åŒºä½åˆ†æ', color:'#0071e3' },
    { key:'site',     label:'åŸºåœ°åˆ†æ', color:'#34c759' },
    { key:'building', label:'å»ºç­‘åˆ†æ', color:'#ff9500' },
  ];

  // ç»™æœ¬æ¬¡æ¶ˆæ¯ä¸€ä¸ªå”¯ä¸€idï¼Œä¾›æŒ‰é’®ä½¿ç”¨
  const msgId = 'result-' + Date.now();

  let cardsHtml = secs.map(sec => {
    const d = data[sec.key];
    if (!d) return '';
    const kws = (d.keywords||[]).map(k=>`<span class="kw-tag">${escHtml(k)}</span>`).join('');
    return `
    <div class="sec-card">
      <div class="sec-card-head">
        <div class="sec-card-label">
          <div class="sec-card-dot" style="background:${sec.color};"></div>
          ${sec.label}
        </div>
        <button class="apply-btn-sm" id="apply-${msgId}-${sec.key}"
          onclick="applyOneSection('${sec.key}','${msgId}')">åº”ç”¨åˆ°é¢„è§ˆ</button>
      </div>
      <div class="sec-card-body">
        <div class="sec-card-title">${escHtml(d.title||sec.label)}</div>
        <div class="sec-card-text">${escHtml(d.content||'')}</div>
        ${kws ? `<div class="sec-card-kws">${kws}</div>` : ''}
      </div>
    </div>`;
  }).join('');

  const div = document.createElement('div');
  div.className = 'chat-msg';
  div.id = msgId;
  div.dataset.result = JSON.stringify(data); // å­˜å‚¨æ•°æ®ä¾›æŒ‰é’®é‡æ–°åº”ç”¨
  div.innerHTML = `
    <div class="msg-avatar ai">AI</div>
    <div class="msg-body" style="width:100%;">
      <div class="msg-bubble ai-bubble" style="margin-bottom:8px;">
        ä¸‰é¡µå†…å®¹å·²åˆ†æå®Œæˆï¼<br>
        <span style="color:var(--text-secondary);font-size:11px;">æŸ¥çœ‹ä¸‹æ–¹å†…å®¹ï¼Œæ»¡æ„åç‚¹æŒ‰é’®åº”ç”¨åˆ°å³ä¾§é¢„è§ˆ</span>
      </div>
      ${cardsHtml}
      <!-- ä¸€é”®å…¨éƒ¨åº”ç”¨ï¼ˆæœ€æ˜¾çœ¼çš„æ“ä½œï¼‰ -->
      <button id="apply-all-${msgId}" onclick="applyAllSections('${msgId}')"
        style="width:100%;margin-top:8px;padding:10px;border-radius:9px;
          background:#1d1d1f;color:white;border:none;font-size:13px;font-weight:600;
          cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:6px;
          transition:background 0.15s;">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        ä¸€é”®å°†ä¸‰é¡µå†…å®¹å…¨éƒ¨åº”ç”¨åˆ°é¢„è§ˆ
      </button>
    </div>`;
  area.appendChild(div);
  scrollChatBottom();
}

/* æ¸²æŸ“è·Ÿè¿›å›å¤ï¼ˆçº¯æ–‡å­— + åº”ç”¨æŒ‰é’®ï¼‰ */
function addFollowupMsg(text, updatedSections) {
  const area = document.getElementById('chat-area');
  // æ¸…ç†textä¸­çš„[æ›´æ–°å†…å®¹]æ ‡è®°éƒ¨åˆ†ï¼Œåªæ˜¾ç¤ºæ­£æ–‡
  const displayText = text.replace(/\[æ›´æ–°å†…å®¹\][\s\S]*/,'').trim();

  const secMap = [
    { key:'location', label:'åŒºä½åˆ†æ' },
    { key:'site',     label:'åŸºåœ°åˆ†æ' },
    { key:'building', label:'å»ºç­‘åˆ†æ' },
  ];

  // å¦‚æœè‡ªåŠ¨è§£æåˆ°äº†æ›´æ–°ï¼Œæ˜¾ç¤ºå·²åº”ç”¨æç¤º
  const hasUpdates = Object.keys(updatedSections).length > 0;
  const updateHint = hasUpdates
    ? `<div style="font-size:11px;color:#34c759;padding:5px 12px;display:flex;align-items:center;gap:4px;">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        å·²è‡ªåŠ¨æ›´æ–°ï¼š${Object.keys(updatedSections).map(k=>secMap.find(s=>s.key===k)?.label).filter(Boolean).join('ã€')}
       </div>`
    : '';

  // æ‰‹åŠ¨åº”ç”¨æŒ‰é’®è¡Œ
  const applyButtons = secMap.map(s =>
    `<button class="apply-to-btn" onclick="applyFollowupToSection('${s.key}', \`${escHtml(displayText)}\`, this)">${s.label}</button>`
  ).join('');

  const msgFollowId = 'followup-' + Date.now();
  const div = document.createElement('div');
  div.className = 'chat-msg';
  div.id = msgFollowId;
  div.dataset.followText = displayText; // å­˜å‚¨æ–‡æœ¬ï¼Œä¾›ä¸€é”®åº”ç”¨æŒ‰é’®é‡å¤ç‚¹å‡»ä½¿ç”¨
  div.innerHTML = `
    <div class="msg-avatar ai">AI</div>
    <div class="msg-body" style="max-width:calc(100% - 36px);">
      <div class="msg-bubble ai-bubble" style="white-space:pre-wrap;">${escHtml(displayText)}</div>
      ${updateHint}
      <div class="apply-row">
        <span class="apply-row-label">åº”ç”¨åˆ°ï¼š</span>
        ${applyButtons}
      </div>
      <!-- ä¸€é”®åº”ç”¨å…¨éƒ¨ï¼Œå¯åå¤ç‚¹å‡»æ›¿æ¢ -->
      <button onclick="applyFollowupAll('${msgFollowId}', this)"
        style="width:100%;margin-top:6px;padding:9px;border-radius:9px;
          background:#1d1d1f;color:white;border:none;font-size:13px;font-weight:600;
          cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:6px;
          transition:background 0.15s;">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        ä¸€é”®åº”ç”¨åˆ°å…¨éƒ¨ä¸‰é¡µ
      </button>
    </div>`;
  area.appendChild(div);
  scrollChatBottom();
}

/* åº”ç”¨æŸä¸ªç»“æ„åŒ–å¡ç‰‡åˆ°å¯¹åº”é¡µé¢ï¼ˆä»æ¶ˆæ¯çš„ dataset ä¸­è¯»å–æ•°æ®ï¼‰ */
function applyOneSection(key, msgId) {
  const msgEl = document.getElementById(msgId);
  if (msgEl && msgEl.dataset.result) {
    const data = JSON.parse(msgEl.dataset.result);
    if (data[key]) {
      S.pages[key].title    = data[key].title    || S.pages[key].title;
      S.pages[key].content  = data[key].content  || '';
      S.pages[key].keywords = data[key].keywords || [];
    }
  }
  render();
  const btn = document.getElementById(`apply-${msgId}-${key}`);
  if (btn) { btn.textContent = 'âœ“ å·²åº”ç”¨'; btn.classList.add('applied'); }
  const labels = { location:'åŒºä½', site:'åŸºåœ°', building:'å»ºç­‘' };
  toast(`${labels[key]||''}åˆ†æå·²åº”ç”¨åˆ°é¢„è§ˆ`);
}

/* ä¸€é”®å°†ä¸‰é¡µå†…å®¹å…¨éƒ¨åº”ç”¨ */
function applyAllSections(msgId) {
  const msgEl = document.getElementById(msgId);
  if (!msgEl || !msgEl.dataset.result) { toast('æ•°æ®è¯»å–å¤±è´¥ï¼Œè¯·é‡æ–°åˆ†æ'); return; }
  const data = JSON.parse(msgEl.dataset.result);
  ['location','site','building'].forEach(key => {
    if (data[key]) {
      S.pages[key].title    = data[key].title    || S.pages[key].title;
      S.pages[key].content  = data[key].content  || '';
      S.pages[key].keywords = data[key].keywords || [];
    }
    const btn = document.getElementById(`apply-${msgId}-${key}`);
    if (btn) { btn.textContent = 'âœ“ å·²åº”ç”¨'; btn.classList.add('applied'); }
  });
  render();
  // çŸ­æš‚ç»¿è‰²åé¦ˆåæ¢å¤ï¼Œä¿æŒå¯å†æ¬¡ç‚¹å‡»
  const allBtn = document.getElementById(`apply-all-${msgId}`);
  if (allBtn) {
    const origHtml = allBtn.innerHTML;
    allBtn.style.background = '#34c759';
    allBtn.innerHTML = `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> âœ“ å·²åº”ç”¨ï¼Œå¯å†æ¬¡ç‚¹å‡»æ›¿æ¢`;
    setTimeout(() => {
      allBtn.style.background = '#1d1d1f';
      allBtn.innerHTML = origHtml;
    }, 2000);
  }
  toast('ä¸‰é¡µå†…å®¹å·²å…¨éƒ¨åº”ç”¨åˆ°å³ä¾§é¢„è§ˆï¼');
}

/* ä¸€é”®å°†è·Ÿè¿›å›å¤åº”ç”¨åˆ°å…¨éƒ¨ä¸‰é¡µï¼ˆå¯åå¤ç‚¹å‡»æ›¿æ¢ï¼‰ */
function applyFollowupAll(msgId, btn) {
  const msgEl = document.getElementById(msgId);
  if (!msgEl) return;
  const text = msgEl.dataset.followText || '';
  if (!text) { toast('æ²¡æœ‰å¯åº”ç”¨çš„å†…å®¹'); return; }
  ['location','site','building'].forEach(key => {
    S.pages[key].content = text;
  });
  render();
  // çŸ­æš‚ç»¿è‰²åé¦ˆåæ¢å¤åŸæ ·ï¼Œè®©ç”¨æˆ·çŸ¥é“å¯ä»¥å†æ¬¡ç‚¹å‡»
  const orig = btn.innerHTML;
  btn.style.background = '#34c759';
  btn.innerHTML = `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> âœ“ å·²åº”ç”¨ï¼Œå¯å†æ¬¡ç‚¹å‡»æ›¿æ¢`;
  setTimeout(() => {
    btn.style.background = '#1d1d1f';
    btn.innerHTML = orig;
  }, 2000);
  toast('å†…å®¹å·²åº”ç”¨åˆ°å…¨éƒ¨ä¸‰é¡µï¼Œå¯ç»§ç»­ä¿®æ”¹åå†æ¬¡ç‚¹å‡»æ›¿æ¢');
}

/* å°†è·Ÿè¿›å›å¤çš„å†…å®¹åº”ç”¨åˆ°æŒ‡å®šé¡µé¢ */
function applyFollowupToSection(key, text, btn) {
  const clean = text.replace(/\[æ›´æ–°å†…å®¹\][\s\S]*/,'').trim();
  S.pages[key].content = clean;
  render();
  btn.textContent = 'âœ“ å·²åº”ç”¨';
  btn.style.borderColor = '#34c759';
  btn.style.color = '#34c759';
  toast('å†…å®¹å·²åº”ç”¨');
}

/* ç­‰å¾…æ°”æ³¡ */
function addTypingBubble() {
  const id = 'typing-' + Date.now();
  const area = document.getElementById('chat-area');
  const div = document.createElement('div');
  div.className = 'chat-msg'; div.id = id;
  div.innerHTML = `
    <div class="msg-avatar ai">AI</div>
    <div class="msg-body">
      <div class="typing-bubble">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>`;
  area.appendChild(div);
  scrollChatBottom();
  return id;
}
function removeTypingBubble(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

function scrollChatBottom() {
  const area = document.getElementById('chat-area');
  setTimeout(() => { area.scrollTop = area.scrollHeight; }, 50);
}

function setBtnLoading(loading) {
  const btn = document.getElementById('analyze-btn');
  btn.disabled = loading;
  btn.innerHTML = loading
    ? `<div class="spinner"></div> AI æ­£åœ¨åˆ†æä¸­â€¦`
    : `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> AI ä¸€é”®åˆ†æå‰æœŸåˆ†æä¸‰é¡µ`;
}

function escHtml(str) {
  return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ================================================
   ç¬¬äºŒç« ï¼šè®¾è®¡æ„æ€
================================================ */
async function generateConcepts() {
  if (!S.apiKey) { toast('è¯·å…ˆé…ç½® API Key'); openSettings(); return; }
  const name  = document.getElementById('proj-name').value.trim();
  const loc   = document.getElementById('proj-loc').value.trim();
  const type  = document.getElementById('proj-type').value;
  const kw    = document.getElementById('proj-kw').value.trim();
  const extra = document.getElementById('proj-extra').value.trim();
  if (!name || !loc) { toast('è¯·å¡«å†™é¡¹ç›®åç§°å’Œåœ°ç‚¹'); return; }

  const prompt = `ä½ æ˜¯èµ„æ·±æ™¯è§‚è®¾è®¡å¸ˆã€‚ä¸ºä»¥ä¸‹é¡¹ç›®ç”Ÿæˆ3ä¸ªé£æ ¼å„å¼‚çš„è®¾è®¡æ„æ€æ–¹æ¡ˆï¼Œæ·±å…¥æŒ–æ˜è¯¥åœ°ç‚¹çš„åœ°ç†ç¯å¢ƒã€å†å²æ–‡åŒ–ã€æ°”å€™ç‰¹ç‚¹ã€‚

é¡¹ç›®ä¿¡æ¯ï¼šåç§°:${name} | åœ°ç‚¹:${loc} | ç±»å‹:${type} | é£æ ¼:${kw||'æœªæŒ‡å®š'} | è¡¥å……:${extra||'æ— '}

æ¯ä¸ªæ–¹æ¡ˆåŒ…å«ï¼š
1. nameï¼šæ–¹æ¡ˆåç§°ï¼ˆ4-8å­—ï¼Œå¯Œæœ‰è¯—æ„ï¼‰
2. taglineï¼šä¸€å¥è¯ç®€ä»‹ï¼ˆ15å­—ä»¥å†…ï¼‰
3. inspirationï¼šçµæ„Ÿæ¥æºï¼ˆ100-150å­—ï¼Œæ–‡åŒ–/è‡ªç„¶èƒŒæ™¯ï¼‰
4. conceptï¼šè®¾è®¡ç†å¿µï¼ˆ150-200å­—ï¼Œæ ¸å¿ƒé€»è¾‘å’Œæ‰‹æ³•ï¼‰
5. zonesï¼šä¸»é¢˜åˆ†åŒºï¼ˆ3-5ä¸ªï¼Œæ ¼å¼"åˆ†åŒºåï¼šä¸»é¢˜æè¿°"ï¼Œæ¢è¡Œåˆ†éš”ï¼‰

ä»…è¿”å›JSONï¼š{"versions":[{"name":"","tagline":"","inspiration":"","concept":"","zones":""},{"name":"","tagline":"","inspiration":"","concept":"","zones":""},{"name":"","tagline":"","inspiration":"","concept":"","zones":""}]}`;

  const btn = document.getElementById('gen-btn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner" style="border-color:rgba(255,255,255,.4);border-top-color:white;"></div> AI æ„æ€ä¸­â€¦';

  try {
    const raw = await callAI([{ role:'user', content:prompt }], true);
    const m = raw.match(/\{[\s\S]*\}/);
    const d = JSON.parse(m ? m[0] : raw);
    S.genVersions = d.versions || [];
    renderVersionCards();
    goStep(2);
    toast('ä¸‰ä¸ªç‰ˆæœ¬å·²ç”Ÿæˆï¼Œè¯·é€‰æ‹©ï¼');
  } catch(e) {
    toast('ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> ç”Ÿæˆä¸‰ä¸ªè®¾è®¡æ„æ€ç‰ˆæœ¬';
  }
}

function renderVersionCards() {
  const tags = ['æ–¹æ¡ˆ A','æ–¹æ¡ˆ B','æ–¹æ¡ˆ C'];
  document.getElementById('version-list').innerHTML = S.genVersions.map((v,i) => `
    <div class="version-card" onclick="pickVersion(this,${i})">
      <div class="version-tag">${tags[i]||'æ–¹æ¡ˆ'+(i+1)}</div>
      <div class="version-name">${v.name}</div>
      <div class="version-tagline">${v.tagline}</div>
    </div>
  `).join('');
  S.selVersion = null;
}
function pickVersion(el, i) {
  document.querySelectorAll('.version-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected'); S.selVersion = i;
}
function confirmVersion() {
  if (S.selVersion === null) { toast('è¯·å…ˆç‚¹å‡»é€‰æ‹©ä¸€ä¸ªç‰ˆæœ¬'); return; }
  const v = S.genVersions[S.selVersion];
  document.getElementById('inspo').value   = v.inspiration || '';
  document.getElementById('concept').value = v.concept     || '';
  document.getElementById('zones').value   = v.zones       || '';
  goStep(3);
}
function backToStep1() { goStep(1); }
function backToStep2() { goStep(2); }
function goStep(n) {
  document.getElementById('ch2-s1').style.display = n===1 ? '' : 'none';
  document.getElementById('ch2-s2').style.display = n===2 ? '' : 'none';
  document.getElementById('ch2-s3').style.display = n===3 ? '' : 'none';
  [1,2,3].forEach(i => {
    document.getElementById('s'+i).className = 'step-item'+(i<n?' done':i===n?' active':'');
  });
}
function applyToPage(chapter) {
  S.pages.inspo.content   = document.getElementById('inspo').value;
  S.pages.concept.content = document.getElementById('concept').value;
  S.pages.zones.content   = document.getElementById('zones').value;
  render(); toast('å·²åº”ç”¨åˆ°é¢„è§ˆé¡µé¢');
}

/* ================================================
   AI API è°ƒç”¨
================================================ */
async function callAI(messages, jsonMode = true) {
  let url, headers, body;

  if (S.provider === 'deepseek') {
    url = 'https://api.deepseek.com/chat/completions';
    headers = { 'Content-Type':'application/json', 'Authorization':'Bearer '+S.apiKey };
    body = { model: S.model, messages, ...(jsonMode ? { response_format:{type:'json_object'} } : {}) };
  } else if (S.provider === 'doubao') {
    url = 'https://ark.cn-beijing.volces.com/api/v3/chat/completions';
    headers = { 'Content-Type':'application/json', 'Authorization':'Bearer '+S.apiKey };
    body = { model: S.endpoint || S.model, messages };
  } else {
    url = 'https://api.openai.com/v1/chat/completions';
    headers = { 'Content-Type':'application/json', 'Authorization':'Bearer '+S.apiKey };
    body = { model: S.model, messages, ...(jsonMode ? { response_format:{type:'json_object'} } : {}) };
  }

  const resp = await fetch(url, { method:'POST', headers, body:JSON.stringify(body) });
  if (!resp.ok) {
    const e = await resp.json().catch(()=>({error:{message:'HTTP '+resp.status}}));
    throw new Error(e.error?.message || 'HTTP '+resp.status);
  }
  const d = await resp.json();
  return d.choices[0].message.content;
}

/* ================================================
   é¡µé¢æ¸²æŸ“ï¼ˆA3 é¢„è§ˆï¼‰
   1mm â‰ˆ 3.7795px @96dpi
================================================ */
const MM = 3.7795;

function render() {
  const { pageW, pageH, pageMargin } = S;
  const pw = Math.round(pageW * MM * S.zoom);
  const ph = Math.round(pageH * MM * S.zoom);
  const mg = Math.round(pageMargin * MM * S.zoom);
  const iw = pw - mg * 2;
  const ih = ph - mg * 2;

  const pages = [
    page_location(pw, ph, mg, iw, ih),
    page_site(pw, ph, mg, iw, ih),
    page_building(pw, ph, mg, iw, ih),
    page_inspiration(pw, ph, mg, iw, ih),
    page_concept(pw, ph, mg, iw, ih),
    page_zones(pw, ph, mg, iw, ih),
  ];

  document.getElementById('pg-count').textContent = pages.length;
  document.getElementById('pages-wrap').innerHTML = pages.map((html, i) => `
    <div class="page-wrap">
      <div class="page-num-label">P${i+1}</div>
      <div class="a3-page" style="width:${pw}px;height:${ph}px;">${html}</div>
    </div>
  `).join('');
}

function doZoom(dir) {
  S.zoom = Math.min(1.2, Math.max(0.3, +(S.zoom + dir * 0.1).toFixed(1)));
  document.getElementById('zoom-txt').textContent = Math.round(S.zoom*100) + '%';
  render();
}

/* ---- é€šç”¨ï¼šé¡µçœ‰ ---- */
function hdr(chapter, title, mg, color) {
  const z = S.zoom;
  return `
  <div style="display:flex;align-items:flex-end;justify-content:space-between;
    padding-bottom:${Math.round(mg*0.28)}px;margin-bottom:${Math.round(mg*0.3)}px;
    border-bottom:${Math.round(2*z)}px solid ${color};">
    <div>
      <div style="font-size:${Math.round(9*z)}px;color:#8e8e93;font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:${Math.round(2*z)}px;">${chapter}</div>
      <div style="font-size:${Math.round(20*z)}px;font-weight:700;letter-spacing:-0.5px;color:#1d1d1f;">${title}</div>
    </div>
    <div style="font-size:${Math.round(9*z)}px;color:#aeaeb2;">æ™¯è§‚æ–¹æ¡ˆè®¾è®¡</div>
  </div>`;
}

/* ---- é€šç”¨ï¼šå›¾ç‰‡å ä½ç¬¦ ---- */
let _imgIdx = 0;
function slot(w, h, label) {
  const id = 'slot-' + (++_imgIdx);
  const wS = typeof w==='number' ? w+'px' : w;
  const hS = typeof h==='number' ? h+'px' : h;
  const z = S.zoom;
  return `
  <div class="img-slot" id="${id}" onclick="uploadSlot('${id}')"
    style="width:${wS};height:${hS};min-height:${Math.round(40*z)}px;">
    <svg width="${Math.round(22*z)}" height="${Math.round(22*z)}" viewBox="0 0 24 24" fill="none" stroke="#c7c7cc" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
    <span style="font-size:${Math.round(10*z)}px;color:#aeaeb2;margin-top:${Math.round(4*z)}px;">${label}</span>
  </div>`;
}

/* ====== é¡µ1ï¼šåŒºä½åˆ†æ ====== */
function page_location(pw, ph, mg, iw, ih) {
  const z = S.zoom; const d = S.pages.location;
  const kws = d.keywords.length ? d.keywords : ['åŒºä½ä¼˜è¶Š','äº¤é€šä¾¿åˆ©','é…å¥—å®Œå–„'];
  const lw = Math.round(iw * 0.57);
  const rw = iw - lw - Math.round(mg * 0.4);
  return `
  <div style="position:absolute;inset:${mg}px;display:flex;flex-direction:column;">
    ${hdr('Chapter 01 Â· å‰æœŸåˆ†æ', d.title||'åŒºä½åˆ†æ', mg, '#0071e3')}
    <div style="flex:1;display:flex;gap:${Math.round(mg*0.4)}px;min-height:0;">
      <div style="width:${lw}px;display:flex;flex-direction:column;gap:${Math.round(mg*0.3)}px;">
        ${slot(lw, '65%', 'åŒºä½æ€»å›¾')}
        <div style="flex:1;display:flex;gap:${Math.round(mg*0.3)}px;">
          <div style="flex:1;">${slot('100%','100%','äº¤é€šåˆ†æå›¾')}</div>
          <div style="flex:1;">${slot('100%','100%','å‘¨è¾¹é…å¥—å›¾')}</div>
        </div>
      </div>
      <div style="width:${rw}px;display:flex;flex-direction:column;justify-content:center;gap:${Math.round(mg*0.5)}px;">
        <div style="font-size:${Math.round(11*z)}px;line-height:1.85;color:#3a3a3c;">
          ${d.content||'é¡¹ç›®ä½äºåŸå¸‚æ ¸å¿ƒåŒºåŸŸï¼Œåœ°ç†ä½ç½®ä¼˜è¶Šã€‚å‘¨è¾¹é…å¥—è®¾æ–½å®Œå–„ï¼Œæ•™è‚²ã€åŒ»ç–—ã€å•†ä¸šèµ„æºä¸°å¯Œã€‚åŒºåŸŸäº¤é€šç½‘ç»œå‘è¾¾ï¼Œæ˜¯ç†æƒ³çš„æ™¯è§‚è®¾è®¡åŸºåœ°ã€‚'}
        </div>
        <div style="display:flex;flex-direction:column;gap:${Math.round(6*z)}px;">
          ${kws.map(k=>`<div style="display:flex;align-items:center;gap:${Math.round(8*z)}px;"><div style="width:${Math.round(5*z)}px;height:${Math.round(5*z)}px;border-radius:50%;background:#0071e3;flex-shrink:0;"></div><span style="font-size:${Math.round(11*z)}px;color:#1d1d1f;font-weight:500;">${k}</span></div>`).join('')}
        </div>
      </div>
    </div>
  </div>`;
}

/* ====== é¡µ2ï¼šåŸºåœ°åˆ†æ ====== */
function page_site(pw, ph, mg, iw, ih) {
  const z = S.zoom; const d = S.pages.site;
  const kws = d.keywords.length ? d.keywords : ['åœ°å½¢èµ·ä¼','æ¤è¢«ä¸°å¯Œ','æ°´ä½“èµ„æº'];
  const gap = Math.round(mg * 0.3);
  return `
  <div style="position:absolute;inset:${mg}px;display:flex;flex-direction:column;">
    ${hdr('Chapter 01 Â· å‰æœŸåˆ†æ', d.title||'åŸºåœ°åˆ†æ', mg, '#34c759')}
    <div style="flex:1;display:grid;grid-template-columns:1fr 1fr 1fr;grid-template-rows:1.4fr 1fr;gap:${gap}px;min-height:0;">
      <div style="grid-column:1/3;grid-row:1/2;">${slot('100%','100%','åŸºåœ°å…¨æ™¯å›¾')}</div>
      <div style="grid-column:3/4;grid-row:1/2;display:flex;flex-direction:column;justify-content:center;gap:${Math.round(mg*0.3)}px;overflow:hidden;">
        <div style="font-size:${Math.round(11*z)}px;line-height:1.85;color:#3a3a3c;">
          ${d.content||'åŸºåœ°ç°çŠ¶åˆ†ææ¶µç›–åœ°å½¢åœ°è²Œã€æ¤è¢«è¦†ç›–ã€æ°´ä½“èµ„æºåŠå‘¨è¾¹ç¯å¢ƒç­‰è¦ç´ ï¼Œä¸ºæ™¯è§‚è®¾è®¡æä¾›å……åˆ†çš„åœºåœ°ä¾æ®ã€‚'}
        </div>
        ${kws.map(k=>`<div style="background:rgba(52,199,89,0.1);border-radius:${Math.round(20*z)}px;padding:${Math.round(3*z)}px ${Math.round(10*z)}px;font-size:${Math.round(10*z)}px;color:#34c759;font-weight:500;display:inline-block;width:fit-content;">${k}</div>`).join('')}
      </div>
      <div>${slot('100%','100%','åœ°å½¢åˆ†æ')}</div>
      <div>${slot('100%','100%','æ¤è¢«ç°çŠ¶')}</div>
      <div>${slot('100%','100%','å‘¨è¾¹ç¯å¢ƒ')}</div>
    </div>
  </div>`;
}

/* ====== é¡µ3ï¼šå»ºç­‘åˆ†æ ====== */
function page_building(pw, ph, mg, iw, ih) {
  const z = S.zoom; const d = S.pages.building;
  const kws = d.keywords.length ? d.keywords : ['ç°ä»£ç®€çº¦','çŸ³æå¹•å¢™','è¡Œåˆ—å¼å¸ƒå±€'];
  const gap = Math.round(mg * 0.3);
  return `
  <div style="position:absolute;inset:${mg}px;display:flex;flex-direction:column;">
    ${hdr('Chapter 01 Â· å‰æœŸåˆ†æ', d.title||'å»ºç­‘åˆ†æ', mg, '#ff9500')}
    <div style="flex:1;display:flex;gap:${Math.round(mg*0.4)}px;min-height:0;">
      <div style="width:${Math.round(iw*0.34)}px;display:flex;flex-direction:column;justify-content:center;gap:${Math.round(mg*0.4)}px;">
        <div style="font-size:${Math.round(11*z)}px;line-height:1.85;color:#3a3a3c;">
          ${d.content||'å»ºç­‘é£æ ¼ç°ä»£ç®€çº¦ï¼Œç«‹é¢ä»¥ç»ç’ƒå¹•å¢™ä¸çŸ³æä¸ºä¸»è¦æè´¨ï¼Œæ•´ä½“å¸ƒå±€è§„æ•´æœ‰åºã€‚å»ºç­‘åº•å±‚ç•Œé¢ä¸æ™¯è§‚çš„è¡”æ¥å…³ç³»æ˜¯è®¾è®¡é‡ç‚¹ï¼Œéœ€åˆ›é€ ä¸°å¯Œçš„è¿‡æ¸¡ç©ºé—´ã€‚'}
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:${Math.round(5*z)}px;">
          ${kws.map(k=>`<span style="background:rgba(255,149,0,0.12);color:#e08000;border-radius:${Math.round(20*z)}px;padding:${Math.round(3*z)}px ${Math.round(10*z)}px;font-size:${Math.round(10*z)}px;font-weight:500;">${k}</span>`).join('')}
        </div>
      </div>
      <div style="flex:1;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1.3fr 1fr;gap:${gap}px;">
        <div style="grid-column:1/3;">${slot('100%','100%','å»ºç­‘æ€»ä½“å¸ƒå±€å›¾')}</div>
        <div>${slot('100%','100%','å»ºç­‘ç«‹é¢')}</div>
        <div>${slot('100%','100%','å»ºç­‘ç»†èŠ‚/æè´¨')}</div>
      </div>
    </div>
  </div>`;
}

/* ====== é¡µ4ï¼šçµæ„Ÿæ¥æº ====== */
function page_inspiration(pw, ph, mg, iw, ih) {
  const z = S.zoom; const d = S.pages.inspo;
  const gap = Math.round(mg * 0.3);
  return `
  <div style="position:absolute;inset:${mg}px;display:flex;flex-direction:column;">
    ${hdr('Chapter 02 Â· è®¾è®¡æ„æ€', 'çµæ„Ÿæ¥æº', mg, '#af52de')}
    <div style="flex:1;position:relative;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:${gap}px;min-height:0;">
      <div>${slot('100%','100%','çµæ„Ÿå›¾ 1')}</div>
      <div>${slot('100%','100%','çµæ„Ÿå›¾ 2')}</div>
      <div>${slot('100%','100%','çµæ„Ÿå›¾ 3')}</div>
      <div>${slot('100%','100%','çµæ„Ÿå›¾ 4')}</div>
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.93);backdrop-filter:blur(12px);border-radius:${Math.round(12*z)}px;padding:${Math.round(14*z)}px ${Math.round(18*z)}px;max-width:${Math.round(iw*0.46)}px;text-align:center;box-shadow:0 ${Math.round(8*z)}px ${Math.round(28*z)}px rgba(0,0,0,0.14);">
        <div style="font-size:${Math.round(9*z)}px;color:#af52de;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:${Math.round(7*z)}px;">INSPIRATION</div>
        <div style="font-size:${Math.round(11*z)}px;line-height:1.8;color:#3a3a3c;">
          ${d.content||'è®¾è®¡çµæ„Ÿæºäºè‡ªç„¶å±±æ°´ä¸äººæ–‡å†å²çš„äº¤èï¼Œåœ¨ä¼ ç»Ÿä¸ç°ä»£ä¹‹é—´å¯»æ‰¾å¹³è¡¡ç‚¹ï¼Œä»¥æ™¯æŠ’æƒ…ï¼Œä»¥å›­è¿°å²ï¼Œæ‰“é€ å¯Œæœ‰åœºæ‰€ç²¾ç¥çš„æ™¯è§‚ç©ºé—´ã€‚'}
        </div>
      </div>
    </div>
  </div>`;
}

/* ====== é¡µ5ï¼šè®¾è®¡ç†å¿µ ====== */
function page_concept(pw, ph, mg, iw, ih) {
  const z = S.zoom; const d = S.pages.concept;
  const gap = Math.round(mg * 0.35);
  return `
  <div style="position:absolute;inset:${mg}px;display:flex;flex-direction:column;">
    ${hdr('Chapter 02 Â· è®¾è®¡æ„æ€', 'è®¾è®¡ç†å¿µ', mg, '#ff2d55')}
    <div style="flex:1;display:flex;gap:${Math.round(mg*0.4)}px;min-height:0;">
      <div style="flex:1;display:flex;flex-direction:column;gap:${gap}px;">
        <div style="font-size:${Math.round(12*z)}px;font-weight:600;line-height:1.75;color:#1d1d1f;padding:${Math.round(14*z)}px;background:#fff5f7;border-radius:${Math.round(10*z)}px;border-left:${Math.round(4*z)}px solid #ff2d55;">
          ${d.content||'ä»¥"å…±ç”Ÿ"ä¸ºæ ¸å¿ƒç†å¿µï¼Œæ‰“é€ äººä¸è‡ªç„¶å’Œè°å…±å¤„çš„ç”Ÿæ€æ™¯è§‚ç©ºé—´ã€‚é€šè¿‡å¤šå±‚æ¬¡ç»¿åŒ–ä½“ç³»ä¸å¼¹æ€§æ´»åŠ¨ç©ºé—´çš„ç»“åˆï¼Œå®ç°æ™¯è§‚ä¸ç”Ÿæ´»çš„æ·±åº¦èåˆï¼Œè®©æ¯ä½å±…æ°‘éƒ½èƒ½åœ¨å››å­£æ›´è¿­ä¸­æ„Ÿå—è‡ªç„¶çš„å¾‹åŠ¨ã€‚'}
        </div>
        <div style="flex:1;">${slot('100%','100%','æ¦‚å¿µåˆ†æå›¾ / è®¾è®¡é€»è¾‘å›¾')}</div>
      </div>
      <div style="width:${Math.round(iw*0.38)}px;display:flex;flex-direction:column;gap:${gap}px;">
        <div style="flex:1;">${slot('100%','100%','è®¾è®¡æ„å‘å›¾ 1')}</div>
        <div style="flex:1;">${slot('100%','100%','è®¾è®¡æ„å‘å›¾ 2')}</div>
      </div>
    </div>
  </div>`;
}

/* ====== é¡µ6ï¼šä¸»é¢˜è½ä½ ====== */
function page_zones(pw, ph, mg, iw, ih) {
  const z = S.zoom; const d = S.pages.zones;
  const colors = ['#0071e3','#34c759','#ff9500','#ff2d55','#af52de','#5ac8fa'];
  const zones = d.content
    ? d.content.split('\n').filter(l=>l.trim()).map(l => {
        const idx = l.indexOf('ï¼š') > -1 ? l.indexOf('ï¼š') : l.indexOf(':');
        return idx > -1
          ? { name: l.slice(0,idx).trim(), desc: l.slice(idx+1).trim() }
          : { name: l.trim(), desc: '' };
      })
    : [
        {name:'å…¥å£å¹¿åœº',desc:'æ´»åŠ›è¿å®¾ï¼Œå±•ç¤ºå½¢è±¡'},
        {name:'ä¸­å¿ƒç»¿åœ°',desc:'ç”Ÿæ€ä¼‘æ†©ï¼Œå…±äº«ç©ºé—´'},
        {name:'æ»¨æ°´æ ˆé“',desc:'äº²æ°´ä½“éªŒï¼Œç”Ÿæ€å»Šé“'},
        {name:'è¿åŠ¨å¥èº«åŒº',desc:'å…¨é¾„å‹å¥½ï¼Œæ´»åŠ›è¿åŠ¨'},
        {name:'é™æ€èŠ±å›­',desc:'å®é™æ²‰æ€ï¼Œç§å¯†åº‡æŠ¤'},
      ];
  return `
  <div style="position:absolute;inset:${mg}px;display:flex;flex-direction:column;">
    ${hdr('Chapter 02 Â· è®¾è®¡æ„æ€', 'ä¸»é¢˜è½ä½', mg, '#5ac8fa')}
    <div style="flex:1;display:flex;gap:${Math.round(mg*0.45)}px;min-height:0;">
      <div style="flex:1;">${slot('100%','100%','æ€»å¹³é¢å›¾ï¼ˆå«åˆ†åŒºæ ‡æ³¨ï¼‰')}</div>
      <div style="width:${Math.round(iw*0.35)}px;display:flex;flex-direction:column;justify-content:center;gap:${Math.round(mg*0.35)}px;overflow:hidden;">
        ${zones.map((zone,i)=>`
        <div style="display:flex;gap:${Math.round(10*z)}px;align-items:flex-start;">
          <div style="width:${Math.round(26*z)}px;height:${Math.round(26*z)}px;background:${colors[i%colors.length]};border-radius:${Math.round(6*z)}px;display:flex;align-items:center;justify-content:center;color:white;font-size:${Math.round(11*z)}px;font-weight:700;flex-shrink:0;">${String.fromCharCode(65+i)}</div>
          <div style="overflow:hidden;">
            <div style="font-size:${Math.round(11.5*z)}px;font-weight:600;color:#1d1d1f;margin-bottom:${Math.round(2*z)}px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${zone.name}</div>
            <div style="font-size:${Math.round(10.5*z)}px;color:#6e6e73;line-height:1.5;">${zone.desc}</div>
          </div>
        </div>`).join('')}
      </div>
    </div>
  </div>`;
}

/* ================================================
   å›¾ç‰‡ä¸Šä¼ ï¼ˆç‚¹å‡»å ä½ç¬¦ï¼‰
================================================ */
function uploadSlot(id) {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const el = document.getElementById(id);
      if (!el) return;
      el.innerHTML = `<img src="${ev.target.result}" style="width:100%;height:100%;object-fit:cover;display:block;">`;
      el.style.border = 'none'; el.style.background = 'none';
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

/* ================================================
   è‡ªå»º ZIP æ„å»ºå™¨ï¼ˆæ›¿ä»£ JSZipï¼‰
   IDML è§„èŒƒï¼š
   - mimetype å¿…é¡»ç¬¬ä¸€ä¸ªï¼ŒSTORE å‹ç¼©ï¼Œextra field = 0
   - å…¶ä½™æ–‡ä»¶ç”¨ DEFLATEï¼ˆä¸çœŸå® InDesign å¯¼å‡ºçš„ IDML ä¸€è‡´ï¼‰
   - ä½¿ç”¨æµè§ˆå™¨å†…ç½® CompressionStreamï¼ˆChrome 80+ / Edge 80+ å‡æ”¯æŒï¼‰
================================================ */
function _makeCRC32Table() {
  const t = new Uint32Array(256);
  for (let n = 0; n < 256; n++) {
    let c = n;
    for (let k = 0; k < 8; k++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
    t[n] = c >>> 0;
  }
  return t;
}
const _CRC32_TABLE = _makeCRC32Table();

function _crc32(data) {
  let c = 0xFFFFFFFF;
  for (let i = 0; i < data.length; i++)
    c = (_CRC32_TABLE[(c ^ data[i]) & 0xFF] ^ (c >>> 8)) >>> 0;
  return (c ^ 0xFFFFFFFF) >>> 0;
}

/* ç”¨æµè§ˆå™¨å†…ç½® DeflateRaw å‹ç¼©æ•°æ®ï¼ˆZIP é‡Œçš„ DEFLATE æ˜¯ raw deflateï¼‰ */
async function _deflateRaw(data) {
  const cs = new CompressionStream('deflate-raw');
  const writer = cs.writable.getWriter();
  writer.write(data);
  writer.close();
  const chunks = [];
  const reader = cs.readable.getReader();
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    chunks.push(value);
  }
  let size = 0;
  for (const c of chunks) size += c.length;
  const out = new Uint8Array(size);
  let pos = 0;
  for (const c of chunks) { out.set(c, pos); pos += c.length; }
  return out;
}

/* buildZipStore(entries) â€”â€” è¿”å› Promise<Uint8Array>
   mimetype â†’ STOREï¼›å…¶ä½™æ–‡ä»¶ â†’ DEFLATEï¼ˆä¸çœŸå® IDML ç›¸åŒï¼‰
   æ‰€æœ‰ local file header extra field = 0ï¼Œflags = 0ï¼ˆçº¯ ASCII è·¯å¾„æ— éœ€ UTF-8 æ ‡å¿—ï¼‰ */
async function buildZipStore(entries) {
  const enc = new TextEncoder();
  const localParts = [];   // æœ¬åœ°æ–‡ä»¶å¤´ + æ•°æ®å—
  const cdEntries  = [];   // ä¸­å¤®ç›®å½•è®°å½•
  let offset = 0;

  for (const entry of entries) {
    const name    = enc.encode(entry.name);
    const rawData = typeof entry.data === 'string' ? enc.encode(entry.data) : entry.data;
    const crc     = _crc32(rawData);             // CRC ç”¨åŸå§‹æ•°æ®è®¡ç®—
    const origSize = rawData.length;

    /* mimetype å¿…é¡» STOREï¼›å…¶ä½™ç”¨ DEFLATE */
    const isMime = (entry.name === 'mimetype');
    let compData, method, verNeeded;
    if (isMime) {
      compData  = rawData;
      method    = 0;  // STORE
      verNeeded = 10; // ZIP 1.0
    } else {
      compData  = await _deflateRaw(rawData);
      /* è‹¥å‹ç¼©ååè€Œæ›´å¤§ï¼ˆæå°æ–‡ä»¶ï¼‰ï¼Œé€€å› STORE */
      if (compData.length >= origSize) { compData = rawData; method = 0; verNeeded = 10; }
      else { method = 8; verNeeded = 20; } // DEFLATEï¼ŒZIP 2.0
    }
    const compSize = compData.length;

    /* æœ¬åœ°æ–‡ä»¶å¤´ï¼š30 å­—èŠ‚å›ºå®š + æ–‡ä»¶åï¼Œextra field = 0 */
    const lh = new Uint8Array(30 + name.length);
    const lv = new DataView(lh.buffer);
    lv.setUint32(0,  0x04034b50, true); // Local file header ç­¾å
    lv.setUint16(4,  verNeeded,  true); // ç‰ˆæœ¬éœ€æ±‚
    lv.setUint16(6,  0x0000,     true); // flags = 0ï¼ˆè·¯å¾„å…¨ ASCIIï¼Œæ— éœ€ UTF-8 æ ‡å¿—ï¼‰
    lv.setUint16(8,  method,     true); // å‹ç¼©æ–¹å¼
    lv.setUint16(10, 0,          true); // ä¿®æ”¹æ—¶é—´
    lv.setUint16(12, 0,          true); // ä¿®æ”¹æ—¥æœŸ
    lv.setUint32(14, crc,        true); // CRC-32ï¼ˆåŸå§‹æ•°æ®ï¼‰
    lv.setUint32(18, compSize,   true); // å‹ç¼©åå¤§å°
    lv.setUint32(22, origSize,   true); // åŸå§‹å¤§å°
    lv.setUint16(26, name.length,true); // æ–‡ä»¶åé•¿åº¦
    lv.setUint16(28, 0,          true); // extra field é•¿åº¦ = 0ï¼ˆIDML å…³é”®è¦æ±‚ï¼‰
    lh.set(name, 30);

    cdEntries.push({ name, crc, compSize, origSize, offset, method, verNeeded });
    localParts.push(lh, compData);
    offset += 30 + name.length + compSize;
  }

  /* ä¸­å¤®ç›®å½• */
  const cdStart  = offset;
  const cdChunks = cdEntries.map(cd => {
    const chunk = new Uint8Array(46 + cd.name.length);
    const dv    = new DataView(chunk.buffer);
    dv.setUint32(0,  0x02014b50,      true); // ä¸­å¤®ç›®å½•ç­¾å
    dv.setUint16(4,  20,              true); // ç‰ˆæœ¬ï¼ˆåˆ¶ä½œæ–¹ 2.0ï¼‰
    dv.setUint16(6,  cd.verNeeded,    true); // ç‰ˆæœ¬ï¼ˆéœ€æ±‚ï¼‰
    dv.setUint16(8,  0x0000,          true); // flags = 0
    dv.setUint16(10, cd.method,       true); // å‹ç¼©æ–¹å¼
    dv.setUint16(12, 0,               true); // æ—¶é—´
    dv.setUint16(14, 0,               true); // æ—¥æœŸ
    dv.setUint32(16, cd.crc,          true); // CRC-32
    dv.setUint32(20, cd.compSize,     true); // å‹ç¼©å¤§å°
    dv.setUint32(24, cd.origSize,     true); // åŸå§‹å¤§å°
    dv.setUint16(28, cd.name.length,  true); // æ–‡ä»¶åé•¿åº¦
    dv.setUint16(30, 0,               true); // extra é•¿åº¦ = 0
    dv.setUint16(32, 0,               true); // æ³¨é‡Šé•¿åº¦
    dv.setUint16(34, 0,               true); // ç£ç›˜ç¼–å·
    dv.setUint16(36, 0,               true); // å†…éƒ¨å±æ€§
    dv.setUint32(38, 0,               true); // å¤–éƒ¨å±æ€§
    dv.setUint32(42, cd.offset,       true); // æœ¬åœ°å¤´åç§»
    chunk.set(cd.name, 46);
    return chunk;
  });

  /* EOCDï¼ˆEnd of Central Directoryï¼‰22 å­—èŠ‚ */
  const cdSize = cdChunks.reduce((s, c) => s + c.length, 0);
  const eocd   = new Uint8Array(22);
  const ev     = new DataView(eocd.buffer);
  ev.setUint32(0,  0x06054b50,        true); // EOCD ç­¾å
  ev.setUint16(4,  0,                 true); // ç£ç›˜ç¼–å·
  ev.setUint16(6,  0,                 true); // CD èµ·å§‹ç£ç›˜
  ev.setUint16(8,  cdEntries.length,  true); // æœ¬ç£ç›˜æ¡ç›®æ•°
  ev.setUint16(10, cdEntries.length,  true); // æ€»æ¡ç›®æ•°
  ev.setUint32(12, cdSize,            true); // ä¸­å¤®ç›®å½•å¤§å°
  ev.setUint32(16, cdStart,           true); // ä¸­å¤®ç›®å½•åç§»
  ev.setUint16(20, 0,                 true); // æ³¨é‡Šé•¿åº¦

  /* æ‹¼æ¥æ‰€æœ‰å­—èŠ‚ */
  const total = offset + cdSize + eocd.length;
  const out   = new Uint8Array(total);
  let pos = 0;
  for (const p of localParts) { out.set(p, pos); pos += p.length; }
  for (const c of cdChunks)   { out.set(c, pos); pos += c.length; }
  out.set(eocd, pos);
  return out;
}

/* ================================================
   å¯¼å‡º IDMLï¼ˆInDesign Markup Languageï¼‰
   IDML æ˜¯ ZIP å‹ç¼©åŒ…ï¼Œå†…å« XMLï¼ŒInDesign 2019+ å¯ç›´æ¥æ‰“å¼€
   åæ ‡å•ä½ï¼šç‚¹ï¼ˆptï¼‰ï¼Œ1mm = 2.834645pt
================================================ */
async function exportIDML() {
  const MM = 2.834645; // 1mm = 2.834645pt
  const pw = S.pageW * MM;   // é¡µå®½ï¼ˆptï¼‰
  const ph = S.pageH * MM;   // é¡µé«˜ï¼ˆptï¼‰
  const mg = S.pageMargin * MM; // é¡µè¾¹è·ï¼ˆptï¼‰

  // å†…å®¹åŒºï¼ˆè¾¹è·å†…ï¼‰
  const cTop    = mg;
  const cLeft   = mg;
  const cBottom = ph - mg;
  const cRight  = pw - mg;
  const cW      = cRight - cLeft;
  const cH      = cBottom - cTop;

  // é¡µé¢æ•°æ®
  const pagesData = [
    { id:'location', ch:'Chapter 01 Â· å‰æœŸåˆ†æ', title: S.pages.location.title||'åŒºä½åˆ†æ',  content: S.pages.location.content,  keywords: S.pages.location.keywords, color:'#0071e3',
      layout: 'text-right', imgCount: 3 },
    { id:'site',     ch:'Chapter 01 Â· å‰æœŸåˆ†æ', title: S.pages.site.title||'åŸºåœ°åˆ†æ',       content: S.pages.site.content,       keywords: S.pages.site.keywords,     color:'#34c759',
      layout: 'text-right-grid', imgCount: 5 },
    { id:'building', ch:'Chapter 01 Â· å‰æœŸåˆ†æ', title: S.pages.building.title||'å»ºç­‘åˆ†æ',   content: S.pages.building.content,   keywords: S.pages.building.keywords, color:'#ff9500',
      layout: 'text-left', imgCount: 3 },
    { id:'inspo',    ch:'Chapter 02 Â· è®¾è®¡æ„æ€', title:'çµæ„Ÿæ¥æº', content: S.pages.inspo.content,    keywords: [], color:'#af52de',
      layout: 'grid-overlay', imgCount: 4 },
    { id:'concept',  ch:'Chapter 02 Â· è®¾è®¡æ„æ€', title:'è®¾è®¡ç†å¿µ', content: S.pages.concept.content,  keywords: [], color:'#ff2d55',
      layout: 'text-top', imgCount: 2 },
    { id:'zones',    ch:'Chapter 02 Â· è®¾è®¡æ„æ€', title:'ä¸»é¢˜è½ä½', content: S.pages.zones.content,   keywords: [], color:'#5ac8fa',
      layout: 'list-right', imgCount: 1 },
  ];

  // ä½¿ç”¨è‡ªå»º ZIP æ„å»ºå™¨ï¼ˆå®Œå…¨æ§åˆ¶æ¯ä¸ªå­—èŠ‚ï¼Œç¡®ä¿ IDML åˆè§„ï¼‰
  const entries = [];

  /* ---- mimetypeï¼ˆå¿…é¡»ç¬¬ä¸€ä¸ªï¼Œä¸å‹ç¼©ï¼‰ ---- */
  entries.push({ name: 'mimetype', data: 'application/vnd.adobe.indesign-idml-package' });

  /* ---- META-INF/container.xml ---- */
  entries.push({ name: 'META-INF/container.xml', data: `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<container xmlns="urn:oasis:names:tc:opendocument:xmlns:container" version="1.0">
  <rootfiles>
    <rootfile full-path="designmap.xml" media-type="application/vnd.adobe.indesign-idml-package"/>
  </rootfiles>
</container>` });

  /* ---- XML/Tags.xml ---- */
  entries.push({ name: 'XML/Tags.xml', data: `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Tags xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0"></idPkg:Tags>` });

  /* ---- XML/BackingStory.xml ---- */
  entries.push({ name: 'XML/BackingStory.xml', data: `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Story xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <XmlStory Self="rc_BACKING_STORY" AppliedTOCStyle="n" TrackChanges="false" StoryTitle="$ID/NullString">
    <StoryPreference OpticalMarginAlignment="false" OpticalMarginSize="12" FrameType="TextFrameType" StoryOrientation="Horizontal" StoryDirection="LeftToRightDirection"/>
    <InCopyExportOption IncludeGraphicProxies="true" IncludeAllResources="false"/>
  </XmlStory>
</idPkg:Story>` });

  /* ---- Resources/Fonts.xmlï¼ˆç©ºæ–‡ä»¶ï¼ŒInDesign è‡ªåŠ¨å¤„ç†å­—ä½“ï¼‰ ---- */
  entries.push({ name: 'Resources/Fonts.xml', data: `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Fonts xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <FontFamily Self="ff_msyh" Name="Microsoft YaHei">
    <Font Self="ff_msyh_r" FontFamily="Microsoft YaHei" Name="Microsoft YaHei\tRegular" PostScriptName="MicrosoftYaHei" Status="Installed" FontStyleName="Regular" FontType="OpenType" FullName="Microsoft YaHei"/>
    <Font Self="ff_msyh_b" FontFamily="Microsoft YaHei" Name="Microsoft YaHei\tBold"    PostScriptName="MicrosoftYaHei-Bold"   Status="Installed" FontStyleName="Bold"    FontType="OpenType" FullName="Microsoft YaHei Bold"/>
  </FontFamily>
</idPkg:Fonts>` });

  /* ---- Resources/Graphic.xml â€” å¿…é¡»å®šä¹‰æ‰€æœ‰è¢« Styles/Frame å¼•ç”¨çš„é¢œè‰² ---- */
  entries.push({ name: 'Resources/Graphic.xml', data: `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Graphic xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <ColorGroup Self="cg_default" Name="$ID/">
    <Color Self="Color/Black"              Name="Black"              Model="Process" Space="CMYK" ColorValue="0 0 0 100" IsSpot="false"/>
    <Color Self="Color/C=0 M=0 Y=0 K=100" Name="C=0 M=0 Y=0 K=100" Model="Process" Space="CMYK" ColorValue="0 0 0 100" IsSpot="false"/>
    <Color Self="Color/C=0 M=0 Y=0 K=85"  Name="C=0 M=0 Y=0 K=85"  Model="Process" Space="CMYK" ColorValue="0 0 0 85"  IsSpot="false"/>
    <Color Self="Color/C=0 M=0 Y=0 K=80"  Name="C=0 M=0 Y=0 K=80"  Model="Process" Space="CMYK" ColorValue="0 0 0 80"  IsSpot="false"/>
    <Color Self="Color/C=0 M=0 Y=0 K=60"  Name="C=0 M=0 Y=0 K=60"  Model="Process" Space="CMYK" ColorValue="0 0 0 60"  IsSpot="false"/>
    <Color Self="Color/C=0 M=0 Y=0 K=15"  Name="C=0 M=0 Y=0 K=15"  Model="Process" Space="CMYK" ColorValue="0 0 0 15"  IsSpot="false"/>
    <Color Self="Color/Gray"               Name="Gray"               Model="Process" Space="CMYK" ColorValue="0 0 0 30"  IsSpot="false"/>
    <Color Self="Color/White"              Name="White"              Model="Process" Space="CMYK" ColorValue="0 0 0 0"   IsSpot="false"/>
    <Color Self="Color/None"               Name="$ID/None"           Model="Process" Space="CMYK" ColorValue="0 0 0 0"   IsSpot="false"/>
  </ColorGroup>
</idPkg:Graphic>` });

  /* ---- Resources/Preferences.xml ---- */
  entries.push({ name: 'Resources/Preferences.xml', data: `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Preferences xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <DocumentPreference PageWidth="${pw.toFixed(3)}" PageHeight="${ph.toFixed(3)}" FacingPages="false" AllowPageShuffle="true" DocumentBleedTopOffset="0" DocumentBleedBottomOffset="0" DocumentBleedInsideOrLeftOffset="0" DocumentBleedOutsideOrRightOffset="0"/>
  <GridPreference BaselineStart="${mg.toFixed(3)}" BaselineDivision="14.4" BaselineGridShown="false" ColumnGuidesShown="true" DocumentGridShown="false"/>
  <MarginPreference Top="${mg.toFixed(3)}" Bottom="${mg.toFixed(3)}" Left="${mg.toFixed(3)}" Right="${mg.toFixed(3)}" ColumnCount="1" ColumnGutter="14.4"/>
  <PasteboardPreference PasteboardMargins="116.220472440945 116.220472440945" MinimumSpaceBetweenPages="28.3464566929134" PreviewBackgroundColor="Color/C=0 M=0 Y=0 K=15"/>
</idPkg:Preferences>` });

  /* ---- Resources/Styles.xmlï¼ˆæ®µè½æ ·å¼ï¼‰ ---- */
  entries.push({ name: 'Resources/Styles.xml', data: buildStylesXML() });

  /* ---- ä¸ºæ¯é¡µç”Ÿæˆ Spread + Story ---- */
  const spreadRefs = [];
  const storyRefs  = [];
  let   imgCounter = 0;

  pagesData.forEach((pd, pi) => {
    const spreadId    = `ub${pi}`;
    const pageId      = `${spreadId}p`;
    const textStoryId = `st_${spreadId}_txt`;
    spreadRefs.push(spreadId);

    // ç”Ÿæˆè¯¥é¡µæ–‡å­— Story
    entries.push({ name: `Stories/Story_${textStoryId}.xml`, data: buildStoryXML(textStoryId, pd) });
    storyRefs.push(textStoryId);

    // ç”Ÿæˆ Spreadï¼ˆæ–‡å­—æ¡† + å›¾ç‰‡æ¡†ï¼‰
    entries.push({ name: `Spreads/Spread_${spreadId}.xml`, data: buildSpreadXML(spreadId, pageId, textStoryId, pd, pi, pw, ph, mg, cTop, cLeft, cBottom, cRight, cW, cH, imgCounter) });
    imgCounter += pd.imgCount;
  });

  /* ---- designmap.xml ---- */
  entries.push({ name: 'designmap.xml', data: buildDesignMap(spreadRefs, storyRefs, pw, ph, mg) });

  /* ---- ç”Ÿæˆå¹¶ä¸‹è½½ ---- */
  try {
    const zipBytes = await buildZipStore(entries);
    const blob = new Blob([zipBytes], { type: 'application/zip' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const projName = document.getElementById('proj-name')?.value || 'æ™¯è§‚è®¾è®¡';
    a.href = url;
    a.download = `${projName}.idml`;
    a.click();
    URL.revokeObjectURL(url);
    // è°ƒè¯•è¾“å‡ºï¼šæŠŠç¬¬1é¡µçš„ Story XML æ‰“å°åˆ°æ§åˆ¶å°ï¼Œç¡®è®¤å†…å®¹æ˜¯å¦æ­£ç¡®ç”Ÿæˆ
    console.group('IDML Debug Output');
    console.log('=== ç¬¬1é¡µ Story XML ===');
    console.log(buildStoryXML(storyRefs[0], pagesData[0]));
    console.log('=== ç¬¬1é¡µ Spread XML ===');
    console.log(buildSpreadXML('ub0','ub0p',storyRefs[0],pagesData[0],0,pw,ph,mg,cTop,cLeft,cBottom,cRight,cW,cH,0));
    console.groupEnd();
    toast('IDML å·²å¯¼å‡ºï¼Œåœ¨ InDesign ä¸­ç›´æ¥æ‰“å¼€å³å¯');
  } catch(err) {
    toast('å¯¼å‡ºå¤±è´¥ï¼š' + err.message);
    console.error(err);
  }
}

/* ================================================
   ç”Ÿæˆ designmap.xml
================================================ */
function buildDesignMap(spreadRefs, storyRefs, pw, ph, mg) {
  const spreadsXML = spreadRefs.map(id =>
    `  <idPkg:Spread src="Spreads/Spread_${id}.xml"/>`).join('\n');
  const storiesXML = storyRefs.map(id =>
    `  <idPkg:Story src="Stories/Story_${id}.xml"/>`).join('\n');
  // StoryListï¼šInDesign ç”¨äºæšä¸¾æ‰€æœ‰ Story çš„å¿…éœ€å±æ€§
  const storyList = storyRefs.join(' ');
  return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<?aid style="50" type="document" readerVersion="6.0" featureSet="257" product="19.0(151)" ?>
<Document xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging"
  DOMVersion="19.0"
  Self="d"
  ActiveLayer="lyr1"
  StoryList="${storyList}"
  Name="landscape-design"
  ZeroPoint="0 0">
  <idPkg:Fonts src="Resources/Fonts.xml"/>
  <idPkg:Styles src="Resources/Styles.xml"/>
  <idPkg:Preferences src="Resources/Preferences.xml"/>
  <idPkg:Graphic src="Resources/Graphic.xml"/>
  <Layer Self="lyr1" Name="Layer 1" Visible="true" Locked="false"
    IgnoreWrap="false" ShowGuides="true" LockGuides="false"
    UI="true" Expendable="true" Printable="true"/>
${spreadsXML}
  <idPkg:BackingStory src="XML/BackingStory.xml"/>
  <idPkg:Tags src="XML/Tags.xml"/>
${storiesXML}
</Document>`;
}

/* ================================================
   ç”Ÿæˆ Styles XMLï¼ˆæ®µè½æ ·å¼ï¼‰
================================================ */
function buildStylesXML() {
  // å‚ç…§çœŸå® InDesign 19.0 å¯¼å‡ºæ ¼å¼ï¼š
  // 1. CharacterStyle å¿…é¡»ç”¨ "[No character style]"ï¼ˆå¸¦æ–¹æ‹¬å·ï¼‰
  // 2. ParagraphStyle å¿…é¡»æœ‰ "[No paragraph style]" æ ¹æ ·å¼ï¼Œå®ƒå®šä¹‰ FillColor="Color/Black"
  //    è¿™æ˜¯æ–‡å­—é¢œè‰²çš„æ¥æºâ€”â€”ç¼ºå°‘æ­¤æ ·å¼ä¼šå¯¼è‡´æ–‡å­—é€æ˜
  // 3. NormalParagraphStyle çš„ BasedOn å¿…é¡»åœ¨ <Properties> å­å…ƒç´ é‡ŒæŒ‡å®š
  // 4. ObjectStyle åç§°å¿…é¡»å¸¦æ–¹æ‹¬å·ï¼Œå¦‚ "[Normal Text Frame]"
  return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Styles xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <RootCharacterStyleGroup Self="rootCharacterStyleGroup">
    <CharacterStyle Self="CharacterStyle/$ID/[No character style]" Name="$ID/[No character style]"/>
  </RootCharacterStyleGroup>
  <RootParagraphStyleGroup Self="rootParagraphStyleGroup">
    <!-- [No paragraph style] æ˜¯ InDesign å†…ç½®åŸºç¡€æ ·å¼ï¼Œå®šä¹‰é»˜è®¤é»‘è‰²æ–‡å­—é¢œè‰² -->
    <ParagraphStyle Self="ParagraphStyle/$ID/[No paragraph style]"
      Name="$ID/[No paragraph style]" FillColor="Color/Black">
      <Properties>
        <Leading type="enumeration">Auto</Leading>
        <AppliedFont type="string">Microsoft YaHei</AppliedFont>
      </Properties>
    </ParagraphStyle>
    <!-- NormalParagraphStyle ç»§æ‰¿è‡ª [No paragraph style] -->
    <ParagraphStyle Self="ParagraphStyle/$ID/NormalParagraphStyle"
      Name="$ID/NormalParagraphStyle"
      NextStyle="ParagraphStyle/$ID/NormalParagraphStyle">
      <Properties>
        <BasedOn type="string">$ID/[No paragraph style]</BasedOn>
      </Properties>
    </ParagraphStyle>
  </RootParagraphStyleGroup>
  <RootTableStyleGroup Self="rootTableStyleGroup">
    <TableStyle Self="TableStyle/$ID/[No table style]" Name="$ID/[No table style]"/>
    <TableStyle Self="TableStyle/$ID/[Basic Table]" Name="$ID/[Basic Table]">
      <Properties><BasedOn type="string">$ID/[No table style]</BasedOn></Properties>
    </TableStyle>
  </RootTableStyleGroup>
  <RootCellStyleGroup Self="rootCellStyleGroup">
    <CellStyle Self="CellStyle/$ID/[None]" Name="$ID/[None]"/>
  </RootCellStyleGroup>
  <!-- ObjectStyle å¿…é¡»ç”¨æ–¹æ‹¬å·æ ¼å¼ï¼Œä¸ InDesign å†…ç½®æ ·å¼åä¸€è‡´ -->
  <RootObjectStyleGroup Self="rootObjectStyleGroup">
    <ObjectStyle Self="ObjectStyle/$ID/[None]"                Name="$ID/[None]"/>
    <ObjectStyle Self="ObjectStyle/$ID/[Normal Graphics Frame]" Name="$ID/[Normal Graphics Frame]">
      <Properties><BasedOn type="string">$ID/[None]</BasedOn></Properties>
    </ObjectStyle>
    <ObjectStyle Self="ObjectStyle/$ID/[Normal Text Frame]"   Name="$ID/[Normal Text Frame]">
      <Properties><BasedOn type="string">$ID/[None]</BasedOn></Properties>
    </ObjectStyle>
    <ObjectStyle Self="ObjectStyle/$ID/[Normal Grid]"         Name="$ID/[Normal Grid]">
      <Properties><BasedOn type="string">$ID/[None]</BasedOn></Properties>
    </ObjectStyle>
  </RootObjectStyleGroup>
</idPkg:Styles>`;
}

/* ================================================
   ç”Ÿæˆ Story XMLï¼ˆæ–‡å­—å†…å®¹ï¼‰
================================================ */
function buildStoryXML(storyId, pd) {
  function escXML(str) {
    return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  const lines = [];

  // ç« èŠ‚æ ‡ç­¾
  lines.push(`<ParaStyle:ç« èŠ‚æ ‡ç­¾>${escXML(pd.ch)}`);
  // é¡µé¢æ ‡é¢˜
  lines.push(`<ParaStyle:é¡µé¢æ ‡é¢˜>${escXML(pd.title)}`);
  // æ­£æ–‡
  if (pd.content) {
    const paragraphs = pd.content.split('\n').filter(l => l.trim());
    paragraphs.forEach(para => {
      lines.push(`<ParaStyle:æ­£æ–‡>${escXML(para.trim())}`);
    });
  }
  // å…³é”®è¯
  if (pd.keywords && pd.keywords.length) {
    pd.keywords.forEach(kw => {
      lines.push(`<ParaStyle:å…³é”®è¯>â€¢ ${escXML(kw)}`);
    });
  }

  // å­—ä½“é¢œè‰²æ˜ å°„ï¼ˆæ¯ç§æ®µè½æ ·å¼å¯¹åº”çš„CMYKé¢œè‰²ï¼Œå¿…é¡»åœ¨CharacterStyleRangeä¸Šæ˜¾å¼æŒ‡å®šï¼‰
  const styleColorMap = {
    'chapter': 'Color/C=0 M=0 Y=0 K=60',
    'title':   'Color/C=0 M=0 Y=0 K=100',
    'body':    'Color/C=0 M=0 Y=0 K=85',
    'kw':      'Color/C=0 M=0 Y=0 K=80',
    'normal':  'Color/C=0 M=0 Y=0 K=100',
  };
  // å­—ä½“å¤§å°æ˜ å°„ï¼ˆå•ä½ï¼šptï¼‰
  const styleSizeMap = {
    'chapter': '9',
    'title':   '24',
    'body':    '18',
    'kw':      '14',
    'normal':  '18',
  };

  // æ„å»º Story XML
  // å…³é”®è§„åˆ™ï¼š
  // 1. ä½¿ç”¨ InDesign å†…ç½®æ ·å¼å $ID/NormalParagraphStyleï¼Œé¿å…è‡ªå®šä¹‰æ ·å¼åç§°è§£æå¤±è´¥
  // 2. <Br/> å¿…é¡»æ”¾åœ¨å•ç‹¬çš„ CharacterStyleRange å†…ï¼ˆä¸ InDesign è‡ªèº«å¯¼å‡ºæ ¼å¼ä¸€è‡´ï¼‰
  // 3. FillColor åœ¨ CharacterStyleRange ä¸Šæ˜¾å¼æŒ‡å®šé¢œè‰²
  const contentXML = lines.map(l => {
    const colonIdx = l.indexOf('>');
    const text = l.slice(colonIdx + 1);
    const styleName = l.slice('<ParaStyle:'.length, colonIdx);
    const styleId = styleNameToId(styleName);
    const fillColor = styleColorMap[styleId] || 'Color/C=0 M=0 Y=0 K=100';
    const ptSize = styleSizeMap[styleId] || '18';
    const isBold = (styleId === 'title' || styleId === 'kw');
    const fontStyle = isBold ? 'Bold' : 'Regular';
    // å­—ä½“å¿…é¡»æ”¾åœ¨ <Properties> å­å…ƒç´ é‡Œï¼ˆInDesign æ ‡å‡†æ ¼å¼ï¼‰ï¼Œä¸èƒ½ä½œä¸ºå±æ€§
    // AppliedCharacterStyle ç”¨ "[No character style]"ï¼ˆå¸¦æ–¹æ‹¬å·ï¼ŒInDesign å†…ç½®åç§°ï¼‰
    return `    <ParagraphStyleRange AppliedParagraphStyle="ParagraphStyle/$ID/NormalParagraphStyle">
      <CharacterStyleRange AppliedCharacterStyle="CharacterStyle/$ID/[No character style]"
        FontStyle="${fontStyle}" PointSize="${ptSize}"
        Leading="${Math.round(+ptSize * 1.5)}" FillColor="${fillColor}">
        <Properties>
          <AppliedFont type="string">Microsoft YaHei</AppliedFont>
        </Properties>
        <Content>${text}</Content>
      </CharacterStyleRange>
      <CharacterStyleRange AppliedCharacterStyle="CharacterStyle/$ID/[No character style]">
        <Br/>
      </CharacterStyleRange>
    </ParagraphStyleRange>`;
  }).join('\n');

  return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Story xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <Story Self="${storyId}" AppliedTOCStyle="n" TrackChanges="false" StoryTitle="${escXML(pd.title)}">
    <StoryPreference OpticalMarginAlignment="false" OpticalMarginSize="12" FrameType="TextFrameType" StoryOrientation="Horizontal" StoryDirection="LeftToRightDirection"/>
    <InCopyExportOption IncludeGraphicProxies="true" IncludeAllResources="false"/>
${contentXML}
  </Story>
</idPkg:Story>`;
}

function styleNameToId(name) {
  const map = { 'ç« èŠ‚æ ‡ç­¾':'chapter', 'é¡µé¢æ ‡é¢˜':'title', 'æ­£æ–‡':'body', 'å…³é”®è¯':'kw' };
  return map[name] || 'normal';
}

/* ================================================
   ç”Ÿæˆ Spread XMLï¼ˆé¡µé¢å¸ƒå±€ï¼šæ–‡å­—æ¡† + å›¾ç‰‡æ¡†ï¼‰
================================================ */
function buildSpreadXML(spreadId, pageId, textStoryId, pd, pageIndex, pw, ph, mg, cTop, cLeft, cBottom, cRight, cW, cH, imgStartIdx) {
  const pageItems = [];

  // æŒ‰é¡µé¢å¸ƒå±€æ”¾ç½®æ–‡å­—æ¡†å’Œå›¾ç‰‡æ¡†ï¼ˆæ¯é¡µåªæœ‰1ä¸ªæ–‡å­—æ¡†å¯¹åº”1ä¸ªStoryï¼‰
  const layout = pd.layout;

  // æ­£æ–‡åŒºä»å†…å®¹åŒºé¡¶éƒ¨å¼€å§‹
  const bodyTop    = cTop;
  const bodyLeft   = cLeft;
  const bodyBottom = cBottom;
  const bodyRight  = cRight;
  const bodyW      = cW;
  const bodyH      = cBottom - bodyTop;

  if (layout === 'text-right') {
    // å›¾ç‰‡åŒºï¼ˆå·¦57%ï¼‰+ æ–‡å­—åŒºï¼ˆå³43%ï¼‰
    const imgAreaW = bodyW * 0.57;
    const textAreaW = bodyW - imgAreaW - 8;
    const textAreaLeft = bodyLeft + imgAreaW + 8;
    // å¤§å›¾ï¼ˆå·¦ä¸Š65%é«˜åº¦ï¼‰
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_1`, bodyTop, bodyLeft, bodyTop + bodyH * 0.65, bodyLeft + imgAreaW, spreadId, pw, ph));
    // å°å›¾å·¦ï¼ˆä¸‹35%ï¼Œå·¦åŠï¼‰
    const smallTop = bodyTop + bodyH * 0.65 + 4;
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_2`, smallTop, bodyLeft, bodyBottom, bodyLeft + imgAreaW/2 - 2, spreadId, pw, ph));
    // å°å›¾å³ï¼ˆä¸‹35%ï¼Œå³åŠï¼‰
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_3`, smallTop, bodyLeft + imgAreaW/2 + 2, bodyBottom, bodyLeft + imgAreaW, spreadId, pw, ph));
    // å³ä¾§æ–‡å­—æ¡†ï¼ˆå¤ç”¨ textStoryId ä½†å•ç‹¬å¸§ï¼‰
    const rfId = `tf_${spreadId}_body`;
    pageItems.push(buildTextFrame(rfId, textStoryId, bodyTop, textAreaLeft, bodyBottom, bodyRight, spreadId, pw, ph));
  } else if (layout === 'text-right-grid') {
    // åŸºåœ°åˆ†æï¼š3åˆ—2è¡Œç½‘æ ¼+å³ä¾§æ–‡å­—
    const imgAreaW = bodyW * 0.67;
    const textAreaLeft = bodyLeft + imgAreaW + 8;
    const textAreaW = bodyRight - textAreaLeft;
    const gap = 4;
    const col1 = bodyLeft; const col2 = bodyLeft + imgAreaW/3 + gap; const col3 = bodyLeft + imgAreaW/3*2 + gap*2;
    const colW = imgAreaW/3 - gap;
    const row1H = bodyH * 0.58; const row2H = bodyH - row1H - gap;
    const row2Top = bodyTop + row1H + gap;
    // å¤§å›¾ï¼ˆè·¨å‰2åˆ—ï¼Œç¬¬1è¡Œï¼‰
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_1`, bodyTop, col1, bodyTop + row1H, col1 + colW*2 + gap, spreadId, pw, ph));
    // å³ä¾§æ–‡å­—è¦†ç›–åŒºï¼ˆç¬¬3åˆ—ï¼Œç¬¬1è¡Œï¼‰- æ–‡å­—æ¡†
    const rf2Id = `tf_${spreadId}_body`;
    pageItems.push(buildTextFrame(rf2Id, textStoryId, bodyTop, textAreaLeft, bodyBottom, bodyRight, spreadId, pw, ph));
    // ç¬¬2è¡Œ3ä¸ªå°å›¾
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_2`, row2Top, col1, bodyBottom, col1 + colW, spreadId, pw, ph));
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_3`, row2Top, col2, bodyBottom, col2 + colW, spreadId, pw, ph));
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_4`, row2Top, col3, bodyBottom, col3 + colW, spreadId, pw, ph));
  } else if (layout === 'text-left') {
    // å»ºç­‘åˆ†æï¼šæ–‡å­—ï¼ˆå·¦34%ï¼‰+ å›¾ç‰‡ç½‘æ ¼ï¼ˆå³66%ï¼‰
    const textAreaW = bodyW * 0.34;
    const imgAreaLeft = bodyLeft + textAreaW + 8;
    const imgW = bodyRight - imgAreaLeft;
    const rfId = `tf_${spreadId}_body`;
    pageItems.push(buildTextFrame(rfId, textStoryId, bodyTop, bodyLeft, bodyBottom, bodyLeft + textAreaW, spreadId, pw, ph));
    // å›¾ç‰‡ç½‘æ ¼ï¼šä¸Šå¤§å›¾ï¼ˆè·¨2åˆ—ï¼‰+ ä¸‹2å›¾
    const gap = 4;
    const col1 = imgAreaLeft; const col2 = imgAreaLeft + imgW/2 + gap/2;
    const colW = imgW/2 - gap/2;
    const row1H = bodyH * 0.57;
    const row2Top = bodyTop + row1H + gap;
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_1`, bodyTop, imgAreaLeft, bodyTop + row1H, bodyRight, spreadId, pw, ph));
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_2`, row2Top, col1, bodyBottom, col1 + colW, spreadId, pw, ph));
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_3`, row2Top, col2, bodyBottom, col2 + colW, spreadId, pw, ph));
  } else if (layout === 'grid-overlay') {
    // çµæ„Ÿæ¥æºï¼š2x2å›¾ç‰‡ç½‘æ ¼ + ä¸­å¤®æµ®åŠ¨æ–‡å­—æ¡†
    const gap = 6;
    const halfW = (bodyW - gap) / 2;
    const halfH = (bodyH - gap) / 2;
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_1`, bodyTop, bodyLeft, bodyTop + halfH, bodyLeft + halfW, spreadId, pw, ph));
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_2`, bodyTop, bodyLeft + halfW + gap, bodyTop + halfH, bodyRight, spreadId, pw, ph));
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_3`, bodyTop + halfH + gap, bodyLeft, bodyBottom, bodyLeft + halfW, spreadId, pw, ph));
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_4`, bodyTop + halfH + gap, bodyLeft + halfW + gap, bodyBottom, bodyRight, spreadId, pw, ph));
    // ä¸­å¤®æ–‡å­—å åŠ æ¡†
    const ovW = bodyW * 0.44; const ovH = bodyH * 0.4;
    const ovLeft = bodyLeft + (bodyW - ovW) / 2;
    const ovTop  = bodyTop  + (bodyH - ovH) / 2;
    const rfId = `tf_${spreadId}_overlay`;
    pageItems.push(buildTextFrame(rfId, textStoryId, ovTop, ovLeft, ovTop + ovH, ovLeft + ovW, spreadId, pw, ph));
  } else if (layout === 'text-top') {
    // è®¾è®¡ç†å¿µï¼šæ­£æ–‡åœ¨ä¸Š + ä¸‹æ–¹å·¦å¤§å›¾+å³2å›¾
    const textH = bodyH * 0.28;
    const imgTop = bodyTop + textH + 6;
    const rfId = `tf_${spreadId}_body`;
    pageItems.push(buildTextFrame(rfId, textStoryId, bodyTop, bodyLeft, bodyTop + textH, bodyRight, spreadId, pw, ph));
    const imgW_left = bodyW * 0.58; const imgW_right = bodyW - imgW_left - 6;
    const rightLeft = bodyLeft + imgW_left + 6;
    const halfH = (bodyH - textH - 6 - 4) / 2;
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_1`, imgTop, bodyLeft, bodyBottom, bodyLeft + imgW_left, spreadId, pw, ph));
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_2`, imgTop, rightLeft, imgTop + halfH, bodyRight, spreadId, pw, ph));
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_3`, imgTop + halfH + 4, rightLeft, bodyBottom, bodyRight, spreadId, pw, ph));
  } else if (layout === 'list-right') {
    // ä¸»é¢˜è½ä½ï¼šå¤§å›¾ï¼ˆå·¦65%ï¼‰+ åˆ†åŒºåˆ—è¡¨æ–‡å­—ï¼ˆå³35%ï¼‰
    const imgAreaW = bodyW * 0.63;
    const textAreaLeft = bodyLeft + imgAreaW + 8;
    pageItems.push(buildGraphicFrame(`gf_${spreadId}_1`, bodyTop, bodyLeft, bodyBottom, bodyLeft + imgAreaW, spreadId, pw, ph));
    const rfId = `tf_${spreadId}_body`;
    pageItems.push(buildTextFrame(rfId, textStoryId, bodyTop, textAreaLeft, bodyBottom, bodyRight, spreadId, pw, ph));
  }

  const pageItemsXML = pageItems.join('\n');

  return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Spread xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <Spread Self="${spreadId}" PageCount="1" BindingLocation="0" AllowPageShuffle="true">
    <FlattenerPreference LineArtAndTextResolution="300" GradientAndMeshResolution="150" ClipComplexRegions="false" ConvertAllStrokesToOutlines="false" ConvertAllTextToOutlines="false"/>
    <!-- é¡µé¢ä¸­å¿ƒåœ¨ Spread(0,0)ï¼ŒItemTransform = -pw/2, -ph/2ï¼ˆçœŸå® InDesign å¯¼å‡ºæ ¼å¼ï¼‰ -->
    <Page Self="${pageId}" MasterPageTransform="1 0 0 1 0 0" Name="${pageIndex + 1}" AppliedMaster="n"
      GeometricBounds="0 0 ${ph.toFixed(3)} ${pw.toFixed(3)}"
      ItemTransform="1 0 0 1 ${(-pw/2).toFixed(3)} ${(-ph/2).toFixed(3)}">
      <MarginPreference Top="${mg.toFixed(3)}" Bottom="${mg.toFixed(3)}" Left="${mg.toFixed(3)}" Right="${mg.toFixed(3)}" ColumnCount="1" ColumnGutter="14.4"/>
    </Page>
${pageItemsXML}
  </Spread>
</idPkg:Spread>`;
}

/* ---- åˆ›å»ºæ–‡å­—æ¡† ---- */
// top/left/bottom/rightï¼šé¡µé¢åæ ‡ï¼ˆmmÃ—2.834645ï¼ŒåŸç‚¹=é¡µé¢å·¦ä¸Šè§’ï¼‰
// pw/phï¼šé¡µé¢å°ºå¯¸ï¼ˆptï¼‰
// InDesign åæ ‡ç³»ï¼šé¡µé¢ä¸­å¿ƒåœ¨ Spread(0,0)ï¼ŒItemTransform æŒ‡å‘å¸§ä¸­å¿ƒ
// å¸§ä¸­å¿ƒåœ¨ Spread çš„åæ ‡ = é¡µé¢åæ ‡ä¸­å¿ƒ - é¡µé¢å°ºå¯¸çš„ä¸€åŠ
function buildTextFrame(selfId, storyId, top, left, bottom, right, spreadId, pw, ph) {
  const w  = right - left;
  const h  = bottom - top;
  const hw = (w / 2).toFixed(3);
  const hh = (h / 2).toFixed(3);
  // å¸§ä¸­å¿ƒåœ¨ Spread çš„åæ ‡
  const cx = ((left + right) / 2 - pw / 2).toFixed(3);
  const cy = ((top + bottom) / 2 - ph / 2).toFixed(3);
  return `    <TextFrame Self="${selfId}" ParentStory="${storyId}" PreviousTextFrame="n" NextTextFrame="n"
      ContentType="TextType" AppliedObjectStyle="ObjectStyle/$ID/[Normal Text Frame]"
      ItemTransform="1 0 0 1 ${cx} ${cy}"
      ItemLayer="lyr1">
      <Properties>
        <PathGeometry>
          <GeometryPathType PathOpen="false">
            <PathPointArray>
              <PathPointType Anchor="-${hw} -${hh}" LeftDirection="-${hw} -${hh}" RightDirection="-${hw} -${hh}"/>
              <PathPointType Anchor="-${hw} ${hh}"  LeftDirection="-${hw} ${hh}"  RightDirection="-${hw} ${hh}"/>
              <PathPointType Anchor="${hw} ${hh}"   LeftDirection="${hw} ${hh}"   RightDirection="${hw} ${hh}"/>
              <PathPointType Anchor="${hw} -${hh}"  LeftDirection="${hw} -${hh}"  RightDirection="${hw} -${hh}"/>
            </PathPointArray>
          </GeometryPathType>
        </PathGeometry>
      </Properties>
      <TextFramePreference TextColumnCount="1" TextColumnGutter="14.173"
        VerticalJustification="TopAlign" FirstBaselineOffset="EmboxHeight">
        <Properties>
          <InsetSpacing type="list">
            <ListItem type="unit">0</ListItem>
            <ListItem type="unit">0</ListItem>
            <ListItem type="unit">0</ListItem>
            <ListItem type="unit">0</ListItem>
          </InsetSpacing>
        </Properties>
      </TextFramePreference>
    </TextFrame>`;
}

/* ---- åˆ›å»ºå›¾ç‰‡æ¡†ï¼ˆç©ºå ä½ï¼ŒInDesign ä¸­å¯ç›´æ¥ç½®å…¥å›¾ç‰‡ï¼‰ ---- */
// åæ ‡ç³»åŒ buildTextFrameï¼šé¡µé¢ä¸­å¿ƒåœ¨ Spread(0,0)ï¼ŒItemTransform æŒ‡å‘å¸§ä¸­å¿ƒ
function buildGraphicFrame(selfId, top, left, bottom, right, spreadId, pw, ph) {
  const w  = right - left;
  const h  = bottom - top;
  const hw = (w / 2).toFixed(3);
  const hh = (h / 2).toFixed(3);
  const cx = ((left + right) / 2 - pw / 2).toFixed(3);
  const cy = ((top + bottom) / 2 - ph / 2).toFixed(3);
  return `    <Rectangle Self="${selfId}"
      ContentType="GraphicType" AppliedObjectStyle="ObjectStyle/$ID/[Normal Graphics Frame]"
      StrokeWeight="1" StrokeColor="Color/C=0 M=0 Y=0 K=15" FillColor="Color/None"
      ItemTransform="1 0 0 1 ${cx} ${cy}"
      ItemLayer="lyr1">
      <Properties>
        <PathGeometry>
          <GeometryPathType PathOpen="false">
            <PathPointArray>
              <PathPointType Anchor="-${hw} -${hh}" LeftDirection="-${hw} -${hh}" RightDirection="-${hw} -${hh}"/>
              <PathPointType Anchor="-${hw} ${hh}"  LeftDirection="-${hw} ${hh}"  RightDirection="-${hw} ${hh}"/>
              <PathPointType Anchor="${hw} ${hh}"   LeftDirection="${hw} ${hh}"   RightDirection="${hw} ${hh}"/>
              <PathPointType Anchor="${hw} -${hh}"  LeftDirection="${hw} -${hh}"  RightDirection="${hw} -${hh}"/>
            </PathPointArray>
          </GeometryPathType>
        </PathGeometry>
      </Properties>
    </Rectangle>`;
}

/* ================================================
   æœ€å°åŒ– IDML æµ‹è¯•ï¼ˆç”¨äºè¯Šæ–­ InDesign æ˜¯å¦èƒ½æ‰“å¼€ä»»ä½• IDMLï¼‰
   è¿™ä¸ªå‡½æ•°ç”Ÿæˆç»å¯¹æœ€ç®€å•çš„åˆæ³• IDMLï¼š
   ä¸€é¡µ A3 æ¨ªå‘ç©ºç™½æ–‡æ¡£ï¼Œåªæœ‰ä¸€è¡Œè‹±æ–‡æ–‡å­—ï¼Œæ— ä»»ä½•è‡ªå®šä¹‰æ ·å¼
   å¦‚æœè¿™ä¸ªæ–‡ä»¶ä¹Ÿæ— æ³•æ‰“å¼€ â†’ é—®é¢˜åœ¨ JSZip æˆ– InDesign å®‰è£…
   å¦‚æœè¿™ä¸ªæ–‡ä»¶å¯ä»¥æ‰“å¼€  â†’ é—®é¢˜åœ¨å®Œæ•´ç‰ˆ XML çš„æŸä¸ªç»†èŠ‚
================================================ */
async function testMinimalIDML() {
  const MM = 2.834645;
  const pwN = 420 * MM, phN = 297 * MM, mgN = 20 * MM;
  const pw = pwN.toFixed(3); // 1190.551ptï¼ˆA3æ¨ªå‘å®½ï¼‰
  const ph = phN.toFixed(3); // 841.890ptï¼ˆA3æ¨ªå‘é«˜ï¼‰
  const mg = mgN.toFixed(3); // 56.693ptï¼ˆè¾¹è·ï¼‰
  // æ–‡å­—æ¡†ä»è¾¹è·åˆ°å¯¹è¾¹ï¼ˆå…¨å†…å®¹åŒºï¼‰
  // å¸§ä¸­å¿ƒåœ¨é¡µé¢ä¸­å¿ƒ = pwN/2, phN/2ï¼›åœ¨Spreadåæ ‡ç³»ä¸­å¿ƒå‡å»é¡µé¢åŠå°ºå¯¸ = (0, 0)
  const tfCX = '0';                            // æ–‡å­—æ¡†ä¸­å¿ƒ Spread X = pwN/2 - pwN/2
  const tfCY = '0';                            // æ–‡å­—æ¡†ä¸­å¿ƒ Spread Y = phN/2 - phN/2
  const tfHW = ((pwN - 2*mgN)/2).toFixed(3);  // æ–‡å­—æ¡†åŠå®½
  const tfHH = ((phN - 2*mgN)/2).toFixed(3);  // æ–‡å­—æ¡†åŠé«˜

  const entries = [];

  // 1. mimetypeï¼ˆå¿…é¡»ç¬¬ä¸€ä¸ªã€ä¸å‹ç¼©ï¼‰
  entries.push({ name: 'mimetype', data: 'application/vnd.adobe.indesign-idml-package' });

  // 2. META-INF/container.xml
  entries.push({ name: 'META-INF/container.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<container xmlns="urn:oasis:names:tc:opendocument:xmlns:container" version="1.0">
  <rootfiles>
    <rootfile full-path="designmap.xml" media-type="application/vnd.adobe.indesign-idml-package"/>
  </rootfiles>
</container>` });

  // 3. XML/Tags.xml
  entries.push({ name: 'XML/Tags.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Tags xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
</idPkg:Tags>` });

  // 4. XML/BackingStory.xml
  entries.push({ name: 'XML/BackingStory.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Story xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <XmlStory Self="u_bs" AppliedTOCStyle="n" TrackChanges="false" StoryTitle="$ID/NullString">
    <StoryPreference OpticalMarginAlignment="false" OpticalMarginSize="12" FrameType="TextFrameType" StoryOrientation="Horizontal" StoryDirection="LeftToRightDirection"/>
    <InCopyExportOption IncludeGraphicProxies="true" IncludeAllResources="false"/>
  </XmlStory>
</idPkg:Story>` });

  // 5. Resources/Fonts.xmlï¼ˆç©ºï¼‰
  entries.push({ name: 'Resources/Fonts.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Fonts xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
</idPkg:Fonts>` });

  // 6. Resources/Graphic.xml - é¢œè‰² Self ID ç”¨ InDesign æ ‡å‡†æ ¼å¼ "Color/Black"
  entries.push({ name: 'Resources/Graphic.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Graphic xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <ColorGroup Self="u_cg" Name="$ID/">
    <Color Self="Color/Black" Name="Black" Model="Process" Space="CMYK" ColorValue="0 0 0 100" IsSpot="false"/>
    <Color Self="Color/None"  Name="$ID/None" Model="Process" Space="CMYK" ColorValue="0 0 0 0" IsSpot="false"/>
  </ColorGroup>
</idPkg:Graphic>` });

  // 7. Resources/Styles.xml - å®Œå…¨åŒ¹é…çœŸå® InDesign å¯¼å‡ºæ ¼å¼ï¼š
  //   - "[No paragraph style]" æ ¹æ ·å¼å®šä¹‰ FillColor="Color/Black"ï¼ˆæ–‡å­—é¢œè‰²æ¥æºï¼‰
  //   - "[No character style]" æ˜¯ InDesign å†…ç½®å¿…éœ€æ ·å¼åï¼ˆå¸¦æ–¹æ‹¬å·ï¼‰
  //   - ObjectStyle åç§°å¸¦æ–¹æ‹¬å·
  entries.push({ name: 'Resources/Styles.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Styles xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <RootCharacterStyleGroup Self="u_csg">
    <CharacterStyle Self="CharacterStyle/$ID/[No character style]" Name="$ID/[No character style]"/>
  </RootCharacterStyleGroup>
  <RootParagraphStyleGroup Self="u_psg">
    <ParagraphStyle Self="ParagraphStyle/$ID/[No paragraph style]"
      Name="$ID/[No paragraph style]" FillColor="Color/Black">
      <Properties>
        <Leading type="enumeration">Auto</Leading>
      </Properties>
    </ParagraphStyle>
    <ParagraphStyle Self="ParagraphStyle/$ID/NormalParagraphStyle"
      Name="$ID/NormalParagraphStyle" NextStyle="ParagraphStyle/$ID/NormalParagraphStyle">
      <Properties>
        <BasedOn type="string">$ID/[No paragraph style]</BasedOn>
      </Properties>
    </ParagraphStyle>
  </RootParagraphStyleGroup>
  <RootTableStyleGroup Self="u_tsg">
    <TableStyle Self="TableStyle/$ID/[No table style]" Name="$ID/[No table style]"/>
  </RootTableStyleGroup>
  <RootCellStyleGroup Self="u_cellsg">
    <CellStyle Self="CellStyle/$ID/[None]" Name="$ID/[None]"/>
  </RootCellStyleGroup>
  <RootObjectStyleGroup Self="u_osg">
    <ObjectStyle Self="ObjectStyle/$ID/[None]"                Name="$ID/[None]"/>
    <ObjectStyle Self="ObjectStyle/$ID/[Normal Text Frame]"   Name="$ID/[Normal Text Frame]">
      <Properties><BasedOn type="string">$ID/[None]</BasedOn></Properties>
    </ObjectStyle>
    <ObjectStyle Self="ObjectStyle/$ID/[Normal Graphics Frame]" Name="$ID/[Normal Graphics Frame]">
      <Properties><BasedOn type="string">$ID/[None]</BasedOn></Properties>
    </ObjectStyle>
    <ObjectStyle Self="ObjectStyle/$ID/[Normal Grid]"         Name="$ID/[Normal Grid]">
      <Properties><BasedOn type="string">$ID/[None]</BasedOn></Properties>
    </ObjectStyle>
  </RootObjectStyleGroup>
</idPkg:Styles>` });

  // 8. Resources/Preferences.xml
  entries.push({ name: 'Resources/Preferences.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Preferences xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <DocumentPreference PageWidth="${pw}" PageHeight="${ph}" FacingPages="false" AllowPageShuffle="true" DocumentBleedTopOffset="0" DocumentBleedBottomOffset="0" DocumentBleedInsideOrLeftOffset="0" DocumentBleedOutsideOrRightOffset="0"/>
  <MarginPreference Top="${mg}" Bottom="${mg}" Left="${mg}" Right="${mg}" ColumnCount="1" ColumnGutter="14.4"/>
</idPkg:Preferences>` });

  // 9. Stories/Story_u_s1.xml
  // å­—ä½“æ”¾åœ¨ <Properties> å­å…ƒç´ ï¼ŒAppliedCharacterStyle ç”¨ "[No character style]"
  entries.push({ name: 'Stories/Story_u_s1.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Story xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <Story Self="u_s1" AppliedTOCStyle="n" TrackChanges="false" StoryTitle="Test">
    <StoryPreference OpticalMarginAlignment="false" OpticalMarginSize="12" FrameType="TextFrameType" StoryOrientation="Horizontal" StoryDirection="LeftToRightDirection"/>
    <InCopyExportOption IncludeGraphicProxies="true" IncludeAllResources="false"/>
    <ParagraphStyleRange AppliedParagraphStyle="ParagraphStyle/$ID/NormalParagraphStyle">
      <CharacterStyleRange AppliedCharacterStyle="CharacterStyle/$ID/[No character style]"
        PointSize="24" Leading="32">
        <Content>Hello InDesign - Test</Content>
      </CharacterStyleRange>
      <CharacterStyleRange AppliedCharacterStyle="CharacterStyle/$ID/[No character style]">
        <Br/>
      </CharacterStyleRange>
    </ParagraphStyleRange>
  </Story>
</idPkg:Story>` });

  // 10. Spreads/Spread_u_sp1.xml
  // Page ItemTransform = -pw/2, -ph/2ï¼ˆçœŸå® InDesign æ ¼å¼ï¼šé¡µé¢ä¸­å¿ƒåœ¨ Spread åŸç‚¹ï¼‰
  // TextFrame ä½¿ç”¨ PathGeometryï¼ŒItemTransform æŒ‡å‘å¸§ä¸­å¿ƒ
  entries.push({ name: 'Spreads/Spread_u_sp1.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Spread xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <Spread Self="u_sp1" PageCount="1" BindingLocation="0" AllowPageShuffle="true">
    <FlattenerPreference LineArtAndTextResolution="300" GradientAndMeshResolution="150" ClipComplexRegions="false" ConvertAllStrokesToOutlines="false" ConvertAllTextToOutlines="false"/>
    <Page Self="u_pg1" Name="1" AppliedMaster="n"
      MasterPageTransform="1 0 0 1 0 0"
      GeometricBounds="0 0 ${ph} ${pw}"
      ItemTransform="1 0 0 1 ${(-pwN/2).toFixed(3)} ${(-phN/2).toFixed(3)}">
      <MarginPreference Top="${mg}" Bottom="${mg}" Left="${mg}" Right="${mg}" ColumnCount="1" ColumnGutter="14.4"/>
    </Page>
    <TextFrame Self="u_tf1" ParentStory="u_s1" PreviousTextFrame="n" NextTextFrame="n"
      ContentType="TextType" AppliedObjectStyle="ObjectStyle/$ID/[Normal Text Frame]"
      ItemTransform="1 0 0 1 ${tfCX} ${tfCY}"
      ItemLayer="u_lyr1">
      <Properties>
        <PathGeometry>
          <GeometryPathType PathOpen="false">
            <PathPointArray>
              <PathPointType Anchor="-${tfHW} -${tfHH}" LeftDirection="-${tfHW} -${tfHH}" RightDirection="-${tfHW} -${tfHH}"/>
              <PathPointType Anchor="-${tfHW} ${tfHH}"  LeftDirection="-${tfHW} ${tfHH}"  RightDirection="-${tfHW} ${tfHH}"/>
              <PathPointType Anchor="${tfHW} ${tfHH}"   LeftDirection="${tfHW} ${tfHH}"   RightDirection="${tfHW} ${tfHH}"/>
              <PathPointType Anchor="${tfHW} -${tfHH}"  LeftDirection="${tfHW} -${tfHH}"  RightDirection="${tfHW} -${tfHH}"/>
            </PathPointArray>
          </GeometryPathType>
        </PathGeometry>
      </Properties>
      <TextFramePreference TextColumnCount="1" TextColumnGutter="14.173"
        VerticalJustification="TopAlign" FirstBaselineOffset="EmboxHeight">
        <Properties>
          <InsetSpacing type="list">
            <ListItem type="unit">0</ListItem>
            <ListItem type="unit">0</ListItem>
            <ListItem type="unit">0</ListItem>
            <ListItem type="unit">0</ListItem>
          </InsetSpacing>
        </Properties>
      </TextFramePreference>
    </TextFrame>
  </Spread>
</idPkg:Spread>` });

  // 11. designmap.xml
  // å…³é”®ï¼šå¿…é¡»æœ‰ <?aid?> å¤„ç†æŒ‡ä»¤ï¼ŒInDesign ç”¨å®ƒè¯†åˆ« IDML åŒ…çš„æ–‡æ¡£ç±»å‹
  // FeatureSet æ”¾åœ¨ <?aid?> é‡Œï¼Œä¸æ˜¯ Document å±æ€§ï¼ˆæ¥è‡ªçœŸå® InDesign å¯¼å‡ºå¯¹æ¯”ï¼‰
  entries.push({ name: 'designmap.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<?aid style="50" type="document" readerVersion="6.0" featureSet="257" product="19.0(151)" ?>
<Document xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging"
  DOMVersion="19.0" Self="d" ActiveLayer="u_lyr1" StoryList="u_s1"
  Name="untitled-1" ZeroPoint="0 0">
  <idPkg:Fonts src="Resources/Fonts.xml"/>
  <idPkg:Styles src="Resources/Styles.xml"/>
  <idPkg:Preferences src="Resources/Preferences.xml"/>
  <idPkg:Graphic src="Resources/Graphic.xml"/>
  <Layer Self="u_lyr1" Name="Layer 1" Visible="true" Locked="false"
    IgnoreWrap="false" ShowGuides="true" LockGuides="false"
    UI="true" Expendable="true" Printable="true"/>
  <idPkg:Spread src="Spreads/Spread_u_sp1.xml"/>
  <idPkg:BackingStory src="XML/BackingStory.xml"/>
  <idPkg:Tags src="XML/Tags.xml"/>
  <idPkg:Story src="Stories/Story_u_s1.xml"/>
</Document>` });

  try {
    const zipBytes = await buildZipStore(entries);

    /* ---- è¯Šæ–­ï¼šè¾“å‡º ZIP å¤´å­—èŠ‚åˆ°æ§åˆ¶å°ï¼Œä¾›å¼€å‘è€…åˆ†æ ---- */
    const hexLines = [];
    for (let i = 0; i < Math.min(zipBytes.length, 256); i += 16) {
      const slice = zipBytes.slice(i, i + 16);
      const hex  = Array.from(slice).map(b => b.toString(16).padStart(2,'0').toUpperCase()).join(' ');
      const ascii = Array.from(slice).map(b => (b >= 32 && b < 127) ? String.fromCharCode(b) : '.').join('');
      hexLines.push(`${String(i).padStart(4,'0')}: ${hex.padEnd(47)}  ${ascii}`);
    }
    console.group('=== IDML ZIP è¯Šæ–­è¾“å‡ºï¼ˆè¯·æˆªå›¾æˆ–å¤åˆ¶å‘ç»™å¼€å‘è€…ï¼‰===');
    console.log('æ–‡ä»¶æ€»å¤§å°:', zipBytes.length, 'å­—èŠ‚');
    console.log('å‰4å­—èŠ‚ç­¾åï¼ˆæ­£ç¡®åº”ä¸º 50 4B 03 04ï¼‰:',
      Array.from(zipBytes.slice(0,4)).map(b=>b.toString(16).padStart(2,'0').toUpperCase()).join(' '));
    console.log('ç¬¬27-28å­—èŠ‚ extra field é•¿åº¦ï¼ˆåº”ä¸º 00 00ï¼‰:',
      Array.from(zipBytes.slice(28,30)).map(b=>b.toString(16).padStart(2,'0').toUpperCase()).join(' '));
    console.log('æ–‡ä»¶ååŒºï¼ˆç¬¬30å­—èŠ‚èµ·ï¼Œåº”ä¸º "mimetype"ï¼‰:',
      String.fromCharCode(...zipBytes.slice(30, 38)));
    console.log('\n--- å®Œæ•´ HEX DUMPï¼ˆå‰256å­—èŠ‚ï¼‰---');
    console.log(hexLines.join('\n'));
    console.groupEnd();

    const blob = new Blob([zipBytes], { type: 'application/zip' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'test_minimal.idml';
    a.click();
    URL.revokeObjectURL(url);
    toast('å·²å¯¼å‡º + åœ¨ F12 æ§åˆ¶å°è¾“å‡ºè¯Šæ–­ä¿¡æ¯');
  } catch(e) {
    toast('ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
    console.error(e);
  }
}

/* ================================================
   Toast é€šçŸ¥
================================================ */
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => el.classList.remove('show'), 2800);
}
</script>
</body>
</html>
