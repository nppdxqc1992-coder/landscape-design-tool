<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>景观设计文本排版工具 v2</title>
<!-- PDF.js：用于从PDF文件中提取文字内容（拖入PDF自动识别文字） -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
/* ============================================================
   全局 & CSS 变量
============================================================ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg:       #f5f5f7;
  --panel:    #ffffff;
  --border:   #d2d2d7;
  --text-1:   #1d1d1f;
  --text-2:   #6e6e73;
  --text-3:   #aeaeb2;
  --accent:   #0071e3;
  --green:    #34c759;
  --radius:   12px;
  --r-sm:     8px;
  --nav-h:    50px;
  --left-w:   400px;
}
html, body {
  height: 100%; overflow: hidden;
  font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
  background: var(--bg); color: var(--text-1); font-size: 14px;
}

/* ============================================================
   顶部导航栏
============================================================ */
.topnav {
  position: fixed; top: 0; left: 0; right: 0; height: var(--nav-h);
  background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; z-index: 100;
  padding: 0 20px; gap: 0;
}
.nav-brand { font-size: 14px; font-weight: 700; color: var(--text-1); margin-right: 24px; white-space: nowrap; }
.nav-brand span { font-size: 11px; background: var(--accent); color: #fff; border-radius: 20px; padding: 2px 7px; margin-left: 6px; font-weight: 600; }

/* 章节标签 */
.nav-tabs { display: flex; align-items: stretch; gap: 2px; flex: 1; }
.nav-tab {
  display: flex; align-items: center; gap: 7px;
  padding: 0 16px; height: var(--nav-h); cursor: pointer;
  font-size: 13px; color: var(--text-2); font-weight: 500;
  border-bottom: 2px solid transparent; transition: all 0.15s;
  white-space: nowrap; position: relative;
}
.nav-tab:hover { color: var(--text-1); }
.nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.nav-tab .tab-num {
  width: 20px; height: 20px; border-radius: 50%;
  background: var(--bg); color: var(--text-2);
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700;
}
.nav-tab.active .tab-num { background: var(--accent); color: #fff; }
.nav-tab.done .tab-num { background: var(--green); color: #fff; }
.nav-tab .tab-optional {
  font-size: 10px; color: var(--text-3); background: var(--bg);
  padding: 1px 6px; border-radius: 10px;
}

/* 导航右侧按钮区 */
.nav-actions { display: flex; align-items: center; gap: 8px; margin-left: auto; }
.api-status { display: flex; align-items: center; gap: 5px; font-size: 12px; color: var(--text-2); }
.api-dot { width: 7px; height: 7px; border-radius: 50%; background: #c7c7cc; }
.api-dot.ok { background: var(--green); }

/* 按钮 */
.btn { display: inline-flex; align-items: center; gap: 5px; padding: 7px 14px; border-radius: var(--r-sm); border: none; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.15s; font-family: inherit; }
.btn-ghost { background: transparent; color: var(--text-2); border: 1px solid var(--border); }
.btn-ghost:hover { background: var(--bg); }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: #0077ed; }
.btn-primary:disabled { background: var(--border); color: var(--text-3); cursor: not-allowed; }
.btn-dark { background: #1d1d1f; color: #fff; }
.btn-dark:hover { background: #3a3a3c; }
.btn-dark:disabled { background: var(--border); color: var(--text-3); cursor: not-allowed; }
.btn-green { background: var(--green); color: #fff; }
.btn-green:hover { background: #30b353; }

/* ============================================================
   主布局：左对话 + 右预览
============================================================ */
.app-body {
  display: flex; height: 100vh; padding-top: var(--nav-h);
}

/* ---- 左侧对话/控制面板 ---- */
.left-panel {
  width: var(--left-w); flex-shrink: 0;
  background: var(--panel); border-right: 1px solid var(--border);
  display: flex; flex-direction: column; overflow: hidden;
}

/* ---- 右侧预览区 ---- */
.right-panel {
  flex: 1; background: #e5e5ea; overflow: auto;
  display: flex; flex-direction: column;
}

/* ============================================================
   左侧面板：各屏幕内容
============================================================ */
.screen { display: none; flex-direction: column; height: 100%; }
.screen.active { display: flex; }

/* ---- 面板标题区 ---- */
.panel-head {
  padding: 16px 20px 12px; border-bottom: 1px solid var(--bg);
  flex-shrink: 0;
}
.panel-head-title { font-size: 15px; font-weight: 700; margin-bottom: 3px; }
.panel-head-sub { font-size: 12px; color: var(--text-2); }

/* ---- 子标签（前期分析用） ---- */
.sub-tabs { display: flex; padding: 10px 20px; gap: 6px; flex-shrink: 0; border-bottom: 1px solid var(--bg); }
.sub-tab {
  flex: 1; padding: 6px 4px; text-align: center; border-radius: var(--r-sm);
  font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.15s;
  color: var(--text-2); background: var(--bg); border: none;
}
.sub-tab.active { background: var(--accent); color: #fff; }
.sub-tab.done::after { content: ' ✓'; }

/* ---- 设计构思方案选择卡片 ---- */
.concept-opts-bar { padding: 12px 16px 8px; flex-shrink: 0; border-bottom: 1px solid var(--bg); }
.concept-opts-bar .opts-hint { font-size: 11px; color: var(--text-3); margin-bottom: 8px; }
.concept-opts-bar .opts-row { display: flex; gap: 8px; }
.concept-opt {
  flex: 1; padding: 9px 8px 8px; border-radius: 10px; border: 1.5px solid var(--border);
  cursor: pointer; text-align: center; transition: all 0.2s; background: var(--surface);
}
.concept-opt:hover { border-color: var(--accent); }
.concept-opt.active { border-color: var(--accent); background: rgba(0,122,255,0.07); }
.concept-opt .copt-num { font-size: 10px; color: var(--text-3); margin-bottom: 4px; }
.concept-opt .copt-name { font-size: 13px; font-weight: 700; color: var(--text-1); letter-spacing: 3px; }

/* ---- 对话区 ---- */
.chat-history {
  flex: 1; overflow-y: auto; padding: 16px 20px;
  display: flex; flex-direction: column; gap: 14px;
}
/* 空状态 */
.chat-empty { text-align: center; padding: 40px 20px; color: var(--text-3); }
.chat-empty svg { margin-bottom: 12px; opacity: 0.4; display: block; margin-left: auto; margin-right: auto; }
.chat-empty p { font-size: 13px; line-height: 1.7; }

/* 消息气泡 */
.msg { display: flex; flex-direction: column; gap: 4px; }
.msg.user { align-items: flex-end; }
.msg.ai { align-items: flex-start; }
.msg-bubble {
  max-width: 85%; padding: 10px 14px; border-radius: 16px;
  font-size: 13px; line-height: 1.65;
}
.msg.user .msg-bubble { background: var(--accent); color: #fff; border-bottom-right-radius: 4px; }
.msg.ai   .msg-bubble { background: var(--bg); color: var(--text-1); border-bottom-left-radius: 4px; }
.msg-time { font-size: 10px; color: var(--text-3); padding: 0 4px; }

/* AI 思考状态 */
.msg-thinking .msg-bubble { color: var(--text-3); font-style: italic; }
.msg-thinking .dots::after { content: '...'; animation: blink 1s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }


/* ---- 底部输入区 ---- */
.chat-input-area {
  padding: 12px 16px; border-top: 1px solid var(--border);
  flex-shrink: 0; background: #fff;
}
.chat-input-wrap {
  display: flex; gap: 8px; align-items: flex-end;
  background: var(--bg); border: 1.5px solid var(--border);
  border-radius: var(--radius); padding: 8px 10px;
  transition: border-color 0.15s;
}
.chat-input-wrap:focus-within { border-color: var(--accent); }
.chat-input {
  flex: 1; border: none; background: transparent; outline: none;
  font-size: 13px; line-height: 1.5; resize: none;
  font-family: inherit; color: var(--text-1); max-height: 120px;
}
.chat-input::placeholder { color: var(--text-3); }
.btn-send {
  width: 32px; height: 32px; border-radius: 8px; border: none;
  background: var(--accent); color: #fff; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s; flex-shrink: 0;
}
.btn-send:hover { background: #0077ed; }
.btn-send:disabled { background: var(--border); cursor: not-allowed; }

/* 底部操作按钮组 */
.input-actions { display: flex; gap: 6px; margin-top: 8px; }
.btn-apply {
  flex: 1; padding: 8px; border-radius: var(--r-sm); border: none;
  background: var(--green); color: #fff; font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all 0.15s; font-family: inherit;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}
.btn-apply:hover { background: #30b353; }
.btn-apply:disabled { background: var(--border); color: var(--text-3); cursor: not-allowed; }
.btn-clear-chat { padding: 8px 12px; border-radius: var(--r-sm); border: 1px solid var(--border); background: #fff; color: var(--text-2); font-size: 12px; cursor: pointer; }
.btn-clear-chat:hover { background: var(--bg); }
/* 换一批方案按钮 */
.btn-regen { padding: 8px 12px; border-radius: var(--r-sm); border: 1.5px solid var(--accent); background: #fff; color: var(--accent); font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
.btn-regen:hover { background: rgba(0,122,255,0.07); }
.btn-regen:disabled { border-color: var(--border); color: var(--text-3); cursor: not-allowed; background: #fff; }

/* ============================================================
   屏幕1：项目信息
============================================================ */
.project-form { flex: 1; overflow-y: auto; padding: 20px; }
.form-section { margin-bottom: 20px; }
.form-section-title { font-size: 11px; font-weight: 700; color: var(--text-3); letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 10px; }
.form-row { margin-bottom: 10px; }
.form-row:last-child { margin-bottom: 0; }
.form-label { font-size: 12px; color: var(--text-2); margin-bottom: 5px; display: flex; align-items: center; justify-content: space-between; }
.form-label .optional { font-size: 10px; color: var(--text-3); }
.form-input, .form-textarea, .form-select {
  width: 100%; border: 1.5px solid var(--border); border-radius: var(--r-sm);
  padding: 8px 11px; font-size: 13px; font-family: inherit; color: var(--text-1);
  background: #fff; outline: none; transition: border-color 0.15s;
}
.form-input:focus, .form-textarea:focus { border-color: var(--accent); }
.form-textarea { resize: vertical; min-height: 80px; line-height: 1.6; }
.form-textarea.lg { min-height: 160px; }

/* 输入模式切换 */
.mode-toggle { display: flex; gap: 4px; margin-bottom: 8px; }
.mode-btn {
  flex: 1; padding: 6px 4px; text-align: center; border-radius: 6px;
  font-size: 12px; cursor: pointer; transition: all 0.15s;
  color: var(--text-2); background: var(--bg); border: 1.5px solid transparent;
}
.mode-btn.active { background: #eaf3ff; color: var(--accent); border-color: var(--accent); font-weight: 600; }

/* 文件上传区 */
.upload-zone {
  border: 1.5px dashed var(--border); border-radius: var(--r-sm);
  padding: 24px 16px; text-align: center; cursor: pointer;
  background: var(--bg); transition: all 0.15s;
}
.upload-zone:hover { border-color: var(--accent); background: #eaf3ff; }
.upload-zone svg { margin-bottom: 6px; color: var(--text-3); }
.upload-zone p { font-size: 12px; color: var(--text-2); }
.upload-hint { margin-top: 6px; font-size: 11px; color: var(--green); display: none; }

/* 项目信息底部操作 */
.project-footer {
  padding: 14px 20px; border-top: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
  flex-shrink: 0; background: #fff;
}

/* ============================================================
   右侧预览面板
============================================================ */
.preview-header {
  position: sticky; top: 0; z-index: 10;
  background: rgba(229,229,234,0.9); backdrop-filter: blur(8px);
  padding: 8px 20px; display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid rgba(0,0,0,0.06);
}
.preview-header-left { display: flex; align-items: center; gap: 10px; }
.preview-label { font-size: 12px; color: #666; font-weight: 500; }
.zoom-ctrl { display: flex; align-items: center; gap: 3px; }
.zoom-btn { width: 26px; height: 26px; border-radius: 6px; border: 1px solid rgba(0,0,0,0.12); background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #555; }
.zoom-btn:hover { background: var(--bg); }
.zoom-val { font-size: 12px; color: #666; min-width: 36px; text-align: center; }

/* 全屏按钮 */
.btn-fullscreen {
  width: 28px; height: 28px; border-radius: 6px; border: 1px solid rgba(0,0,0,0.12);
  background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;
  color: #555; transition: all 0.15s; flex-shrink: 0;
}
.btn-fullscreen:hover { background: var(--bg); color: var(--text-1); }

/* 全屏状态下：预览区铺满，toolbar 固定顶部 */
#right-panel:fullscreen {
  overflow: auto;
  background: #e5e5ea;
}
#right-panel:fullscreen .preview-header {
  position: sticky;
  top: 0;
  z-index: 10;
  background: rgba(229,229,234,0.95);
}

.pages-wrap { padding: 24px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
.page-wrap { position: relative; }
.page-num-label { position: absolute; left: -34px; top: 50%; transform: translateY(-50%); font-size: 11px; color: #999; font-weight: 500; }

/* A3 预览页 */
.a3-page { background: #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.12); border-radius: 2px; overflow: hidden; position: relative; flex-shrink: 0; }

/* 预览空状态 */
.preview-empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; gap: 12px; }
.preview-empty-state svg { opacity: 0.25; }
.preview-empty-state p { font-size: 13px; color: #bbb; }

/* 图片占位槽：中性灰，无颜色倾向 */
.img-slot { background: #ebebeb; border: 1px dashed #c7c7cc; border-radius: 3px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; transition: all 0.15s; }
.img-slot:hover { border-color: #888; background: #e0e0e0; }

/* ============================================================
   设置弹窗
============================================================ */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; display: none; align-items: center; justify-content: center; }
.modal-overlay.open { display: flex; }
.modal { background: #fff; border-radius: 16px; width: 380px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
.modal-head { padding: 18px 20px; border-bottom: 1px solid var(--bg); display: flex; align-items: center; justify-content: space-between; }
.modal-head h3 { font-size: 15px; font-weight: 600; }
.modal-close { width: 28px; height: 28px; border-radius: 50%; border: none; background: var(--bg); cursor: pointer; font-size: 16px; color: var(--text-2); display: flex; align-items: center; justify-content: center; }
.modal-body { padding: 16px 20px; }
.modal-foot { padding: 12px 20px 18px; display: flex; justify-content: flex-end; gap: 8px; }
.provider-tabs { display: flex; gap: 5px; margin-bottom: 12px; }
.provider-tab { flex: 1; padding: 7px; border: 1.5px solid var(--border); border-radius: 7px; background: #fff; font-size: 12px; cursor: pointer; text-align: center; color: var(--text-2); font-weight: 500; transition: all 0.15s; }
.provider-tab.active { border-color: var(--accent); background: #eaf3ff; color: var(--accent); }

/* ============================================================
   Toast
============================================================ */
#toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(10px); background: rgba(29,29,31,0.9); backdrop-filter: blur(10px); color: #fff; font-size: 13px; padding: 9px 18px; border-radius: 20px; opacity: 0; transition: all 0.25s; z-index: 300; pointer-events: none; white-space: nowrap; }
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ============================================================
   三合一原始资料上传区
============================================================ */
.raw-upload-wrap {
  border: 1.5px dashed var(--border);
  border-radius: var(--r-sm);
  transition: border-color 0.15s, background 0.15s;
  overflow: hidden;
}
.raw-upload-wrap.drag-over {
  border-color: var(--accent);
  background: #eaf3ff;
}
.raw-upload-wrap .raw-textarea {
  border: none !important;
  border-radius: 0;
  min-height: 130px;
  background: transparent;
  resize: vertical;
}
.raw-upload-wrap .raw-textarea:focus { outline: none; }
.raw-hints {
  display: flex; align-items: center; gap: 5px;
  padding: 5px 10px;
  border-top: 1px solid var(--bg);
  font-size: 11px; color: var(--text-3);
}
.raw-hint-sep { color: var(--border); margin: 0 2px; }

/* ============================================================
   滚动条
============================================================ */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #c7c7cc; border-radius: 10px; }
</style>
</head>
<body>

<!-- ====== 顶部导航 ====== -->
<nav class="topnav">
  <div class="nav-brand">景观设计排版工具 <span>v2</span></div>

  <div class="nav-tabs">
    <div class="nav-tab active" id="tab-project" onclick="switchScreen('project')">
      <div class="tab-num">1</div> 项目信息
    </div>
    <div class="nav-tab" id="tab-analysis" onclick="switchScreen('analysis')">
      <div class="tab-num">2</div> 前期分析
    </div>
    <div class="nav-tab" id="tab-strategy" onclick="switchScreen('strategy')">
      <div class="tab-num">3</div> 设计策略
    </div>
    <div class="nav-tab" id="tab-concept" onclick="switchScreen('concept')">
      <div class="tab-num">4</div> 设计构思
    </div>
    <div class="nav-tab" id="tab-preview" onclick="switchScreen('preview')">
      <div class="tab-num">5</div> 全部预览
    </div>
  </div>

  <div class="nav-actions">
    <div class="api-status">
      <div class="api-dot" id="api-dot"></div>
      <span id="api-label">未配置 API</span>
    </div>
    <button class="btn btn-ghost" onclick="openSettings()">设置</button>
    <button class="btn btn-dark" id="btn-export" onclick="exportIDML()" disabled>导出 IDML</button>
  </div>
</nav>

<!-- ====== 主体布局 ====== -->
<div class="app-body">

  <!-- ========== 左侧面板 ========== -->
  <div class="left-panel">

    <!-- ---- 屏幕1：项目信息 ---- -->
    <div class="screen active" id="screen-project">
      <div class="panel-head">
        <div class="panel-head-title">项目基础信息</div>
        <div class="panel-head-sub">填写完成后，AI 将在各章节中自动引用这些信息</div>
      </div>

      <div class="project-form">

        <!-- ① 原始资料（置顶） -->
        <div class="form-section">
          <div class="form-section-title">原始资料</div>
          <!-- 三合一上传区：拖文件 / 粘贴文字 / Ctrl+V截图 均在此操作 -->
          <div class="raw-upload-wrap" id="raw-upload-wrap">
            <textarea class="form-textarea raw-textarea" id="raw-text"
              placeholder="直接粘贴文字（规划指标、建筑说明、设计任务书…）"></textarea>
            <div class="raw-hints">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
              拖入 TXT 文件
              <span class="raw-hint-sep">·</span>
              PDF 请复制文字后粘贴
              <span class="raw-hint-sep">·</span>
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
              Ctrl+V 粘贴截图
            </div>
            <div id="img-preview-area" style="display:none;padding:6px 10px 8px;border-top:1px solid var(--bg);"></div>
          </div>
          <div id="raw-file-status" style="display:none;font-size:11px;color:var(--green);margin-top:5px;"></div>
        </div>

        <!-- ② 一键生成按钮 -->
        <div class="form-section" style="padding-bottom:0;">
          <button class="btn btn-primary" id="btn-auto-gen" onclick="autoExtractAndGenerate()"
            style="width:100%;justify-content:center;padding:11px;font-size:14px;gap:7px;">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            AI 一键提取信息 · 生成全套文案
          </button>
          <div id="gen-progress" style="display:none;margin-top:8px;padding:9px 12px;background:var(--bg);border-radius:8px;font-size:12px;color:var(--text-2);text-align:center;line-height:1.6;"></div>
        </div>

        <!-- ③ 项目基础信息（AI提取后自动填写，可手动修改） -->
        <div class="form-section" style="margin-top:16px;">
          <div class="form-section-title" style="display:flex;align-items:center;gap:6px;">
            项目基础信息
            <span style="font-size:10px;font-weight:400;color:var(--text-3);text-transform:none;letter-spacing:0;">AI 提取后自动填入，可手动修改</span>
          </div>
          <div class="form-row">
            <label class="form-label">项目名称</label>
            <input class="form-input" id="proj-name" placeholder="AI 提取后自动填入">
          </div>
          <div class="form-row">
            <label class="form-label">项目地点</label>
            <input class="form-input" id="proj-location" placeholder="AI 提取后自动填入">
          </div>
          <div class="form-row">
            <label class="form-label">项目类型</label>
            <input class="form-input" id="proj-type" placeholder="AI 提取后自动填入">
          </div>
          <div class="form-row">
            <label class="form-label">甲方要求 <span class="optional">选填</span></label>
            <textarea class="form-textarea" id="proj-client" placeholder="AI 提取后自动填入（如有）" rows="2"></textarea>
          </div>
        </div>

      </div>

      <div class="project-footer">
        <span style="font-size:12px;color:var(--text-3)" id="proj-footer-hint">粘贴资料后点击生成按钮</span>
        <button class="btn btn-ghost" onclick="switchScreen('analysis')">查看分析结果 →</button>
      </div>
    </div>

    <!-- ---- 屏幕2：前期分析 ---- -->
    <div class="screen" id="screen-analysis">
      <div class="panel-head">
        <div class="panel-head-title">前期分析</div>
        <div class="panel-head-sub">区位、现状、建筑、工程概况，DeepSeek 思考型推荐</div>
      </div>

      <!-- 子标签 -->
      <div class="sub-tabs" id="analysis-subtabs">
        <button class="sub-tab active" id="asub-location" onclick="switchAnalysisTab('location')">区位分析</button>
        <button class="sub-tab" id="asub-site"     onclick="switchAnalysisTab('site')">场地现状</button>
        <button class="sub-tab" id="asub-building" onclick="switchAnalysisTab('building')">建筑分析</button>
        <button class="sub-tab" id="asub-general"  onclick="switchAnalysisTab('general')">工程概况</button>
      </div>

      <!-- 对话历史 -->
      <div class="chat-history" id="chat-analysis">
        <div class="chat-empty">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <p>向 AI 描述这个章节的要点<br>或直接发送「开始分析」让 AI 基于项目信息自动生成</p>
        </div>
      </div>

      <!-- 输入区 -->
      <div class="chat-input-area">
        <div class="chat-input-wrap">
          <textarea class="chat-input" id="input-analysis" placeholder="输入问题或修改指令…按 Enter 发送，Shift+Enter 换行" rows="1" onkeydown="handleEnter(event,'analysis')" oninput="autoResize(this)"></textarea>
          <button class="btn-send" onclick="sendMsg('analysis')" id="send-analysis">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
        <div class="input-actions">
          <button class="btn-apply" id="apply-analysis" onclick="applyChapter('analysis')" disabled>应用到预览</button>
          <button class="btn-clear-chat" onclick="clearChat('analysis')">清空对话</button>
        </div>
      </div>
    </div>

    <!-- ---- 屏幕3：设计策略（可选） ---- -->
    <div class="screen" id="screen-strategy">
      <div class="panel-head">
        <div class="panel-head-title">设计策略 <span style="font-size:11px;color:var(--text-3);font-weight:400;">（可选章节）</span></div>
        <div class="panel-head-sub">针对场地问题，逻辑推导景观设计的最优解</div>
      </div>

      <div class="chat-history" id="chat-strategy">
        <div class="chat-empty">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          <p>描述场地核心问题<br>AI 将推导对应的景观策略<br><br>如不需要此章节，可在项目信息页取消勾选</p>
        </div>
      </div>

      <div class="chat-input-area">
        <div class="chat-input-wrap">
          <textarea class="chat-input" id="input-strategy" placeholder="描述场地问题或修改策略方向…" rows="1" onkeydown="handleEnter(event,'strategy')" oninput="autoResize(this)"></textarea>
          <button class="btn-send" onclick="sendMsg('strategy')" id="send-strategy">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
        <div class="input-actions">
          <button class="btn-apply" id="apply-strategy" onclick="applyChapter('strategy')" disabled>应用到预览</button>
          <button class="btn-clear-chat" onclick="clearChat('strategy')">清空对话</button>
        </div>
      </div>
    </div>

    <!-- ---- 屏幕4：设计构思 ---- -->
    <div class="screen" id="screen-concept">
      <div class="panel-head">
        <div class="panel-head-title">设计构思</div>
        <div class="panel-head-sub">语言模型 + 图像生成，共同完成理念图与设计主题</div>
      </div>

      <!-- 子标签：文字 / 图像 -->
      <div class="sub-tabs">
        <button class="sub-tab active" id="csub-text" onclick="switchConceptTab('text')">文字构思</button>
        <button class="sub-tab" id="csub-image" onclick="switchConceptTab('image')">理念图生成</button>
      </div>

      <!-- 文字构思对话 -->
      <div id="concept-text-panel" style="display:flex;flex-direction:column;flex:1;overflow:hidden;">
        <!-- 三个方案选择卡片（一键生成后出现） -->
        <div class="concept-opts-bar" id="concept-opts-bar" style="display:none;">
          <div class="opts-hint">点击选中一个方向 · 选中后在下方对话框进一步优化 · 不满意可在下方输入新要求后点「换一批」</div>
          <div class="opts-row">
            <div class="concept-opt active" id="copt-0" onclick="selectConceptOption(0)">
              <div class="copt-num">方案一</div>
              <div class="copt-name" id="copt-name-0">——</div>
            </div>
            <div class="concept-opt" id="copt-1" onclick="selectConceptOption(1)">
              <div class="copt-num">方案二</div>
              <div class="copt-name" id="copt-name-1">——</div>
            </div>
            <div class="concept-opt" id="copt-2" onclick="selectConceptOption(2)">
              <div class="copt-num">方案三</div>
              <div class="copt-name" id="copt-name-2">——</div>
            </div>
          </div>
        </div>
        <div class="chat-history" id="chat-concept">
          <div class="chat-empty">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            <p>描述你的设计灵感方向<br>或发送「生成设计构思」让 AI 自由发挥<br>多轮对话直到满意为止</p>
          </div>
        </div>
        <div class="chat-input-area">
          <div class="chat-input-wrap">
            <textarea class="chat-input" id="input-concept" placeholder="选中方案后在此输入优化要求…或填写新需求后点「换一批方案」" rows="1" onkeydown="handleEnter(event,'concept')" oninput="autoResize(this)"></textarea>
            <button class="btn-send" onclick="sendMsg('concept')" id="send-concept">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
          </div>
          <div class="input-actions">
            <!-- 换一批方案：重新生成三个选项 tabs -->
            <button class="btn-regen" id="btn-regen-concept" onclick="regenConceptOptions()" title="根据输入框的要求重新生成三个方案">换一批方案</button>
            <button class="btn-apply" id="apply-concept" onclick="applyChapter('concept')" disabled>应用到预览</button>
            <button class="btn-clear-chat" onclick="clearChat('concept')">清空对话</button>
          </div>
        </div>
      </div>

      <!-- 图像生成面板（占位） -->
      <div id="concept-image-panel" style="display:none;flex:1;padding:20px;overflow-y:auto;">
        <div style="background:var(--bg);border-radius:var(--radius);padding:16px;margin-bottom:14px;">
          <div style="font-size:12px;font-weight:600;color:var(--text-2);margin-bottom:8px;">图像生成模型</div>
          <select class="form-select" id="image-model-select" style="font-size:12px;">
            <option value="doubao">豆包（即梦 AI）</option>
            <option value="comfyui">ComfyUI（本地）</option>
            <option value="placeholder">更多模型接入中…</option>
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">上传参考图 <span class="optional">可传多张</span></label>
          <div class="upload-zone" onclick="document.getElementById('ref-image-input').click()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            <p>上传参考图、意向图</p>
          </div>
          <input type="file" id="ref-image-input" accept="image/*" multiple style="display:none">
        </div>
        <div class="form-row">
          <label class="form-label">生图提示词</label>
          <textarea class="form-textarea" id="image-prompt" placeholder="将由文字构思对话自动填充，也可手动修改…" rows="4"></textarea>
        </div>
        <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:4px;" onclick="toast('图像生成功能接入中，敬请期待')">
          生成理念图（功能开发中）
        </button>
      </div>
    </div>

    <!-- ---- 屏幕5：全部预览 ---- -->
    <div class="screen" id="screen-preview">
      <div class="panel-head">
        <div class="panel-head-title">全部预览 · 最终调整</div>
        <div class="panel-head-sub">对右侧任意页面截图，在此输入修改指令</div>
      </div>

      <div class="chat-history" id="chat-preview">
        <div class="chat-empty">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
          <p>在此对话可直接修改任意页面内容<br>可截图右侧某区域后输入「修改这里的文字为…」</p>
        </div>
      </div>

      <div class="chat-input-area">
        <div class="chat-input-wrap">
          <textarea class="chat-input" id="input-preview" placeholder="截图某区域，描述修改内容…" rows="1" onkeydown="handleEnter(event,'preview')" oninput="autoResize(this)"></textarea>
          <button class="btn-send" onclick="sendMsg('preview')" id="send-preview">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
        <div style="margin-top:8px;">
          <button class="btn btn-dark" style="width:100%;justify-content:center;" onclick="exportIDML()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            导出 IDML → InDesign
          </button>
        </div>
      </div>
    </div>

  </div><!-- /left-panel -->

  <!-- ========== 右侧预览区 ========== -->
  <div class="right-panel" id="right-panel">
    <div class="preview-header">
      <div class="preview-header-left">
        <span class="preview-label" id="preview-label">A3 横向预览</span>
        <div class="zoom-ctrl">
          <button class="zoom-btn" onclick="doZoom(-1)">−</button>
          <span class="zoom-val" id="zoom-txt">40%</span>
          <button class="zoom-btn" onclick="doZoom(1)">+</button>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span style="font-size:11px;color:#999;">共 <span id="pg-count">0</span> 页</span>
        <button class="btn-fullscreen" id="btn-fullscreen" onclick="toggleFullscreen()" title="全屏预览">
          <svg id="fs-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- 空状态 -->
    <div class="preview-empty-state" id="preview-empty">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.8"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
      <p>各章节生成并应用后将在此显示</p>
    </div>

    <!-- 页面容器 -->
    <div class="pages-wrap" id="pages-wrap" style="display:none"></div>
  </div>

</div><!-- /app-body -->

<!-- ====== 设置弹窗 ====== -->
<div class="modal-overlay" id="settings-modal" onclick="if(event.target===this)closeSettings()">
  <div class="modal">
    <div class="modal-head">
      <h3>API 设置</h3>
      <button class="modal-close" onclick="closeSettings()">×</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <label class="form-label">AI 提供商</label>
        <div class="provider-tabs">
          <div class="provider-tab active" id="prov-deepseek" onclick="setProvider('deepseek')">DeepSeek</div>
          <div class="provider-tab" id="prov-doubao"   onclick="setProvider('doubao')">豆包</div>
          <div class="provider-tab" id="prov-openai"   onclick="setProvider('openai')">OpenAI</div>
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">API Key</label>
        <input class="form-input" id="api-key-input" type="password" placeholder="输入 API Key">
      </div>
      <div class="form-row" id="endpoint-row" style="display:none">
        <label class="form-label">模型端点 ID <span class="optional">豆包专用</span></label>
        <input class="form-input" id="endpoint-input" placeholder="ep-20241231-xxxxx">
      </div>
      <div class="form-row">
        <label class="form-label">模型</label>
        <select class="form-select" id="model-select">
          <option value="deepseek-chat">deepseek-chat（推荐）</option>
          <option value="deepseek-reasoner">deepseek-reasoner（思考型）</option>
        </select>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeSettings()">取消</button>
      <button class="btn btn-primary" onclick="saveSettings()">保存</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* ============================================================
   全局状态
============================================================ */
const S = {
  zoom: 0.4,
  pageW: 420, pageH: 297, pageMargin: 20,
  apiKey: '', provider: 'deepseek', model: 'deepseek-chat', endpoint: '',
  inputMode: 'text',
  currentScreen: 'project',
  analysisTab: 'location',
  conceptTab: 'text',
  conceptOptions: [],       // 三个构思方案 [{theme_name,content,keywords,zones}, ...]
  selectedConceptIdx: 0,    // 当前选中的方案序号

  // 项目信息
  info: { name:'', location:'', type:'', client:'', rawText:'', imageData: null },

  // 多轮对话历史（每个 key 存 API messages 数组：{role,content}）
  // 前期分析四个子标签各自独立；preview 为自由对话
  chats: { location:[], site:[], building:[], general:[], strategy:[], concept:[], preview:[] },

  // 各章节聊天 DOM 缓存（切换标签时还原）
  chatHTML: { location:'', site:'', building:'', general:'', strategy:'', concept:'' },

  // AI 最新一次返回的解析结果（供"应用"按钮读取）
  rawResponses: { location:null, site:null, building:null, general:null, strategy:null, concept:null },

  // 各章节已应用到预览的内容
  applied: {
    location: null, site: null, building: null, general: null,
    strategy: null,
    concept: null, theme: null,
  },
};

/* ============================================================
   初始化
============================================================ */
document.addEventListener('DOMContentLoaded', () => {
  loadSettings();
  initUploadHandlers();
  // 配置 PDF.js Worker（CDN版本需与主库一致）
  const pdfLib = window['pdfjs-dist/build/pdf'];
  if (pdfLib) {
    pdfLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }
});

/* ============================================================
   屏幕切换
============================================================ */
function switchScreen(name) {
  S.currentScreen = name;

  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`tab-${name}`).classList.add('active');

  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(`screen-${name}`).classList.add('active');

  if (name === 'analysis') {
    switchAnalysisTab(S.analysisTab);
    return;
  }

  if (name === 'strategy' || name === 'concept') {
    syncAppliedUI(name);
    // 恢复聊天 DOM（一键生成后切换到此标签时能看到内容）
    const chatEl = document.getElementById(`chat-${name}`);
    if (chatEl && S.chatHTML[name]) {
      chatEl.innerHTML = S.chatHTML[name];
    }
  }

  updatePreview(name);
}

/* 同步按钮状态：有 AI 回复即可点"应用到预览" */
function syncAppliedUI(chapter) {
  const key = chapter === 'analysis' ? S.analysisTab : chapter;
  const hasChat = S.chats[key]?.some(m => m.role === 'assistant');
  const applyBtn = document.getElementById(`apply-${chapter}`);
  if (applyBtn) applyBtn.disabled = !hasChat;
}

/* ============================================================
   前期分析子标签切换
============================================================ */
const ANALYSIS_TABS = [
  { id: 'location', label: '区位分析' },
  { id: 'site',     label: '场地现状' },
  { id: 'building', label: '建筑分析' },
  { id: 'general',  label: '工程概况' },
];

const ANALYSIS_EMPTY = {
  location: '发送「开始分析」，AI 将结合原始资料深度解读区位价值\n\n也可以直接描述你关注的区位特点，展开讨论',
  site:     '发送「开始分析」，AI 将梳理场地现状条件与设计机遇\n\n也可以描述你注意到的特殊场地要素',
  building: '发送「开始分析」，AI 将分析建筑产品特征对景观的影响\n\n也可以指出你认为需要重点关注的建筑界面问题',
  general:  '发送「开始分析」，AI 将从原始资料中提取规划指标数据\n\n也可以直接提供具体数值',
};

function switchAnalysisTab(tab) {
  const chatEl = document.getElementById('chat-analysis');
  // 只在子标签之间切换时保存当前 DOM（tab !== S.analysisTab）
  // 初次进入分析页时 tab === S.analysisTab，不保存，避免空白 DOM 覆盖一键生成的内容
  if (tab !== S.analysisTab) {
    S.chatHTML[S.analysisTab] = chatEl.innerHTML;
  }

  S.analysisTab = tab;
  ANALYSIS_TABS.forEach(t => {
    document.getElementById(`asub-${t.id}`).classList.toggle('active', t.id === tab);
    document.getElementById(`asub-${t.id}`).classList.toggle('done', !!S.applied[t.id]);
  });

  // 恢复聊天 DOM：有历史→恢复；有生成内容但无对话→显示"已生成"提示；否则空状态
  if (S.chatHTML[tab]) {
    chatEl.innerHTML = S.chatHTML[tab];
  } else if (S.applied[tab]) {
    chatEl.innerHTML = `<div class="chat-empty">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="1.5"><polyline points="20 6 9 17 4 12"/></svg>
      <p style="color:var(--text-2);">「${S.applied[tab].title||''}」已生成<br>右侧预览已更新，可在下方输入修改指令</p>
    </div>`;
  } else {
    chatEl.innerHTML = `<div class="chat-empty"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><p>${ANALYSIS_EMPTY[tab]}</p></div>`;
  }

  // 同步已应用区域
  syncAppliedUI('analysis');

  // 按钮状态：有 AI 回复即可点"应用到预览"
  const hasAIReply = S.chats[tab]?.some(m => m.role === 'assistant');
  document.getElementById('apply-analysis').disabled = !hasAIReply;

  updatePreview('analysis');
}

/* ============================================================
   设计构思——切换三个构思方案
   点击卡片：高亮选中 → 更新聊天区 → 更新预览（概念页+理念分区页）
============================================================ */
function selectConceptOption(idx) {
  const opts = S.conceptOptions;
  if (!opts || idx >= opts.length) return;
  S.selectedConceptIdx = idx;

  // 更新卡片高亮
  [0, 1, 2].forEach(i => document.getElementById(`copt-${i}`)?.classList.toggle('active', i === idx));

  const opt = opts[idx];

  // 更新聊天区显示为选中方案的内容
  const chatMsg = opt.theme_name ? `**${opt.theme_name}**\n\n${opt.content || ''}` : (opt.content || '');
  S.chats.concept = [{ role: 'assistant', content: chatMsg }];
  S.chatHTML.concept = _buildChatMsgHTML(chatMsg);
  const chatEl = document.getElementById('chat-concept');
  if (chatEl) chatEl.innerHTML = S.chatHTML.concept;

  // 更新 applied：概念页 + 理念分区页
  S.applied.concept = { title: '设计构思', ...opt };
  if (opt.zones?.length) {
    S.applied.theme = { title: '设计理念', theme_name: opt.theme_name, zones: opt.zones };
  } else {
    // 当前方案暂无 zones（换一批时轻量生成），后台补充
    _bgGenZones(opt, idx);
  }

  // 启用应用按钮 + 刷新预览
  document.getElementById('apply-concept')?.removeAttribute('disabled');
  renderPreviewPages();
}

/* ============================================================
   换一批方案：根据输入框要求重新生成三个构思方案（更新 tabs）
   与普通"发送"区分——发送 = 优化当前选中方案；换一批 = 生成三个新选项
============================================================ */
async function regenConceptOptions() {
  const input   = document.getElementById('input-concept');
  const userReq = input.value.trim();
  if (!userReq) { toast('请先在输入框描述你的新方向要求'); return; }
  if (!S.apiKey) { toast('请先设置 API Key'); return; }

  const btn = document.getElementById('btn-regen-concept');
  btn.disabled = true; btn.textContent = '生成中…';

  // 显示方案栏
  const bar = document.getElementById('concept-opts-bar');
  if (bar) bar.style.display = 'block';

  // 在聊天区展示用户输入
  addMsg('concept', 'user', userReq);
  input.value = ''; input.style.height = '';

  // 占位 thinking 泡
  const chatEl = document.getElementById('chat-concept');
  const thinking = document.createElement('div');
  thinking.className = 'msg ai';
  thinking.innerHTML = '<div class="msg-bubble" style="color:var(--text-3)">正在生成三个方案…</div>';
  chatEl.appendChild(thinking); chatEl.scrollTop = chatEl.scrollHeight;

  const projName = document.getElementById('proj-name')?.value?.trim()     || '';
  const projLoc  = document.getElementById('proj-location')?.value?.trim() || '';
  const projType = document.getElementById('proj-type')?.value?.trim()     || '';
  const rawFull  = document.getElementById('raw-text')?.value?.trim()      || '';
  // 大幅缩短背景资料，减少 token
  const rawSnip  = rawFull.length > 800 ? rawFull.slice(0, 800) + '…' : rawFull;

  // ── 轻量版 prompt：只要主题名+60字简述+关键词，不含 zones（速度提升 ~60%） ──
  const regenPrompt = `你是景观设计文案师。
项目：${projName}｜地点：${projLoc}｜类型：${projType}
${rawSnip ? `资料节选：${rawSnip}\n` : ''}设计师要求：${userReq}

生成3个完全不同的构思方案，只返回JSON数组，不要其他文字：
[
  {"theme_name":"四字主题①（地域文化/山水画/诗词，不可通用）","content":"50-70字：主题来源+与项目关联","keywords":["搜图词1","搜图词2","搜图词3"]},
  {"theme_name":"四字主题②（与①完全不同角度）","content":"50-70字","keywords":["词1","词2","词3"]},
  {"theme_name":"四字主题③（第三种文化视角）","content":"50-70字","keywords":["词1","词2","词3"]}
]
三个主题须完全不同，各有鲜明地域文化辨识度。`;

  try {
    const raw = await callAI([{ role:'user', content: regenPrompt }], true);
    thinking.remove();

    const m = raw.match(/\[[\s\S]*\]/);
    if (!m) throw new Error('返回格式有误，请重试');
    const opts = JSON.parse(m[0]);
    if (!Array.isArray(opts) || opts.length === 0) throw new Error('未生成有效方案');

    S.conceptOptions = opts;
    S.selectedConceptIdx = 0;

    // 更新三个 tab 卡片名称
    opts.forEach((opt, i) => {
      const nameEl = document.getElementById(`copt-name-${i}`);
      if (nameEl) nameEl.textContent = opt.theme_name || `方案${i+1}`;
    });
    [0,1,2].forEach(i => document.getElementById(`copt-${i}`)?.classList.toggle('active', i===0));

    // 选中并展示第一个方案
    selectConceptOption(0);
    toast('已生成三个新方案，点击选择');

    // 后台静默补充第一个方案的 zones（不阻塞交互）
    _bgGenZones(opts[0], 0);

  } catch(err) {
    thinking.remove();
    addMsg('concept', 'ai', `⚠️ 生成失败：${err.message}\n\n请检查网络或 API Key 后重试。`);
    toast('生成失败：' + err.message);
  }

  btn.disabled = false; btn.textContent = '换一批方案';
}

/* ============================================================
   后台补充分区 zones（换一批方案后轻量生成，不阻塞交互）
   完成后静默更新 S.conceptOptions[idx] 及理念页预览
============================================================ */
async function _bgGenZones(opt, idx) {
  if (opt.zones?.length) return; // 已有 zones，跳过
  if (!S.apiKey) return;

  const projLoc = document.getElementById('proj-location')?.value?.trim() || '';
  const prompt  = `根据景观设计构思主题"${opt.theme_name}"（地点：${projLoc}），
为该主题生成5-6个有文化意境的景区分区名称，只返回JSON数组：
[{"name":"景区名（2-4字）","note":"与主题关联（6-8字）"}]
只输出JSON数组，不要其他文字。`;

  try {
    const raw   = await callAI([{ role:'user', content: prompt }], true);
    const m     = raw.match(/\[[\s\S]*\]/);
    if (!m) return;
    const zones = JSON.parse(m[0]);
    if (!Array.isArray(zones) || zones.length === 0) return;

    // 写回 conceptOptions
    if (S.conceptOptions[idx]) S.conceptOptions[idx].zones = zones;

    // 若当前选中正好是这个方案，立即更新理念页预览
    if (S.selectedConceptIdx === idx) {
      if (S.applied.theme) S.applied.theme.zones = zones;
      else S.applied.theme = { title:'设计理念', theme_name: opt.theme_name, zones };
      renderPreviewPages();
    }
  } catch (_) { /* 后台静默失败，不影响主流程 */ }
}

/* ============================================================
   设计构思子标签切换
============================================================ */
function switchConceptTab(tab) {
  S.conceptTab = tab;
  document.getElementById('csub-text').classList.toggle('active', tab === 'text');
  document.getElementById('csub-image').classList.toggle('active', tab === 'image');
  document.getElementById('concept-text-panel').style.display  = tab === 'text'  ? 'flex' : 'none';
  document.getElementById('concept-image-panel').style.display = tab === 'image' ? 'block' : 'none';
}

/* ============================================================
   对话发送入口
============================================================ */
function sendMsg(chapter) {
  const input = document.getElementById(`input-${chapter}`);
  const text = input.value.trim();
  if (!text) return;
  addMsg(chapter, 'user', text);
  input.value = '';
  input.style.height = '';
  sendToAI(chapter, text);
}

function handleEnter(e, chapter) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(chapter); }
}

function autoResize(el) {
  el.style.height = ''; el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

/* 添加消息气泡到 DOM（纯展示，不写状态） */
function addMsg(chapter, role, text) {
  const history = document.getElementById(`chat-${chapter}`);
  history.querySelector('.chat-empty')?.remove();
  const time = new Date().toLocaleTimeString('zh-CN', { hour:'2-digit', minute:'2-digit' });
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  // 支持基础 Markdown 渲染：标题 / 粗体 / 列表 / 分割线 / 换行
  const html = text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/^#{3}\s+(.+)$/gm,  '<strong style="font-size:13px;color:var(--text-1);">$1</strong>')
    .replace(/^#{1,2}\s+(.+)$/gm,'<strong style="font-size:14px;color:var(--text-1);">$1</strong>')
    .replace(/\*\*(.*?)\*\*/g,   '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g,       '<em>$1</em>')
    .replace(/^[-•·]\s+(.+)$/gm, '<span style="display:block;padding-left:12px;position:relative;"><span style="position:absolute;left:2px;">·</span>$1</span>')
    .replace(/^\d+\.\s+(.+)$/gm, '<span style="display:block;padding-left:16px;">$&</span>')
    .replace(/^---+$/gm,         '<hr style="border:none;border-top:1px solid var(--border);margin:8px 0;">')
    .replace(/\n/g, '<br>');
  div.innerHTML = `<div class="msg-bubble">${html}</div><div class="msg-time">${time}</div>`;
  history.appendChild(div);
  history.scrollTop = history.scrollHeight;
}

/* 添加"思考中"气泡，返回元素引用 */
function addThinking(chapter) {
  const history = document.getElementById(`chat-${chapter}`);
  const div = document.createElement('div');
  div.className = 'msg ai msg-thinking';
  div.innerHTML = `<div class="msg-bubble"><span class="dots">思考中</span></div>`;
  history.appendChild(div);
  history.scrollTop = history.scrollHeight;
  return div;
}

/* ============================================================
   真实 AI 调用
============================================================ */
async function sendToAI(chapter, userText) {
  // 前期分析：chapter='analysis'，实际用子标签 key
  const key = chapter === 'analysis' ? S.analysisTab : chapter;

  if (!S.apiKey) {
    addMsg(chapter, 'ai', '请先点击右上角「设置」，填入 API Key 后再使用 AI 功能。');
    return;
  }

  const btn = document.getElementById(`send-${chapter}`);
  if (btn) btn.disabled = true;

  const thinking = addThinking(chapter);

  // 构建消息列表：system + 历史多轮 + 本次用户消息
  const messages = [
    { role: 'system', content: buildSystemPrompt(key) },
    ...S.chats[key],
    { role: 'user', content: userText },
  ];

  try {
    // 自由对话模式：不强制 JSON，让 AI 自然表达专业意见
    const raw = await callAI(messages, false);
    thinking.remove();

    // 存入多轮对话历史
    S.chats[key].push({ role: 'user',      content: userText });
    S.chats[key].push({ role: 'assistant', content: raw });

    // 直接展示 AI 的完整回复（支持 Markdown）
    addMsg(chapter, 'ai', raw);

    // 有 AI 回复即可点"应用到预览"
    const applyBtn = document.getElementById(`apply-${chapter}`);
    if (applyBtn) applyBtn.disabled = false;

  } catch (err) {
    thinking.remove();
    addMsg(chapter, 'ai', `请求失败：${err.message}\n\n请检查 API Key 或网络后重试。`);
  }

  if (btn) btn.disabled = false;
}

/* ---- 格式化 AI 回复用于展示 ---- */
function formatAIReply(key, raw) {
  try {
    const m = raw.match(/\{[\s\S]*\}/);
    const d = JSON.parse(m ? m[0] : raw);

    if (key === 'concept') {
      const c = d.concept || d;
      const t = d.theme || {};
      return `**${c.title||'设计构思'}**\n${c.content||''}\n\n关键词：${(c.keywords||[]).join('、')}\n\n---\n**${t.title||'设计理念'}**\n${t.content||''}\n\n内容已生成，点击「应用到预览」查看效果。`;
    }
    if (key === 'strategy') {
      const items = (d.items||[]).map((it,i)=>`${String.fromCharCode(65+i)}. **${it.name}**：${it.desc}`).join('\n');
      return `**${d.title||'设计策略'}**\n\n${items}\n\n点击「应用到预览」查看效果。`;
    }
    // 分析类
    const title = d.title || '';
    const content = d.content || '';
    const kws = d.keywords || [];
    return `**${title}**\n\n${content}${kws.length ? '\n\n关键词：' + kws.join('、') : ''}\n\n如需调整，请告诉我修改方向。`;
  } catch {
    return raw; // 非 JSON 则原样展示（preview 章节）
  }
}

/* ---- DeepSeek / OpenAI 兼容 API 调用 ---- */
async function callAI(messages, jsonMode = true) {
  if (!S.apiKey) throw new Error('未配置 API Key');

  // deepseek-reasoner 不支持 response_format，其余模型在 jsonMode 时启用
  const useJsonFmt = jsonMode && S.model !== 'deepseek-reasoner';

  let url, headers, body;
  if (S.provider === 'deepseek') {
    url     = 'https://api.deepseek.com/chat/completions';
    headers = { 'Content-Type':'application/json', 'Authorization':'Bearer '+S.apiKey };
    body    = { model: S.model, messages, ...(useJsonFmt ? {response_format:{type:'json_object'}} : {}) };
  } else if (S.provider === 'doubao') {
    url     = 'https://ark.cn-beijing.volces.com/api/v3/chat/completions';
    headers = { 'Content-Type':'application/json', 'Authorization':'Bearer '+S.apiKey };
    body    = { model: S.endpoint || S.model, messages };
  } else {
    url     = 'https://api.openai.com/v1/chat/completions';
    headers = { 'Content-Type':'application/json', 'Authorization':'Bearer '+S.apiKey };
    body    = { model: S.model, messages, ...(useJsonFmt ? {response_format:{type:'json_object'}} : {}) };
  }

  const resp = await fetch(url, { method:'POST', headers, body:JSON.stringify(body) });
  if (!resp.ok) {
    const e = await resp.json().catch(() => ({ error:{ message:'HTTP '+resp.status } }));
    throw new Error(e.error?.message || 'HTTP '+resp.status);
  }
  const d = await resp.json();
  return d.choices[0].message.content;
}

/* ============================================================
   System Prompt 构建——确立 AI 的专业身份与项目上下文
   核心原则：先自由对话深度探讨，再由"应用"按钮单独提取结构化数据
============================================================ */
function buildSystemPrompt(key) {
  const name    = document.getElementById('proj-name')?.value?.trim()     || '';
  const loc     = document.getElementById('proj-location')?.value?.trim() || '';
  const type    = document.getElementById('proj-type')?.value?.trim()     || '';
  const client  = document.getElementById('proj-client')?.value?.trim()   || '';
  const rawText = document.getElementById('raw-text')?.value?.trim()      || '';

  // 项目背景（每次对话都携带）
  const projBlock = [
    '【项目信息】',
    name   ? `· 项目名称：${name}`   : null,
    loc    ? `· 项目地点：${loc}`    : null,
    type   ? `· 项目类型：${type}`   : null,
    client ? `· 甲方要求：${client}` : null,
  ].filter(Boolean).join('\n');

  const rawBlock = rawText
    ? `\n\n【原始资料（建筑文本 / 设计任务书 / 规划指标）】\n${rawText}`
    : '\n\n（暂无原始资料，请根据项目信息合理推断，并在回复中注明推断依据）';

  // ── 核心角色定义（所有章节共用）──
  const coreRole = `你是一位拥有15年经验的资深景观设计师，长期服务于高端住宅景观方案设计，精通中国古典园林美学与现代景观语言的融合，熟悉甲方汇报逻辑、规划合规要求与成本控制思维。

你目前在协助设计师完成一份住宅景观概念方案文本。设计师会向你描述想法、提供资料、提出修改意见，你们共同通过对话打磨出高质量的专业文案。

**对话方式：**
- 用专业、流畅的中文自然交流，像真正的设计同行一样分析问题、提出建议、深化理念
- 不要每次都机械地输出格式化结构，先充分讨论，设计师满意后自行点击「应用到预览」提取内容
- 回答要有深度——可以引用设计理论、文化典故、类比案例，帮助设计师拔高设计高度
- 如果原始资料中有具体数据（如退线、绿地率、户型信息），请在分析中引用这些数据
- 可以主动提问、反问、提出优化建议，引导设计师深入思考

${projBlock}${rawBlock}`;

  // ── 各章节专项引导 ──
  const guides = {
    location: `\n\n**当前章节：区位分析**

区位分析的价值：向读者（甲方、评审）阐明项目所处的宏观区位优势、交通便利性、周边配套资源及城市发展价值，为整个方案建立"选址有眼光"的认知基础。

好的区位分析不只是罗列数据，而是讲清楚"这里为什么值得"。请从原始资料中提炼关键信息，如资料不足可结合项目地点的实际情况进行专业推断，语言客观有据，适当体现区位价值主张。

**【输出格式要求——必须遵守】**
直接用 1-4 个编号要点输出，每点格式：
1. 简短标题（3-6字，点明这条价值的核心）
正文（精炼，说清楚就行，不要堆砌形容词）

禁止输出前言（如"好的，我来…"）和结尾确认（如"您看是否合适？"），直接给要点内容。`,

    site: `\n\n**当前章节：场地现状**

场地现状分析是设计"有的放矢"的依据。核心是客观呈现地块现有条件——地形地貌、水系植被、周边界面、现状资源与制约——并从中挖掘设计机遇。

**【输出格式要求——必须遵守】**
直接用 1-4 个编号要点输出，每点格式：
1. 简短标题（3-6字，点明场地特色或价值）
正文（精炼，重点说明特色与价值，文字尽量精简，不改变本意）

禁止输出前言和结尾确认，直接给要点内容。`,

    building: `\n\n**当前章节：建筑分析**

建筑分析帮助读者快速了解建筑产品特征，为景观设计语言的选择提供依据。

**【输出格式要求——必须遵守】**
说清楚建筑的颜色、风格、排布、调性等关键信息，整体控制在 30 字以内，简练准确。
不要分点，不要展开分析，禁止输出前言和结尾确认，直接一段话给出。`,

    general: `\n\n**当前章节：工程概况**

工程概况需要准确呈现项目关键规划指标，让读者快速了解项目规模。

**【输出格式要求——必须遵守】**
只列关键数据，每行一条，严格格式：数据名：数值（含单位）

示例：
红线面积：约 12000㎡
建筑面积：约 35000㎡
景观面积：约 8500㎡
绿化率：35%

不加任何标注符号（★●■等），不加说明文字，禁止输出前言和结尾确认，只给数据列表。若某项数据原始资料中未提及，填"—"。`,

    strategy: `\n\n**当前章节：设计策略**

设计策略是连接"分析"与"方案"的桥梁，是整个文本逻辑的核心。

**好的设计策略要做到：**
1. 针对这个地块的具体问题提出解法（不能放之四海皆准）
2. 体现设计师的专业判断与创造力
3. 有清晰的执行路径，不空洞

请结合项目特征（如三面环水/临农田/高层+别墅等），从"界面处理、空间营造、生态设计、功能植入、文化意境"等维度展开思考，推导出有针对性的景观策略。可以参考山水画论、中国园林哲学等文化视角来提升策略的文化高度。`,

    concept: `\n\n**当前章节：设计构思**

设计构思是整个文本最有灵魂的部分——需要找到一个与这块地、这座城、这批建筑都高度契合的文化意象，并将其凝练为**四个字的核心主题**。

**提炼四字主题的路径：**
- 地域文化：项目所在地的历史典故、山水画派（如新安画派、吴门画派、金陵画派）、文人诗词、地方意象
- 自然环境：场地的水系形态、植被特征、地形肌理，与中国传统自然观的对应关系
- 建筑气质：建筑的风格、色彩、排布方式，对应的历史审美语境
- 甲方意向：项目定位与目标客群的精神追求

**要求：**
1. 四字主题要有独特性，避免"山水园林""天人合一"等过于通用的表达
2. 主动说明：这四个字从何而来？与这个项目的关联性是什么？
3. 可以引用一句相关的古典诗词或画论，增加文化厚度
4. 设计师提供的地块地点、建筑风格、甲方定位，都是锁定文化方向的关键线索

请主动从原始资料中提炼信息，给出你认为最能打动甲方、最有文化辨识度的构思方向。`,

    preview: `\n\n你正在协助设计师对已完成的景观文本进行整体审阅和优化。可以自由讨论——文本逻辑连贯性、语言表达、文化深度、篇幅调整、章节衔接等任何问题。`,
  };

  return coreRole + (guides[key] || guides.preview);
}

/* ============================================================
   提取 Prompt——点击「应用到预览」时，从对话中提取结构化数据
   使用独立的 system prompt，与对话 prompt 分离，确保精准提取
============================================================ */
function buildExtractPrompt(key) {
  const formats = {
    location: `{"title":"（3-6字标题，可比'区位分析'更有特色）","content":"150-220字正文","keywords":["关键词1","关键词2","关键词3"]}`,
    site:     `{"title":"（标题）","content":"150-220字正文","keywords":["关键词1","关键词2","关键词3"]}`,
    building: `{"title":"（标题）","content":"150-220字正文","keywords":["关键词1","关键词2","关键词3"]}`,
    general:  `{"title":"工程概况","content":"100-150字概况","stats":{"用地面积":"","建筑面积":"","景观面积":"","绿化率":"","容积率":"","建筑密度":""}}`,
    strategy: `{"title":"设计策略","items":[{"name":"策略名（4-8字）","desc":"一句话说明（20-40字）"}]}（共3-5条）`,
    concept:  `{"concept":{"title":"（设计构思标题）","content":"150-200字构思说明","keywords":["意向图关键词1","意向图关键词2","意向图关键词3"]},"theme":{"title":"（设计理念标题）","content":"150-200字理念阐述"}}`,
  };
  return `你是一个专业的内容提取助手。请从以上对话中提取最终确认的设计文案，整理为以下 JSON 格式输出。只输出 JSON，不要任何说明或前缀文字。

目标格式：
${formats[key] || '{"title":"","content":""}'}

提取原则：
- 优先提取对话中最后一个版本的内容（若有多轮修改，取最新版）
- title 可以结合对话中提到的创意命名，不必拘泥于"区位分析"等通用名称
- content 保持连贯的段落式正文，去掉 Markdown 格式符号
- keywords 提炼最有画面感、最能代表设计意向的词汇`;
}

/* ============================================================
   智能提取：从 AI 回复中剔除对话前言/结尾，只保留结构化结论
   - 如果文本包含编号列表（1. / 2. / 1、），仅保留编号项及其描述
   - 否则原文返回（不破坏纯段落型内容）
============================================================ */
function smartExtractContent(text) {
  const lines = text.split('\n');
  const items = [];
  let current = null;

  for (const line of lines) {
    const isNumbered = /^\s*\d+[\.、]\s/.test(line);
    if (isNumbered) {
      // 新编号项开始
      if (current !== null) items.push(current.trim());
      current = line;
    } else if (current !== null) {
      // 编号项的后续内容（描述行）——空行也保留，让每项之间有分隔
      current += '\n' + line;
    }
    // 编号项开始前的内容（前言）一律忽略
  }
  if (current !== null) items.push(current.trim());

  // 至少有 2 个编号项才视为结构化内容，否则原文返回
  if (items.length >= 2) {
    // 去掉每项末尾的多余空行，项间用单个换行分隔（紧凑）
    return items.map(s => s.replace(/\n+$/, '')).join('\n');
  }
  return text;
}

/* ============================================================
   应用章节内容到预览
   直接使用最后一条 AI 消息，无需第二次 API 调用
============================================================ */
function applyChapter(chapter) {
  const key = chapter === 'analysis' ? S.analysisTab : chapter;

  if (!S.chats[key] || S.chats[key].length === 0) {
    toast('请先与 AI 对话生成内容后再应用'); return;
  }

  // 取最后一条 AI 回复
  const lastAI = [...S.chats[key]].reverse().find(m => m.role === 'assistant');
  if (!lastAI) { toast('AI 还没有回复，请先发送消息'); return; }

  // 智能提取：若回复中包含编号列表（1. / 2. / 1、），只保留编号部分，
  // 自动去掉 AI 的"好的，我来..."前言 和 "您看这样是否..."结尾
  const content = smartExtractContent(lastAI.content);

  // 固定章节标题（不使用 AI 自由发挥的标题）
  const CHAPTER_TITLES = {
    location:'区位分析', site:'场地现状', building:'建筑分析',
    general:'工程概况', strategy:'设计策略', concept:'设计构思', theme:'设计理念'
  };

  // 从内容中提取关键词：优先匹配"数字. 短名 |"格式，其次提取行首的短词
  function extractKeywords(text) {
    // 匹配"1. 占位 |"或"1. 占位｜"格式
    const matches = [...text.matchAll(/^\d+[\.\、]\s*([^|｜\n]{2,8})[|｜]/gm)];
    if (matches.length >= 2) return matches.map(m => m[1].trim()).slice(0, 5);
    // 匹配"· 关键词"或"• 关键词"格式
    const bullets = [...text.matchAll(/^[·•·\-]\s*([^\n]{2,10})\n/gm)];
    if (bullets.length >= 2) return bullets.map(m => m[1].trim()).slice(0, 5);
    return [];
  }

  // 写入 S.applied（按章节类型处理）
  if (key === 'strategy') {
    // 策略：将编号列表解析为 "策略名：描述" 每行
    // 策略：从对话文本中解析 "问题→策略名：解法" 或 "策略名：解法" 格式，存为 items 数组
    const lines = content.split('\n').map(l => l.trim()).filter(l => l);
    const numbered = lines.filter(l => /^\d/.test(l));
    const parseLines = numbered.length >= 2 ? numbered : lines.filter(l => l.length > 2);
    const stratItems = parseLines.map(l => {
      const raw = l.replace(/^\d+[\.\、]\s*/, '');
      const arrowI = raw.indexOf('→') > -1 ? raw.indexOf('→') : (raw.indexOf('->') > -1 ? raw.indexOf('->') : -1);
      let problem = '', rest = raw;
      if (arrowI > -1) { problem = raw.slice(0, arrowI).trim(); rest = raw.slice(arrowI + 1).trim(); }
      const colonI = rest.indexOf('：') > -1 ? rest.indexOf('：') : (rest.indexOf(':') > -1 ? rest.indexOf(':') : -1);
      if (colonI > -1) return { problem, name: rest.slice(0, colonI).trim(), desc: rest.slice(colonI+1).trim() };
      return { problem, name: rest, desc: '' };
    });
    S.applied.strategy = { title: '设计策略', items: stratItems.length ? stratItems : [] };

  } else if (key === 'concept') {
    // 构思：从对话文本中尝试提取四字核心主题，同步更新理念分区（若有当前选中方案）
    const kws = extractKeywords(content);
    function _extractThemeName(text) {
      let m;
      m = text.match(/\*\*([\u4e00-\u9fff]{4})\*\*/);          if (m) return m[1];
      m = text.match(/[「【"『]([\u4e00-\u9fff]{4})[」】"』]/); if (m) return m[1];
      m = text.match(/(?:核心主题|主题名|主题)[：:]\s*([\u4e00-\u9fff]{4})/); if (m) return m[1];
      return null;
    }
    const theme_name = _extractThemeName(content);
    S.applied.concept = { title: '设计构思', content, keywords: kws, ...(theme_name ? { theme_name } : {}) };
    // 若当前选中方案有 zones，同步保持理念页分区（不覆盖 theme_name）
    const selOpt = S.conceptOptions[S.selectedConceptIdx];
    if (selOpt?.zones?.length && !S.applied.theme?.zones?.length) {
      S.applied.theme = { title: '设计理念', theme_name: theme_name || selOpt.theme_name, zones: selOpt.zones };
    } else if (theme_name && S.applied.theme) {
      S.applied.theme.theme_name = theme_name; // 若主题名更新了，同步到理念页
    }
  } else {
    S.applied[key] = { title: CHAPTER_TITLES[key] || key, content, keywords: extractKeywords(content) };
  }

  // 标记子标签/主标签完成
  if (chapter === 'analysis') {
    document.getElementById(`asub-${key}`)?.classList.add('done');
    if (['location','site','building','general'].every(k => S.applied[k])) {
      document.getElementById('tab-analysis')?.classList.add('done');
    }
  } else {
    document.getElementById(`tab-${chapter}`)?.classList.add('done');
  }

  renderPreviewPages();
  document.getElementById('btn-export')?.removeAttribute('disabled');
  toast('已应用到预览');
}

function clearChat(chapter) {
  const key = chapter === 'analysis' ? S.analysisTab : chapter;
  S.chats[key] = [];
  S.rawResponses[key] = null;
  if (chapter === 'analysis') S.chatHTML[key] = '';

  const history = document.getElementById(`chat-${chapter}`);
  const empties = {
    analysis: ANALYSIS_EMPTY[S.analysisTab] || '发送「开始分析」，AI 将结合原始资料深入解读',
    strategy: '描述项目的核心挑战，AI 将推导有针对性的景观策略\n\n也可以发送「开始推导设计策略」直接生成',
    concept:  '告诉 AI 你的灵感方向，或发送「帮我提炼设计主题」开始头脑风暴\n\n可以结合山水画、地域文化等文化线索进行探讨',
    preview:  '描述你想调整的内容，或粘贴某段文字让 AI 优化',
  };
  history.innerHTML = `<div class="chat-empty"><p>${empties[chapter]}</p></div>`;
  document.getElementById(`apply-${chapter}`)?.setAttribute('disabled', true);
  document.getElementById(`apply-${chapter}`)?.removeAttribute('disabled');
  const applyBtn = document.getElementById(`apply-${chapter}`);
  if (applyBtn) applyBtn.disabled = true;
}

/* ============================================================
   右侧预览更新
============================================================ */
function updatePreview(screen) {
  const label = document.getElementById('preview-label');
  const labelMap = {
    project:  'A3 横向预览',
    analysis: '前期分析 · 预览',
    strategy: '设计策略 · 预览',
    concept:  '设计构思 · 预览',
    preview:  '全部页面预览',
  };
  label.textContent = labelMap[screen] || 'A3 横向预览';
  renderPreviewPages(screen);
}

/* 根据当前屏幕渲染对应页面 */
function renderPreviewPages(screen) {
  screen = screen || S.currentScreen;
  const wrap = document.getElementById('pages-wrap');
  const empty = document.getElementById('preview-empty');

  // 决定要渲染哪些页面
  let pageIds = [];
  if (screen === 'analysis') {
    pageIds = ['location','site','building','general'];
  } else if (screen === 'strategy') {
    pageIds = ['strategy'];
  } else if (screen === 'concept') {
    pageIds = ['concept','theme'];
  } else if (screen === 'preview') {
    // 前期分析（始终包含）
    pageIds.push('location','site','building','general');
    // 设计策略：只有用户主动应用了内容才包含
    if (S.applied.strategy) pageIds.push('strategy');
    // 设计构思（始终包含）
    pageIds.push('concept','theme');
  } else {
    // 项目信息页：显示空状态
    wrap.style.display = 'none';
    empty.style.display = 'flex';
    document.getElementById('pg-count').textContent = '0';
    return;
  }

  // 渲染页面
  const { pageW, pageH, pageMargin: mg } = S;
  const pw   = Math.round(pageW * MM * S.zoom);
  const ph   = Math.round(pageH * MM * S.zoom);
  const mgpx = Math.round(mg * MM * S.zoom);
  const iw   = pw - mgpx * 2;
  const ih   = ph - mgpx * 2;

  _imgIdx = 0;
  const pagesHTML = pageIds.map((id, i) => {
    const html = (PAGE_RENDERERS[id] || placeholderPage)(pw, ph, mgpx, iw, ih, id);
    return `
    <div class="page-wrap">
      <div class="page-num-label">P${i+1}</div>
      <div class="a3-page" style="width:${pw}px;height:${ph}px;">${html}</div>
    </div>`;
  }).join('');

  wrap.innerHTML = pagesHTML;
  wrap.style.display = 'flex';
  empty.style.display = 'none';
  document.getElementById('pg-count').textContent = pageIds.length;
}

/* ---- 预览缩放 ---- */
const MM = 3.7795;
let _imgIdx = 0;
function doZoom(dir) {
  S.zoom = Math.min(1.5, Math.max(0.25, +(S.zoom + dir * 0.05).toFixed(2)));
  document.getElementById('zoom-txt').textContent = Math.round(S.zoom * 100) + '%';
  renderPreviewPages();
}

/* ---- 通用页眉：中英文同行同高，右对齐，无分隔线 ---- */
function hdr(title, titleEn, mg) {
  const z = S.zoom;
  return `<div style="display:flex;justify-content:flex-end;align-items:center;margin-bottom:${Math.round(mg*0.26)}px;">
    <span style="font-size:${Math.round(18*z)}px;font-weight:700;color:#1d1d1f;letter-spacing:-0.3px;line-height:1;">${title}</span>
    <span style="font-size:${Math.round(18*z)}px;font-weight:300;color:#c0c0c0;margin:0 ${Math.round(5*z)}px;line-height:1;"> | </span>
    <span style="font-size:${Math.round(18*z)}px;font-weight:400;color:#8e8e93;letter-spacing:1.5px;line-height:1;">${titleEn}</span>
  </div>`;
}

/* ---- 图片占位符 ---- */
function slot(w, h, label) {
  const id = 'slot-' + (++_imgIdx);
  const z = S.zoom;
  return `<div class="img-slot" id="${id}" onclick="uploadSlot('${id}')"
    style="width:${typeof w==='number'?w+'px':w};height:${typeof h==='number'?h+'px':h};min-height:${Math.round(36*z)}px;">
    <svg width="${Math.round(18*z)}" height="${Math.round(18*z)}" viewBox="0 0 24 24" fill="none" stroke="#c7c7cc" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
    <span style="font-size:${Math.round(9*z)}px;color:#aeaeb2;margin-top:${Math.round(3*z)}px;">${label}</span>
  </div>`;
}

/* 将 AI 回复文本转为预览可渲染的 HTML
   - 多个连续空行合并为一个，避免编号列表间距过大
   - **粗体** → <strong>，换行 → <br>
*/
function fmtContent(text) {
  if (!text) return '';
  return text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/\n{2,}/g,'\n')   // 连续多个换行 → 单个换行，消除过大间距
    .replace(/\n/g,'<br>');
}

/* 占位页（未应用时的灰色空白页） */
function placeholderPage(pw, ph, mg, iw, ih, id) {
  const z = S.zoom;
  const NAMES = { location:'区位分析', site:'场地现状', building:'建筑分析', general:'工程概况', strategy:'设计策略', concept:'设计构思', theme:'设计理念' };
  return `<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#fafafa;">
    <div style="text-align:center;color:#c7c7cc;">
      <div style="font-size:${Math.round(28*z)}px;font-weight:300;margin-bottom:${Math.round(8*z)}px;">${NAMES[id]||id}</div>
      <div style="font-size:${Math.round(11*z)}px;">在左侧对话后点击「应用到预览」</div>
    </div>
  </div>`;
}

/* ---- 各页面渲染函数 ---- */
const PAGE_RENDERERS = {
  location: (pw,ph,mg,iw,ih) => {
    const z=S.zoom; const d=S.applied.location||{title:'区位分析',content:'',keywords:[]};
    const kws = d.keywords?.length ? d.keywords : ['区位优越','交通便利','配套完善'];
    const lw=Math.round(iw*0.65); const rw=iw-lw-Math.round(mg*0.35);
    return `<div style="position:absolute;inset:${mg}px;display:flex;flex-direction:column;">
      ${hdr('区位分析','LOCATION ANALYSIS',mg)}
      <div style="flex:1;display:flex;gap:${Math.round(mg*0.35)}px;min-height:0;">
        <div style="width:${lw}px;display:flex;flex-direction:column;gap:${Math.round(mg*0.25)}px;">
          ${slot(lw,'65%','区位总图')}
          <div style="flex:1;display:flex;gap:${Math.round(mg*0.25)}px;">
            <div style="flex:1;">${slot('100%','100%','交通分析图')}</div>
            <div style="flex:1;">${slot('100%','100%','周边配套图')}</div>
          </div>
        </div>
        <div style="width:${rw}px;display:flex;flex-direction:column;justify-content:center;gap:${Math.round(mg*0.45)}px;">
          <div style="font-size:${Math.round(24*z)}px;line-height:1.8;color:#1d1d1f;font-family:'Microsoft YaHei','PingFang SC',sans-serif;text-align:right;">${fmtContent(d.content)||'项目位于城市核心区域，地理位置优越，周边配套完善。'}</div>
          <div style="display:flex;flex-direction:column;gap:${Math.round(7*z)}px;">
            ${kws.map(k=>`<div style="display:flex;align-items:center;justify-content:flex-end;gap:${Math.round(7*z)}px;"><span style="font-size:${Math.round(20*z)}px;color:#3a3a3c;font-family:'Microsoft YaHei','PingFang SC',sans-serif;">${k}</span><div style="width:${Math.round(4*z)}px;height:${Math.round(4*z)}px;border-radius:50%;background:#1d1d1f;flex-shrink:0;"></div></div>`).join('')}
          </div>
        </div>
      </div>
    </div>`;
  },

  site: (pw,ph,mg,iw,ih) => {
    const z=S.zoom; const d=S.applied.site||{title:'场地现状',content:'',keywords:[]};
    const kws=d.keywords?.length?d.keywords:['地形平缓','植被丰富','水体资源'];
    const lw=Math.round(iw*0.65); const rw=iw-lw-Math.round(mg*0.35);
    const gap=Math.round(mg*0.25);
    return `<div style="position:absolute;inset:${mg}px;display:flex;flex-direction:column;">
      ${hdr('场地现状','SITE ANALYSIS',mg)}
      <div style="flex:1;display:flex;gap:${Math.round(mg*0.35)}px;min-height:0;">
        <div style="width:${lw}px;display:flex;flex-direction:column;gap:${gap}px;">
          ${slot(lw,'62%','场地全景图')}
          <div style="flex:1;display:flex;gap:${gap}px;">
            <div style="flex:1;">${slot('100%','100%','地形分析')}</div>
            <div style="flex:1;">${slot('100%','100%','植被现状')}</div>
            <div style="flex:1;">${slot('100%','100%','周边环境')}</div>
          </div>
        </div>
        <div style="width:${rw}px;display:flex;flex-direction:column;justify-content:center;gap:${Math.round(mg*0.45)}px;">
          <div style="font-size:${Math.round(24*z)}px;line-height:1.8;color:#1d1d1f;font-family:'Microsoft YaHei','PingFang SC',sans-serif;text-align:right;">${fmtContent(d.content)||'场地地势平坦，植被覆盖良好，东侧有现状水体。'}</div>
          <div style="display:flex;flex-direction:column;gap:${Math.round(7*z)}px;">
            ${kws.map(k=>`<div style="display:flex;align-items:center;justify-content:flex-end;gap:${Math.round(7*z)}px;"><span style="font-size:${Math.round(20*z)}px;color:#3a3a3c;font-family:'Microsoft YaHei','PingFang SC',sans-serif;">${k}</span><div style="width:${Math.round(4*z)}px;height:${Math.round(4*z)}px;border-radius:50%;background:#1d1d1f;flex-shrink:0;"></div></div>`).join('')}
          </div>
        </div>
      </div>
    </div>`;
  },

  building: (pw,ph,mg,iw,ih) => {
    const z=S.zoom; const d=S.applied.building||{title:'建筑分析',content:'',keywords:[]};
    const kws=d.keywords?.length?d.keywords:['现代简约','架空界面','围合中庭'];
    const lw=Math.round(iw*0.65); const rw=iw-lw-Math.round(mg*0.35);
    const gap=Math.round(mg*0.25);
    return `<div style="position:absolute;inset:${mg}px;display:flex;flex-direction:column;">
      ${hdr('建筑分析','BUILDING ANALYSIS',mg)}
      <div style="flex:1;display:flex;gap:${Math.round(mg*0.35)}px;min-height:0;">
        <div style="width:${lw}px;display:flex;flex-direction:column;gap:${gap}px;">
          ${slot(lw,'62%','建筑总体布局图')}
          <div style="flex:1;display:flex;gap:${gap}px;">
            <div style="flex:1;">${slot('100%','100%','建筑立面')}</div>
            <div style="flex:1;">${slot('100%','100%','建筑细节')}</div>
          </div>
        </div>
        <div style="width:${rw}px;display:flex;flex-direction:column;justify-content:center;gap:${Math.round(mg*0.45)}px;">
          <div style="font-size:${Math.round(24*z)}px;line-height:1.8;color:#1d1d1f;font-family:'Microsoft YaHei','PingFang SC',sans-serif;text-align:right;">${fmtContent(d.content)||'建筑风格现代简约，底层架空处理，围合出中心绿地。'}</div>
          <div style="display:flex;flex-direction:column;gap:${Math.round(7*z)}px;">
            ${kws.map(k=>`<div style="display:flex;align-items:center;justify-content:flex-end;gap:${Math.round(7*z)}px;"><span style="font-size:${Math.round(20*z)}px;color:#3a3a3c;font-family:'Microsoft YaHei','PingFang SC',sans-serif;">${k}</span><div style="width:${Math.round(4*z)}px;height:${Math.round(4*z)}px;border-radius:50%;background:#1d1d1f;flex-shrink:0;"></div></div>`).join('')}
          </div>
        </div>
      </div>
    </div>`;
  },

  general: (pw,ph,mg,iw,ih) => {
    const z=S.zoom; const d=S.applied.general||{};
    const lw=Math.round(iw*0.65); const rw=iw-lw-Math.round(mg*0.35);
    return `<div style="position:absolute;inset:${mg}px;display:flex;flex-direction:column;">
      ${hdr('工程概况','GENERAL OVERVIEW',mg)}
      <div style="flex:1;display:flex;gap:${Math.round(mg*0.35)}px;min-height:0;">
        <div style="width:${lw}px;">${slot(lw,'100%','总平面图 / 红线图')}</div>
        <div style="width:${rw}px;display:flex;flex-direction:column;justify-content:center;gap:0;">
          <div style="font-size:${Math.round(24*z)}px;line-height:1.8;color:#1d1d1f;font-family:'Microsoft YaHei','PingFang SC',sans-serif;text-align:right;margin-bottom:${Math.round(mg*0.3)}px;">${d.content||'工程概况包括：用地红线面积、景观设计面积、绿化率指标及相关规划条件等。'}</div>
          ${['用地面积','景观面积','绿化率','容积率','建筑密度','停车位数'].map(k=>`
          <div style="display:flex;justify-content:space-between;padding:${Math.round(7*z)}px 0;border-bottom:${Math.round(1*z)}px solid #e8e8e8;">
            <span style="font-size:${Math.round(11*z)}px;color:#8e8e93;">${k}</span>
            <span style="font-size:${Math.round(11*z)}px;font-weight:600;color:#1d1d1f;">${d.stats?.[k] || '—'}</span>
          </div>`).join('')}
        </div>
      </div>
    </div>`;
  },

  strategy: (pw,ph,mg,iw,ih) => {
    const z=S.zoom; const d=S.applied.strategy||{title:'设计策略', items:[]};
    // 兼容新格式 items:[{problem,name,desc}] 和旧格式 content 字符串
    const items = d.items?.length ? d.items
      : (d.content ? d.content.split('\n').filter(l=>l.trim()).map(l=>{
          const arrowI = l.indexOf('→')>-1 ? l.indexOf('→') : -1;
          let problem='', rest=l;
          if(arrowI>-1){problem=l.slice(0,arrowI).trim();rest=l.slice(arrowI+1).trim();}
          const ci=rest.indexOf('：')>-1?rest.indexOf('：'):(rest.indexOf(':')>-1?rest.indexOf(':'):-1);
          return ci>-1?{problem,name:rest.slice(0,ci).trim(),desc:rest.slice(ci+1).trim()}:{problem,name:rest,desc:''};
        })
      : [{problem:'路线平直单调',name:'曲径通幽',desc:'以蜿蜒游径打破轴线，引导发现空间趣味'},{problem:'界面生硬封闭',name:'借景入园',desc:'通过框景与开口，引入周边山水自然意境'},{problem:'功能空间割裂',name:'动静相宜',desc:'合理分配动态活动区与静谧休憩区，收放有序'}]);
    const lw=Math.round(iw*0.55); const rw=iw-lw-Math.round(mg*0.35);
    return `<div style="position:absolute;inset:${mg}px;display:flex;flex-direction:column;">
      ${hdr(d.title||'设计策略','DESIGN STRATEGY',mg)}
      <div style="flex:1;display:flex;gap:${Math.round(mg*0.35)}px;min-height:0;">
        <div style="width:${lw}px;">${slot(lw,'100%','策略分析图')}</div>
        <div style="width:${rw}px;display:flex;flex-direction:column;justify-content:center;gap:${Math.round(mg*0.3)}px;overflow:hidden;">
          ${items.map((it,i)=>`<div style="padding:${Math.round(mg*0.18)}px 0;border-bottom:${Math.round(1*z)}px solid #ebebeb;">
            ${it.problem?`<div style="font-size:${Math.round(9*z)}px;color:#aaa;margin-bottom:${Math.round(3*z)}px;letter-spacing:0.5px;">▶ ${it.problem}</div>`:''}
            <div style="font-size:${Math.round(11.5*z)}px;font-weight:700;color:#1d1d1f;margin-bottom:${Math.round(3*z)}px;letter-spacing:${Math.round(1*z)}px;">${String.fromCharCode(65+i)}. ${it.name}</div>
            <div style="font-size:${Math.round(10*z)}px;color:#6e6e73;line-height:1.65;">${it.desc}</div>
          </div>`).join('')}
        </div>
      </div>
    </div>`;
  },

  concept: (pw,ph,mg,iw,ih) => {
    const z=S.zoom; const d=S.applied.concept||{title:'设计构思',content:'',keywords:[]};
    const gap=Math.round(mg*0.25);
    return `<div style="position:absolute;inset:${mg}px;display:flex;flex-direction:column;">
      ${hdr(d.title||'设计构思','DESIGN CONCEPT',mg)}
      <div style="flex:1;position:relative;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:${gap}px;min-height:0;">
        <div>${slot('100%','100%','灵感图 1')}</div>
        <div>${slot('100%','100%','灵感图 2')}</div>
        <div>${slot('100%','100%','灵感图 3')}</div>
        <div>${slot('100%','100%','灵感图 4')}</div>
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.94);backdrop-filter:blur(12px);border-radius:${Math.round(10*z)}px;padding:${Math.round(16*z)}px ${Math.round(20*z)}px;max-width:${Math.round(iw*0.48)}px;text-align:center;box-shadow:0 ${Math.round(4*z)}px ${Math.round(20*z)}px rgba(0,0,0,0.1);">
          <div style="font-size:${Math.round(9*z)}px;font-weight:600;letter-spacing:2px;color:#888;text-transform:uppercase;margin-bottom:${Math.round(6*z)}px;">CONCEPT</div>
          ${d.theme_name ? `<div style="font-size:${Math.round(20*z)}px;font-weight:700;letter-spacing:${Math.round(5*z)}px;color:#1d1d1f;margin-bottom:${Math.round(10*z)}px;font-family:'Microsoft YaHei','PingFang SC',sans-serif;">${d.theme_name}</div>` : ''}
          <div style="font-size:${Math.round(11*z)}px;line-height:1.85;color:#2a2a2a;">${fmtContent(d.content)||'设计灵感源于自然山水与人文历史的交融，以景抒情，以园述史。'}</div>
        </div>
      </div>
    </div>`;
  },

  theme: (pw,ph,mg,iw,ih) => {
    const z=S.zoom; const d=S.applied.theme||{title:'设计理念', theme_name:'', zones:[]};
    const gap=Math.round(mg*0.22);
    // 使用 zones 数组（5-6个分区主题），或默认占位
    const zones = d.zones?.length ? d.zones : [
      {name:'春华坡',note:'自然生长'},
      {name:'玉兰苑',note:'含蓄内秀'},
      {name:'竹影廊',note:'清幽婉转'},
      {name:'水月台',note:'澄静如镜'},
      {name:'雅集园',note:'人文积淀'},
    ];
    const cols = Math.min(zones.length, 6);
    return `<div style="position:absolute;inset:${mg}px;display:flex;flex-direction:column;">
      ${hdr(d.title||'设计理念','DESIGN PHILOSOPHY',mg)}
      <div style="margin-bottom:${Math.round(mg*0.25)}px;display:flex;align-items:baseline;gap:${Math.round(mg*0.3)}px;">
        ${d.theme_name?`<span style="font-size:${Math.round(19*z)}px;font-weight:700;letter-spacing:${Math.round(5*z)}px;color:#1d1d1f;font-family:'Microsoft YaHei','PingFang SC',sans-serif;">${d.theme_name}</span>`:''}
        ${d.content?`<span style="font-size:${Math.round(9.5*z)}px;color:#999;line-height:1.5;flex:1;">${(d.content||'').slice(0,80)}${d.content?.length>80?'…':''}</span>`:''}
      </div>
      <div style="flex:1;display:grid;grid-template-columns:repeat(${cols},1fr);gap:${gap}px;min-height:0;">
        ${zones.map(zn=>`<div style="display:flex;flex-direction:column;gap:${Math.round(gap*0.5)}px;">
          <div style="flex:1;">${slot('100%','100%',zn.name)}</div>
          <div style="text-align:center;padding:${Math.round(3*z)}px 0 ${Math.round(2*z)}px;">
            <div style="font-size:${Math.round(11*z)}px;font-weight:700;color:#1d1d1f;letter-spacing:${Math.round(2*z)}px;font-family:'Microsoft YaHei','PingFang SC',sans-serif;">${zn.name}</div>
            ${zn.note?`<div style="font-size:${Math.round(8.5*z)}px;color:#aaa;margin-top:${Math.round(2*z)}px;">${zn.note}</div>`:''}
          </div>
        </div>`).join('')}
      </div>
    </div>`;
  },
};

/* ---- 图片占位符点击上传 ---- */
function uploadSlot(id) {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*';
  input.onchange = e => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const el = document.getElementById(id); if (!el) return;
      el.innerHTML = `<img src="${ev.target.result}" style="width:100%;height:100%;object-fit:cover;display:block;">`;
      el.style.border = 'none'; el.style.background = 'none';
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

/* ============================================================
   原始资料上传区：拖文件 / 粘贴文字 / Ctrl+V 截图 三合一
============================================================ */
function initUploadHandlers() {
  const wrap = document.getElementById('raw-upload-wrap');
  const ta   = document.getElementById('raw-text');
  if (!wrap || !ta) return;

  // 拖入文件
  wrap.addEventListener('dragover', e => {
    e.preventDefault();
    wrap.classList.add('drag-over');
  });
  wrap.addEventListener('dragleave', e => {
    if (!wrap.contains(e.relatedTarget)) wrap.classList.remove('drag-over');
  });
  wrap.addEventListener('drop', e => {
    e.preventDefault();
    wrap.classList.remove('drag-over');
    const files = Array.from(e.dataTransfer.files);
    const imgFile  = files.find(f => f.type.startsWith('image/'));
    const textFile = files.find(f => !f.type.startsWith('image/'));

    if (textFile) {
      // PDF 用 PDF.js 自动提取文字
      if (textFile.type === 'application/pdf' || textFile.name.toLowerCase().endsWith('.pdf')) {
        handleDroppedPDF(textFile, ta);
        return;
      }
      // 超过 2MB 的文本文件也可能导致卡顿
      if (textFile.size > 2 * 1024 * 1024) {
        showRawStatus('⚠️ 文件太大，请粘贴核心内容即可（建议不超过 2MB）');
        toast('文件过大，请精简后再试');
        return;
      }
      const r = new FileReader();
      r.onload = ev => { ta.value = ev.target.result; showRawStatus(`✓ 已载入：${textFile.name}`); };
      r.readAsText(textFile, 'UTF-8');
    }
    if (imgFile) loadImageFile(imgFile);
  });

  // Ctrl+V 粘贴截图（textarea 内触发）
  ta.addEventListener('paste', e => {
    const items = Array.from(e.clipboardData?.items || []);
    const imgItem = items.find(it => it.type.startsWith('image/'));
    if (imgItem) {
      e.preventDefault();
      loadImageFile(imgItem.getAsFile());
    }
    // 文字粘贴走浏览器默认
  });
}

function loadImageFile(file) {
  if (!file) return;
  const r = new FileReader();
  r.onload = ev => {
    S.info.imageData = ev.target.result;
    const area = document.getElementById('img-preview-area');
    area.style.display = 'block';
    area.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;">
        <img src="${ev.target.result}" style="height:48px;border-radius:4px;border:1px solid var(--border);object-fit:cover;">
        <div style="flex:1;">
          <div style="font-size:11px;color:var(--text-1);font-weight:500;">截图已载入</div>
          <div style="font-size:10px;color:var(--text-3);">AI 将识别图片内容辅助分析</div>
        </div>
        <button onclick="removeImagePreview()" style="border:none;background:none;color:var(--text-3);font-size:18px;cursor:pointer;line-height:1;padding:2px 4px;">×</button>
      </div>`;
  };
  r.readAsDataURL(file);
}

function removeImagePreview() {
  S.info.imageData = null;
  const area = document.getElementById('img-preview-area');
  area.style.display = 'none';
  area.innerHTML = '';
}

function showRawStatus(text) {
  const el = document.getElementById('raw-file-status');
  if (el) { el.textContent = text; el.style.display = 'block'; }
}

/* ============================================================
   PDF 拖入处理：用 PDF.js 从 PDF 文件中提取文字
   支持：可复制的文字版 PDF（扫描版 PDF 无法提取文字，需截图）
============================================================ */
async function handleDroppedPDF(file, ta) {
  const pdfjs = window['pdfjs-dist/build/pdf'];
  if (!pdfjs) {
    // PDF.js 未加载（网络问题），提示用户手动复制
    showRawStatus('⚠️ PDF.js 未加载（需联网）— 请复制文字后粘贴');
    toast('PDF.js 未加载，请手动复制文字');
    return;
  }
  showRawStatus('⏳ 正在读取 PDF 文字内容…');
  try {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjs.getDocument({ data: arrayBuffer }).promise;
    const totalPages = pdf.numPages;
    let allText = '';
    for (let i = 1; i <= totalPages; i++) {
      const page = await pdf.getPage(i);
      const textContent = await page.getTextContent();
      const pageText = textContent.items.map(item => item.str).join(' ');
      if (pageText.trim()) allText += pageText + '\n';
    }
    if (!allText.trim()) {
      // 可能是扫描版 PDF（全图片，无可提取文字）
      showRawStatus('⚠️ 此 PDF 是扫描版（无可提取文字）— 请截图后粘贴到输入框，AI 将视觉识别');
      toast('扫描版 PDF，请截图后粘贴');
      return;
    }
    ta.value = allText.trim();
    showRawStatus(`✓ PDF 文字已提取（共 ${totalPages} 页，${allText.length} 字）`);
    toast(`PDF 已提取 ${totalPages} 页内容`);
  } catch (e) {
    showRawStatus(`⚠️ PDF 解析出错：${e.message}，请手动复制文字粘贴`);
    toast('PDF 解析失败，请手动复制文字');
    console.error('PDF解析错误：', e);
  }
}

/* ============================================================
   一键生成：提取项目信息 + 并行生成全套文案
   两路并行请求：A=信息+前期分析，B=策略+构思+理念，速度比串行快约1倍
   原始资料截断至8000字（头6000+尾2000），避免超长文档拖慢速度
============================================================ */
async function autoExtractAndGenerate() {
  const fullText = document.getElementById('raw-text')?.value?.trim();
  if (!fullText && !S.info.imageData) {
    toast('请先粘贴原始资料或截图'); return;
  }
  if (!S.apiKey) {
    toast('请先点击右上角「设置」，填入 API Key'); return;
  }

  const btn  = document.getElementById('btn-auto-gen');
  const prog = document.getElementById('gen-progress');
  btn.disabled = true;
  prog.style.display = 'block';
  prog.style.color = 'var(--text-2)';
  prog.innerHTML = '⏳ 正在并行生成全套文案，请稍候（约 15–25 秒）…';

  // 截断：取前6000字 + 末2000字，关键信息都在头尾
  const raw = fullText || '';
  const rawText = raw.length > 8000
    ? raw.slice(0, 6000) + '\n…（中间内容已省略）…\n' + raw.slice(-2000)
    : raw;

  // ── 请求 A：提取项目信息 + 前期分析4章（数据驱动） ──
  const promptA = `你是专业景观设计文案师。以下是项目原始资料：
${rawText}

严格返回以下 JSON，不要任何额外文字：
{
  "info": {
    "name": "项目名称",
    "location": "项目地点（省市区）",
    "type": "项目类型（住宅景观/商业景观/公园/市政等）",
    "client": "甲方核心要求（若无则空字符串）"
  },
  "location": { "content":"1-4个编号要点，每点：简短标题（3-6字）换行+精炼正文，说清楚就行，禁止输出前言和结尾确认", "keywords":["词1","词2","词3"] },
  "site":     { "content":"1-4个编号要点，每点：简短标题（3-6字）换行+精炼正文，重点点明场地特色与价值，禁止输出前言和结尾确认", "keywords":["词1","词2","词3"] },
  "building": { "content":"说清楚颜色、风格、排布、调性等关键信息，整体不超过30字，禁止分点和前言", "keywords":["词1","词2","词3"] },
  "general":  { "content":"只列数据，格式：数据名：数值（含单位），一行一条，不加任何标注符号", "stats":{ "用地面积":"数值+单位或—", "景观面积":"数值+单位或—", "绿化率":"百分比或—", "容积率":"数值或—", "建筑密度":"百分比或—", "停车位数":"数值或—" } }
}`;

  // ── 请求 B：策略+构思（创意驱动，只需项目概要） ──
  const promptB = `你是专业景观设计文案师。
项目概况：${rawText.slice(0, 2000)}

严格返回以下 JSON，不要任何额外文字：
{
  "strategy": {
    "items": [
      { "problem": "场地核心问题（4-8字，客观描述现状矛盾，如"路线平直单调"）", "name": "策略名（2-5字，对应解法的核心意象，如"曲径通幽"）", "desc": "解法说明（15-30字，说清楚怎么做）" }
    ]
  },
  "concept": [
    {
      "theme_name": "四字主题①（须与项目地域文化/场地/建筑气质高度契合，不可用通用词）",
      "content": "100-140字：①主题来源（引用相关地域山水画派或古典诗句） ②与本项目的关联性 ③空间叙事方向",
      "keywords": ["搜图关键词1","搜图关键词2","搜图关键词3"],
      "zones": [ { "name": "景区名（2-4字）", "note": "与主题关联（8字内）" } ]
    },
    { "theme_name":"四字主题②（与①完全不同的文化切入角度）", "content":"100-140字", "keywords":["词1","词2","词3"], "zones":[{"name":"景区名","note":"关联"}] },
    { "theme_name":"四字主题③（第三种文化视角）", "content":"100-140字", "keywords":["词1","词2","词3"], "zones":[{"name":"景区名","note":"关联"}] }
  ]
}
注意：strategy共3-4条；concept每个方案zones共5-6个景区；三个方案主题须完全不同、各有鲜明文化辨识度。`;

  try {
    // 两路并行，速度约为串行的一半
    const [rawA, rawB] = await Promise.all([
      callAI([{ role:'user', content:promptA }], true),
      callAI([{ role:'user', content:promptB }], true),
    ]);

    const mA = rawA.match(/\{[\s\S]*\}/);
    if (!mA) throw new Error('前期分析返回格式有误，请重试');
    const dA = JSON.parse(mA[0]);

    const mB = rawB.match(/\{[\s\S]*\}/);
    if (!mB) throw new Error('创意章节返回格式有误，请重试');
    const dB = JSON.parse(mB[0]);

    // ① 填写项目基础信息
    if (dA.info) {
      if (dA.info.name)     document.getElementById('proj-name').value     = dA.info.name;
      if (dA.info.location) document.getElementById('proj-location').value = dA.info.location;
      if (dA.info.type)     document.getElementById('proj-type').value     = dA.info.type;
      if (dA.info.client)   document.getElementById('proj-client').value   = dA.info.client;
    }

    // ② 写入前期分析（来自 A）
    const ATITLES = { location:'区位分析', site:'场地现状', building:'建筑分析', general:'工程概况' };
    ['location','site','building','general'].forEach(k => {
      if (!dA[k]) return;
      S.applied[k] = k === 'general'
        ? { title:'工程概况', ...dA[k], stats: dA[k].stats || {} }
        : { title: ATITLES[k], ...dA[k] };
      // 注入到对话记录，供后续继续优化
      S.chats[k] = [{ role:'assistant', content: dA[k].content || '' }];
      S.chatHTML[k] = _buildChatMsgHTML(dA[k].content || '');
    });

    // ③ 写入创意章节（来自 B）
    if (dB.strategy) {
      // 新格式：存储 items 数组 {problem, name, desc}，渲染时直接使用
      S.applied.strategy = { title:'设计策略', items: dB.strategy.items || [] };
      // 聊天记录：用 "问题 → 策略名：解法" 格式显示
      const stratTxt = (dB.strategy.items||[]).map(it =>
        it.problem ? `${it.problem} → ${it.name}：${it.desc}` : `${it.name}：${it.desc}`
      ).join('\n');
      S.chats.strategy = [{ role:'assistant', content: stratTxt }];
      S.chatHTML.strategy = _buildChatMsgHTML(stratTxt);
    }

    // 构思：concept 现在是三个方案的数组
    const conceptArr = Array.isArray(dB.concept) ? dB.concept : (dB.concept ? [dB.concept] : []);
    if (conceptArr.length > 0) {
      S.conceptOptions = conceptArr;
      S.selectedConceptIdx = 0;

      // 更新三个方案卡片的标题
      const bar = document.getElementById('concept-opts-bar');
      if (bar) {
        bar.style.display = 'block';
        conceptArr.forEach((opt, i) => {
          const nameEl = document.getElementById(`copt-name-${i}`);
          if (nameEl) nameEl.textContent = opt.theme_name || `方案${i+1}`;
        });
        // 默认选中第一个
        [0,1,2].forEach(i => document.getElementById(`copt-${i}`)?.classList.toggle('active', i===0));
      }

      // 将第一个方案应用到预览
      const first = conceptArr[0];
      S.applied.concept = { title:'设计构思', ...first };
      if (first.zones?.length) {
        S.applied.theme = { title:'设计理念', theme_name: first.theme_name, zones: first.zones };
      }

      // 聊天区显示第一个方案内容
      const msg0 = first.theme_name ? `**${first.theme_name}**\n\n${first.content||''}` : (first.content||'');
      S.chats.concept = [{ role:'assistant', content: msg0 }];
      S.chatHTML.concept = _buildChatMsgHTML(msg0);
    }

    // ④ 标记导航标签完成
    ['analysis','strategy','concept'].forEach(ch =>
      document.getElementById(`tab-${ch}`)?.classList.add('done')
    );
    ['location','site','building','general'].forEach(k =>
      document.getElementById(`asub-${k}`)?.classList.add('done')
    );
    document.getElementById('btn-export')?.removeAttribute('disabled');

    // ⑤ 刷新预览
    renderPreviewPages();

    prog.style.color = 'var(--green)';
    prog.innerHTML = '✓ 全套文案已生成！切换到各章节查看，可通过对话进一步调整。';
    document.getElementById('proj-footer-hint').textContent = '全套文案已生成';
    toast('全套文案生成完成！');

  } catch (err) {
    prog.style.color = '#ff3b30';
    prog.textContent = `生成失败：${err.message}`;
    toast('生成失败：' + err.message);
  }

  btn.disabled = false;
}

/* ============================================================
   读取项目基础信息表单（各章节生成时用作上下文）
============================================================ */
function getProjectInfo() {
  return {
    name:     document.getElementById('proj-name')?.value?.trim()     || '',
    location: document.getElementById('proj-location')?.value?.trim() || '',
    type:     document.getElementById('proj-type')?.value?.trim()     || '',
    client:   document.getElementById('proj-client')?.value?.trim()   || '',
  };
}

/* ============================================================
   章节自动生成（进入章节页时自动触发，已有内容则跳过）
   逐步递进：前期分析 → 设计策略（引用分析结论）→ 设计构思（引用策略）
============================================================ */
async function autoGenerateChapter(screen) {
  if (!S.apiKey) return;

  const rawFull = document.getElementById('raw-text')?.value?.trim() || '';
  // 截断原始资料：取前5000字+末1000字，覆盖关键信息
  const rawText = rawFull.length > 6000
    ? rawFull.slice(0, 5000) + '\n…\n' + rawFull.slice(-1000)
    : rawFull;

  const info = getProjectInfo();
  const infoStr = [info.name, info.location, info.type, info.client].filter(Boolean).join(' / ');

  /* ── 前期分析：生成4个章节 ── */
  if (screen === 'analysis') {
    // 已全部生成则跳过
    if (['location','site','building','general'].every(k => S.applied[k])) return;

    const applyBtn = document.getElementById('apply-analysis');
    if (applyBtn) applyBtn.disabled = true;
    const thinking = addThinking('analysis');

    const prompt = `你是资深景观设计师，正在为以下项目撰写前期分析文案。
项目：${infoStr || '未知项目'}
原始资料（节选）：
${rawText || '（请根据项目类型和地点合理推断）'}

生成前期分析4个章节，严格返回 JSON，不要任何额外文字：
{
  "location": { "content":"1-4个编号要点，每点：简短标题（3-6字）换行+精炼正文，说清楚就行，禁止前言和结尾确认", "keywords":["词1","词2","词3"] },
  "site":     { "content":"1-4个编号要点，每点：简短标题（3-6字）换行+精炼正文，重点点明场地特色与价值，禁止前言和结尾确认", "keywords":["词1","词2","词3"] },
  "building": { "content":"说清楚颜色、风格、排布、调性等关键信息，整体不超过30字，禁止分点和前言", "keywords":["词1","词2","词3"] },
  "general":  { "content":"只列数据，格式：数据名：数值（含单位），一行一条，不加任何标注符号", "stats":{ "用地面积":"数值+单位或—", "景观面积":"数值+单位或—", "绿化率":"百分比或—", "容积率":"数值或—", "建筑密度":"百分比或—", "停车位数":"数值或—" } }
}`;

    try {
      const raw = await callAI([{ role:'user', content:prompt }], true);
      thinking.remove();
      const m = raw.match(/\{[\s\S]*\}/);
      if (!m) throw new Error('格式有误');
      const d = JSON.parse(m[0]);

      const TITLES = { location:'区位分析', site:'场地现状', building:'建筑分析', general:'工程概况' };

      // 写入 S.applied 和 S.chats（供后续对话继续）
      ['location','site','building','general'].forEach(k => {
        if (!d[k]) return;
        S.applied[k] = k === 'general'
          ? { title:'工程概况', ...d[k], stats: d[k].stats || {} }
          : { title: TITLES[k], ...d[k] };
        // 注入到各子标签的 chat 记录中
        S.chats[k] = [{ role:'assistant', content: d[k].content || '' }];
        // 存储 chatHTML 供切换子标签时恢复
        S.chatHTML[k] = _buildChatMsgHTML(d[k].content || '');
      });

      // 当前子标签直接显示在 DOM 中
      const curContent = d[S.analysisTab]?.content || '';
      if (curContent) addMsg('analysis', 'ai', curContent);
      // 保存当前 DOM（addMsg 之后再存一次，确保同步）
      S.chatHTML[S.analysisTab] = document.getElementById('chat-analysis')?.innerHTML || S.chatHTML[S.analysisTab];

      if (applyBtn) applyBtn.disabled = false;
      ['location','site','building','general'].forEach(k =>
        document.getElementById(`asub-${k}`)?.classList.add('done')
      );
      document.getElementById('tab-analysis')?.classList.add('done');
      document.getElementById('btn-export')?.removeAttribute('disabled');
      renderPreviewPages();

    } catch(err) {
      thinking.remove();
      addMsg('analysis', 'ai', `⚠️ 生成失败：${err.message}\n\n请检查网络或 API Key，也可手动输入内容。`);
    }
    return;
  }

  /* ── 设计策略：引用前期分析结论 ── */
  if (screen === 'strategy') {
    if (S.applied.strategy) return;

    const applyBtn = document.getElementById('apply-strategy');
    if (applyBtn) applyBtn.disabled = true;
    const thinking = addThinking('strategy');

    // 引用前期分析结论作为上下文
    const analysisCtx = [
      S.applied.location?.content,
      S.applied.site?.content,
      S.applied.building?.content,
    ].filter(Boolean).join('\n\n');

    const prompt = `你是资深景观设计师。
项目：${infoStr || '未知项目'}
${analysisCtx ? `\n前期分析结论：\n${analysisCtx}\n` : ''}
基于以上分析，逻辑推导3-4条景观设计策略，严格返回 JSON，不要任何额外文字：
{
  "items": [
    { "name":"策略名（4-8字）", "desc":"一句话阐明为何采用此策略及核心做法（25-40字）" }
  ]
}`;

    try {
      const raw = await callAI([{ role:'user', content:prompt }], true);
      thinking.remove();
      const m = raw.match(/\{[\s\S]*\}/);
      if (!m) throw new Error('格式有误');
      const d = JSON.parse(m[0]);

      const items = (d.items || []).map(it => `${it.name}：${it.desc}`).join('\n');
      S.applied.strategy = { title:'设计策略', content: items };
      S.chats.strategy = [{ role:'assistant', content: items }];
      addMsg('strategy', 'ai', items);
      if (applyBtn) applyBtn.disabled = false;
      document.getElementById('tab-strategy')?.classList.add('done');
      document.getElementById('btn-export')?.removeAttribute('disabled');
      renderPreviewPages();

    } catch(err) {
      thinking.remove();
      addMsg('strategy', 'ai', `⚠️ 生成失败：${err.message}\n\n请手动输入策略内容。`);
    }
    return;
  }

  /* ── 设计构思：引用策略内容 ── */
  if (screen === 'concept') {
    if (S.applied.concept) return;

    const applyBtn = document.getElementById('apply-concept');
    if (applyBtn) applyBtn.disabled = true;
    const thinking = addThinking('concept');

    const strategyCtx = S.applied.strategy?.content || '';

    const prompt = `你是资深景观设计师。
项目：${infoStr || '未知项目'}
${strategyCtx ? `\n设计策略：\n${strategyCtx}\n` : ''}
基于以上信息，提炼设计构思与设计理念，严格返回 JSON，不要任何额外文字：
{
  "concept": { "content":"150-200字，阐述设计灵感来源与空间叙事主题", "keywords":["意向图关键词1","意向图关键词2","意向图关键词3"] },
  "theme":   { "content":"150-200字，提炼项目核心价值观与精神主张，语言有感染力" }
}`;

    try {
      const raw = await callAI([{ role:'user', content:prompt }], true);
      thinking.remove();
      const m = raw.match(/\{[\s\S]*\}/);
      if (!m) throw new Error('格式有误');
      const d = JSON.parse(m[0]);

      if (d.concept) {
        S.applied.concept = { title:'设计构思', ...d.concept };
        S.chats.concept = [{ role:'assistant', content: d.concept.content || '' }];
        addMsg('concept', 'ai', d.concept.content || '');
        if (applyBtn) applyBtn.disabled = false;
      }
      if (d.theme) { S.applied.theme = { title:'设计理念', ...d.theme }; }

      document.getElementById('tab-concept')?.classList.add('done');
      document.getElementById('btn-export')?.removeAttribute('disabled');
      renderPreviewPages();

    } catch(err) {
      thinking.remove();
      addMsg('concept', 'ai', `⚠️ 生成失败：${err.message}\n\n请手动输入构思内容。`);
    }
  }
}

/* 构建单条 AI 消息的 HTML（供 S.chatHTML 存储非当前子标签的内容） */
function _buildChatMsgHTML(text) {
  const time = new Date().toLocaleTimeString('zh-CN', { hour:'2-digit', minute:'2-digit' });
  const html = text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/\n/g,'<br>');
  return `<div class="msg ai"><div class="msg-bubble">${html}</div><div class="msg-time">${time}</div></div>`;
}

/* ============================================================
   IDML 导出（占位）
============================================================ */
/* ============================================================
   IDML 导出 —— 将所有已应用章节生成 InDesign 可直接打开的 .idml 文件
   坐标单位：点（pt），1mm = 2.834645pt
   页数自动匹配已应用内容的章节数量
============================================================ */
async function exportIDML() {
  // 检查至少有一个章节已应用
  const hasAny = Object.values(S.applied).some(v => v !== null);
  if (!hasAny) {
    toast('请先生成并应用至少一个章节内容');
    return;
  }

  const MM = 2.834645;  // 1mm = 2.834645pt（InDesign 点单位）
  const pw = S.pageW * MM;   // 页宽（pt）
  const ph = S.pageH * MM;   // 页高（pt）
  const mg = S.pageMargin * MM; // 页边距（pt）

  // 内容区
  const cTop    = mg;
  const cLeft   = mg;
  const cBottom = ph - mg;
  const cRight  = pw - mg;
  const cW      = cRight - cLeft;
  const cH      = cBottom - cTop;

  // 根据已应用内容动态决定页面顺序（叙事逻辑：分析→策略→构思→理念）
  const pageDefaults = [
    { id:'location', ch:'Chapter 01 · 前期分析', layout:'text-right',      imgCount:3 },
    { id:'site',     ch:'Chapter 01 · 前期分析', layout:'text-right-grid',  imgCount:5 },
    { id:'building', ch:'Chapter 01 · 前期分析', layout:'text-left',        imgCount:3 },
    { id:'general',  ch:'Chapter 01 · 前期分析', layout:'text-right',       imgCount:1 },
    { id:'strategy', ch:'Chapter 02 · 设计策略', layout:'list-right',       imgCount:1 },
    { id:'concept',  ch:'Chapter 03 · 设计构思', layout:'grid-overlay',     imgCount:4 },
    { id:'theme',    ch:'Chapter 03 · 设计构思', layout:'text-top',         imgCount:3 },
  ];

  // 只导出有内容的章节
  const pagesData = pageDefaults
    .filter(pd => S.applied[pd.id] !== null && S.applied[pd.id] !== undefined)
    .map(pd => {
      const a = S.applied[pd.id];
      // strategy 的 content 字段是策略条目拼接字符串，保持原样
      return {
        ...pd,
        title:    a.title    || pd.id,
        content:  a.content  || '',
        keywords: a.keywords || [],
      };
    });

  if (pagesData.length === 0) {
    toast('没有可导出的章节，请先应用章节内容');
    return;
  }

  const entries = [];

  /* ---- mimetype（必须第一个，不压缩） ---- */
  entries.push({ name: 'mimetype', data: 'application/vnd.adobe.indesign-idml-package' });

  /* ---- META-INF/container.xml ---- */
  entries.push({ name: 'META-INF/container.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<container xmlns="urn:oasis:names:tc:opendocument:xmlns:container" version="1.0">
  <rootfiles>
    <rootfile full-path="designmap.xml" media-type="application/vnd.adobe.indesign-idml-package"/>
  </rootfiles>
</container>` });

  /* ---- XML/Tags.xml ---- */
  entries.push({ name: 'XML/Tags.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Tags xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0"></idPkg:Tags>` });

  /* ---- XML/BackingStory.xml ---- */
  entries.push({ name: 'XML/BackingStory.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Story xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <XmlStory Self="rc_BACKING_STORY" AppliedTOCStyle="n" TrackChanges="false" StoryTitle="$ID/NullString">
    <StoryPreference OpticalMarginAlignment="false" OpticalMarginSize="12" FrameType="TextFrameType" StoryOrientation="Horizontal" StoryDirection="LeftToRightDirection"/>
    <InCopyExportOption IncludeGraphicProxies="true" IncludeAllResources="false"/>
  </XmlStory>
</idPkg:Story>` });

  /* ---- Resources/Fonts.xml ---- */
  entries.push({ name: 'Resources/Fonts.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Fonts xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <FontFamily Self="ff_msyh" Name="Microsoft YaHei">
    <Font Self="ff_msyh_r" FontFamily="Microsoft YaHei" Name="Microsoft YaHei\tRegular" PostScriptName="MicrosoftYaHei" Status="Installed" FontStyleName="Regular" FontType="OpenType" FullName="Microsoft YaHei"/>
    <Font Self="ff_msyh_b" FontFamily="Microsoft YaHei" Name="Microsoft YaHei\tBold"    PostScriptName="MicrosoftYaHei-Bold"   Status="Installed" FontStyleName="Bold"    FontType="OpenType" FullName="Microsoft YaHei Bold"/>
  </FontFamily>
</idPkg:Fonts>` });

  /* ---- Resources/Graphic.xml — 颜色定义（必须列出所有用到的颜色） ---- */
  entries.push({ name: 'Resources/Graphic.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Graphic xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <ColorGroup Self="cg_default" Name="$ID/">
    <Color Self="Color/Black"              Name="Black"              Model="Process" Space="CMYK" ColorValue="0 0 0 100" IsSpot="false"/>
    <Color Self="Color/C=0 M=0 Y=0 K=100" Name="C=0 M=0 Y=0 K=100" Model="Process" Space="CMYK" ColorValue="0 0 0 100" IsSpot="false"/>
    <Color Self="Color/C=0 M=0 Y=0 K=85"  Name="C=0 M=0 Y=0 K=85"  Model="Process" Space="CMYK" ColorValue="0 0 0 85"  IsSpot="false"/>
    <Color Self="Color/C=0 M=0 Y=0 K=80"  Name="C=0 M=0 Y=0 K=80"  Model="Process" Space="CMYK" ColorValue="0 0 0 80"  IsSpot="false"/>
    <Color Self="Color/C=0 M=0 Y=0 K=60"  Name="C=0 M=0 Y=0 K=60"  Model="Process" Space="CMYK" ColorValue="0 0 0 60"  IsSpot="false"/>
    <Color Self="Color/C=0 M=0 Y=0 K=15"  Name="C=0 M=0 Y=0 K=15"  Model="Process" Space="CMYK" ColorValue="0 0 0 15"  IsSpot="false"/>
    <Color Self="Color/White"              Name="White"              Model="Process" Space="CMYK" ColorValue="0 0 0 0"   IsSpot="false"/>
    <Color Self="Color/None"               Name="$ID/None"           Model="Process" Space="CMYK" ColorValue="0 0 0 0"   IsSpot="false"/>
  </ColorGroup>
</idPkg:Graphic>` });

  /* ---- Resources/Preferences.xml ---- */
  entries.push({ name: 'Resources/Preferences.xml', data:
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Preferences xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <DocumentPreference PageWidth="${pw.toFixed(3)}" PageHeight="${ph.toFixed(3)}" FacingPages="false" AllowPageShuffle="true" DocumentBleedTopOffset="0" DocumentBleedBottomOffset="0" DocumentBleedInsideOrLeftOffset="0" DocumentBleedOutsideOrRightOffset="0"/>
  <GridPreference BaselineStart="${mg.toFixed(3)}" BaselineDivision="14.4" BaselineGridShown="false" ColumnGuidesShown="true" DocumentGridShown="false"/>
  <MarginPreference Top="${mg.toFixed(3)}" Bottom="${mg.toFixed(3)}" Left="${mg.toFixed(3)}" Right="${mg.toFixed(3)}" ColumnCount="1" ColumnGutter="14.4"/>
  <PasteboardPreference PasteboardMargins="116.220472440945 116.220472440945" MinimumSpaceBetweenPages="28.3464566929134" PreviewBackgroundColor="Color/C=0 M=0 Y=0 K=15"/>
</idPkg:Preferences>` });

  /* ---- Resources/Styles.xml ---- */
  entries.push({ name: 'Resources/Styles.xml', data: _buildStylesXML() });

  /* ---- 为每页生成 Spread + Story ---- */
  const spreadRefs = [];
  const storyRefs  = [];
  let   imgCounter = 0;

  pagesData.forEach((pd, pi) => {
    const spreadId    = `ub${pi}`;
    const textStoryId = `st_${spreadId}_txt`;
    spreadRefs.push(spreadId);
    entries.push({ name: `Stories/Story_${textStoryId}.xml`, data: _buildStoryXML(textStoryId, pd) });
    storyRefs.push(textStoryId);
    entries.push({ name: `Spreads/Spread_${spreadId}.xml`,   data: _buildSpreadXML(spreadId, `${spreadId}p`, textStoryId, pd, pi, pw, ph, mg, cTop, cLeft, cBottom, cRight, cW, cH, imgCounter) });
    imgCounter += pd.imgCount;
  });

  /* ---- designmap.xml ---- */
  entries.push({ name: 'designmap.xml', data: _buildDesignMap(spreadRefs, storyRefs, pw, ph, mg) });

  /* ---- 打包下载 ---- */
  try {
    const zipBytes = await _buildZipStore(entries);
    const blob = new Blob([zipBytes], { type: 'application/zip' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    const name = S.info.name || document.getElementById('proj-name')?.value || '景观设计';
    a.href = url;
    a.download = `${name}.idml`;
    a.click();
    URL.revokeObjectURL(url);
    toast(`IDML 已导出（共 ${pagesData.length} 页），在 InDesign 中直接打开`);
  } catch(err) {
    toast('导出失败：' + err.message);
    console.error('IDML导出错误：', err);
  }
}

/* ============================================================
   IDML 内部：designmap.xml
============================================================ */
function _buildDesignMap(spreadRefs, storyRefs, pw, ph, mg) {
  const spreadsXML = spreadRefs.map(id => `  <idPkg:Spread src="Spreads/Spread_${id}.xml"/>`).join('\n');
  const storiesXML = storyRefs.map(id  => `  <idPkg:Story  src="Stories/Story_${id}.xml"/>`).join('\n');
  const storyList  = storyRefs.join(' ');
  return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<?aid style="50" type="document" readerVersion="6.0" featureSet="257" product="19.0(151)" ?>
<Document xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging"
  DOMVersion="19.0" Self="d" ActiveLayer="lyr1"
  StoryList="${storyList}" Name="landscape-design" ZeroPoint="0 0">
  <idPkg:Fonts       src="Resources/Fonts.xml"/>
  <idPkg:Styles      src="Resources/Styles.xml"/>
  <idPkg:Preferences src="Resources/Preferences.xml"/>
  <idPkg:Graphic     src="Resources/Graphic.xml"/>
  <Layer Self="lyr1" Name="Layer 1" Visible="true" Locked="false"
    IgnoreWrap="false" ShowGuides="true" LockGuides="false"
    UI="true" Expendable="true" Printable="true"/>
${spreadsXML}
  <idPkg:BackingStory src="XML/BackingStory.xml"/>
  <idPkg:Tags         src="XML/Tags.xml"/>
${storiesXML}
</Document>`;
}

/* ============================================================
   IDML 内部：Styles.xml（段落/字符/对象样式）
   关键：[No paragraph style] 带 FillColor="Color/Black" → 文字颜色来源
============================================================ */
function _buildStylesXML() {
  return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Styles xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <RootCharacterStyleGroup Self="rootCharacterStyleGroup">
    <CharacterStyle Self="CharacterStyle/$ID/[No character style]" Name="$ID/[No character style]"/>
  </RootCharacterStyleGroup>
  <RootParagraphStyleGroup Self="rootParagraphStyleGroup">
    <ParagraphStyle Self="ParagraphStyle/$ID/[No paragraph style]"
      Name="$ID/[No paragraph style]" FillColor="Color/Black">
      <Properties>
        <Leading type="enumeration">Auto</Leading>
        <AppliedFont type="string">Microsoft YaHei</AppliedFont>
      </Properties>
    </ParagraphStyle>
    <ParagraphStyle Self="ParagraphStyle/$ID/NormalParagraphStyle"
      Name="$ID/NormalParagraphStyle"
      NextStyle="ParagraphStyle/$ID/NormalParagraphStyle">
      <Properties>
        <BasedOn type="string">$ID/[No paragraph style]</BasedOn>
      </Properties>
    </ParagraphStyle>
  </RootParagraphStyleGroup>
  <RootTableStyleGroup Self="rootTableStyleGroup">
    <TableStyle Self="TableStyle/$ID/[No table style]" Name="$ID/[No table style]"/>
    <TableStyle Self="TableStyle/$ID/[Basic Table]" Name="$ID/[Basic Table]">
      <Properties><BasedOn type="string">$ID/[No table style]</BasedOn></Properties>
    </TableStyle>
  </RootTableStyleGroup>
  <RootCellStyleGroup Self="rootCellStyleGroup">
    <CellStyle Self="CellStyle/$ID/[None]" Name="$ID/[None]"/>
  </RootCellStyleGroup>
  <RootObjectStyleGroup Self="rootObjectStyleGroup">
    <ObjectStyle Self="ObjectStyle/$ID/[None]"                  Name="$ID/[None]"/>
    <ObjectStyle Self="ObjectStyle/$ID/[Normal Graphics Frame]" Name="$ID/[Normal Graphics Frame]">
      <Properties><BasedOn type="string">$ID/[None]</BasedOn></Properties>
    </ObjectStyle>
    <ObjectStyle Self="ObjectStyle/$ID/[Normal Text Frame]"     Name="$ID/[Normal Text Frame]">
      <Properties><BasedOn type="string">$ID/[None]</BasedOn></Properties>
    </ObjectStyle>
    <ObjectStyle Self="ObjectStyle/$ID/[Normal Grid]"           Name="$ID/[Normal Grid]">
      <Properties><BasedOn type="string">$ID/[None]</BasedOn></Properties>
    </ObjectStyle>
  </RootObjectStyleGroup>
</idPkg:Styles>`;
}

/* ============================================================
   IDML 内部：Story XML（文字内容）
============================================================ */
function _buildStoryXML(storyId, pd) {
  function escXML(str) {
    return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  // 颜色/字号/字重映射
  const colorMap = { chapter:'Color/C=0 M=0 Y=0 K=60', title:'Color/C=0 M=0 Y=0 K=100', body:'Color/C=0 M=0 Y=0 K=85', kw:'Color/C=0 M=0 Y=0 K=80' };
  const sizeMap  = { chapter:'9', title:'24', body:'18', kw:'14' };

  const makeParaXML = (styleKey, text) => {
    const fillColor = colorMap[styleKey] || 'Color/C=0 M=0 Y=0 K=100';
    const ptSize    = sizeMap[styleKey]  || '18';
    const isBold    = (styleKey === 'title' || styleKey === 'kw');
    return `    <ParagraphStyleRange AppliedParagraphStyle="ParagraphStyle/$ID/NormalParagraphStyle">
      <CharacterStyleRange AppliedCharacterStyle="CharacterStyle/$ID/[No character style]"
        FontStyle="${isBold ? 'Bold' : 'Regular'}" PointSize="${ptSize}"
        Leading="${Math.round(+ptSize * 1.5)}" FillColor="${fillColor}">
        <Properties><AppliedFont type="string">Microsoft YaHei</AppliedFont></Properties>
        <Content>${escXML(text)}</Content>
      </CharacterStyleRange>
      <CharacterStyleRange AppliedCharacterStyle="CharacterStyle/$ID/[No character style]"><Br/></CharacterStyleRange>
    </ParagraphStyleRange>`;
  };

  const paras = [];
  paras.push(makeParaXML('chapter', pd.ch || ''));
  paras.push(makeParaXML('title',   pd.title || ''));
  if (pd.content) {
    pd.content.split('\n').filter(l => l.trim()).forEach(l => paras.push(makeParaXML('body', l.trim())));
  }
  if (pd.keywords && pd.keywords.length) {
    pd.keywords.forEach(kw => paras.push(makeParaXML('kw', `• ${kw}`)));
  }

  return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Story xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <Story Self="${storyId}" AppliedTOCStyle="n" TrackChanges="false" StoryTitle="${escXML(pd.title)}">
    <StoryPreference OpticalMarginAlignment="false" OpticalMarginSize="12" FrameType="TextFrameType" StoryOrientation="Horizontal" StoryDirection="LeftToRightDirection"/>
    <InCopyExportOption IncludeGraphicProxies="true" IncludeAllResources="false"/>
${paras.join('\n')}
  </Story>
</idPkg:Story>`;
}

/* ============================================================
   IDML 内部：Spread XML（页面布局，各章节对应不同版式）
   坐标系：页面中心 = Spread(0,0)，所有帧 ItemTransform 指向帧中心
============================================================ */
function _buildSpreadXML(spreadId, pageId, textStoryId, pd, pageIndex, pw, ph, mg, cTop, cLeft, cBottom, cRight, cW, cH, imgStartIdx) {
  const items = [];
  const layout = pd.layout;
  const bTop = cTop, bLeft = cLeft, bBottom = cBottom, bRight = cRight, bW = cW, bH = cH;

  if (layout === 'text-right') {
    // 区位/工程概况：左65%图片 + 右35%文字
    const imgW = bW * 0.65;
    const txtLeft = bLeft + imgW + 8;
    items.push(_gfXML(`gf_${spreadId}_1`, bTop,              bLeft,           bTop + bH*0.65,    bLeft + imgW,      spreadId, pw, ph));
    items.push(_gfXML(`gf_${spreadId}_2`, bTop + bH*0.65+4, bLeft,           bBottom,           bLeft + imgW/2-2,  spreadId, pw, ph));
    items.push(_gfXML(`gf_${spreadId}_3`, bTop + bH*0.65+4, bLeft+imgW/2+2, bBottom,           bLeft + imgW,      spreadId, pw, ph));
    items.push(_tfXML(`tf_${spreadId}`,   textStoryId, bTop, txtLeft, bBottom, bRight, spreadId, pw, ph));
  } else if (layout === 'text-right-grid') {
    // 场地现状：3列2行网格左65% + 右文字
    const imgW = bW * 0.67;
    const txtLeft = bLeft + imgW + 8;
    const gap = 4, colW = imgW/3 - gap;
    const c1 = bLeft, c2 = bLeft + imgW/3 + gap, c3 = bLeft + imgW/3*2 + gap*2;
    const row1H = bH * 0.58, row2Top = bTop + row1H + gap;
    items.push(_gfXML(`gf_${spreadId}_1`, bTop,    c1,     bTop+row1H, c1+colW*2+gap, spreadId, pw, ph));
    items.push(_gfXML(`gf_${spreadId}_2`, row2Top, c1,     bBottom,    c1+colW,       spreadId, pw, ph));
    items.push(_gfXML(`gf_${spreadId}_3`, row2Top, c2,     bBottom,    c2+colW,       spreadId, pw, ph));
    items.push(_gfXML(`gf_${spreadId}_4`, row2Top, c3,     bBottom,    c3+colW,       spreadId, pw, ph));
    items.push(_tfXML(`tf_${spreadId}`,   textStoryId, bTop, txtLeft, bBottom, bRight, spreadId, pw, ph));
  } else if (layout === 'text-left') {
    // 建筑分析：文字左34% + 网格图右66%
    const txtW = bW * 0.34;
    const imgLeft = bLeft + txtW + 8, imgW = bRight - imgLeft;
    const gap = 4, colW = imgW/2 - gap/2;
    const c1 = imgLeft, c2 = imgLeft + imgW/2 + gap/2;
    const row1H = bH * 0.57, row2Top = bTop + row1H + gap;
    items.push(_tfXML(`tf_${spreadId}`,   textStoryId, bTop, bLeft, bBottom, bLeft+txtW, spreadId, pw, ph));
    items.push(_gfXML(`gf_${spreadId}_1`, bTop,    imgLeft, bTop+row1H, bRight,  spreadId, pw, ph));
    items.push(_gfXML(`gf_${spreadId}_2`, row2Top, c1,      bBottom,    c1+colW, spreadId, pw, ph));
    items.push(_gfXML(`gf_${spreadId}_3`, row2Top, c2,      bBottom,    c2+colW, spreadId, pw, ph));
  } else if (layout === 'list-right') {
    // 设计策略：左大图63% + 右文字列表
    const imgW = bW * 0.63;
    const txtLeft = bLeft + imgW + 8;
    items.push(_gfXML(`gf_${spreadId}_1`, bTop, bLeft, bBottom, bLeft+imgW, spreadId, pw, ph));
    items.push(_tfXML(`tf_${spreadId}`,   textStoryId, bTop, txtLeft, bBottom, bRight, spreadId, pw, ph));
  } else if (layout === 'grid-overlay') {
    // 设计构思：2×2图片网格 + 中央浮动文字框
    const gap = 6, halfW = (bW-gap)/2, halfH = (bH-gap)/2;
    items.push(_gfXML(`gf_${spreadId}_1`, bTop,         bLeft,        bTop+halfH,  bLeft+halfW,  spreadId, pw, ph));
    items.push(_gfXML(`gf_${spreadId}_2`, bTop,         bLeft+halfW+gap, bTop+halfH,  bRight,    spreadId, pw, ph));
    items.push(_gfXML(`gf_${spreadId}_3`, bTop+halfH+gap, bLeft,      bBottom,     bLeft+halfW,  spreadId, pw, ph));
    items.push(_gfXML(`gf_${spreadId}_4`, bTop+halfH+gap, bLeft+halfW+gap, bBottom, bRight,     spreadId, pw, ph));
    const ovW = bW*0.44, ovH = bH*0.4;
    const ovL = bLeft + (bW-ovW)/2, ovT = bTop + (bH-ovH)/2;
    items.push(_tfXML(`tf_${spreadId}`,   textStoryId, ovT, ovL, ovT+ovH, ovL+ovW, spreadId, pw, ph));
  } else if (layout === 'text-top') {
    // 设计理念：文字上28% + 下方图片
    const txtH = bH * 0.28, imgTop = bTop + txtH + 6;
    items.push(_tfXML(`tf_${spreadId}`,   textStoryId, bTop, bLeft, bTop+txtH, bRight, spreadId, pw, ph));
    const imgLW = bW*0.58, imgRL = bLeft+imgLW+6;
    const halfH = (bH - txtH - 6 - 4) / 2;
    items.push(_gfXML(`gf_${spreadId}_1`, imgTop,       bLeft,  bBottom,     bLeft+imgLW, spreadId, pw, ph));
    items.push(_gfXML(`gf_${spreadId}_2`, imgTop,       imgRL,  imgTop+halfH, bRight,     spreadId, pw, ph));
    items.push(_gfXML(`gf_${spreadId}_3`, imgTop+halfH+4, imgRL, bBottom,     bRight,     spreadId, pw, ph));
  }

  return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idPkg:Spread xmlns:idPkg="http://ns.adobe.com/AdobeInDesign/idml/1.0/packaging" DOMVersion="19.0">
  <Spread Self="${spreadId}" PageCount="1" BindingLocation="0" AllowPageShuffle="true">
    <FlattenerPreference LineArtAndTextResolution="300" GradientAndMeshResolution="150" ClipComplexRegions="false" ConvertAllStrokesToOutlines="false" ConvertAllTextToOutlines="false"/>
    <Page Self="${pageId}" MasterPageTransform="1 0 0 1 0 0" Name="${pageIndex+1}" AppliedMaster="n"
      GeometricBounds="0 0 ${ph.toFixed(3)} ${pw.toFixed(3)}"
      ItemTransform="1 0 0 1 ${(-pw/2).toFixed(3)} ${(-ph/2).toFixed(3)}">
      <MarginPreference Top="${mg.toFixed(3)}" Bottom="${mg.toFixed(3)}" Left="${mg.toFixed(3)}" Right="${mg.toFixed(3)}" ColumnCount="1" ColumnGutter="14.4"/>
    </Page>
${items.join('\n')}
  </Spread>
</idPkg:Spread>`;
}

/* ---- 文字框 XML ---- */
function _tfXML(selfId, storyId, top, left, bottom, right, spreadId, pw, ph) {
  const w=right-left, h=bottom-top;
  const hw=(w/2).toFixed(3), hh=(h/2).toFixed(3);
  const cx=((left+right)/2-pw/2).toFixed(3), cy=((top+bottom)/2-ph/2).toFixed(3);
  return `    <TextFrame Self="${selfId}" ParentStory="${storyId}" PreviousTextFrame="n" NextTextFrame="n"
      ContentType="TextType" AppliedObjectStyle="ObjectStyle/$ID/[Normal Text Frame]"
      ItemTransform="1 0 0 1 ${cx} ${cy}" ItemLayer="lyr1">
      <Properties>
        <PathGeometry><GeometryPathType PathOpen="false"><PathPointArray>
          <PathPointType Anchor="-${hw} -${hh}" LeftDirection="-${hw} -${hh}" RightDirection="-${hw} -${hh}"/>
          <PathPointType Anchor="-${hw} ${hh}"  LeftDirection="-${hw} ${hh}"  RightDirection="-${hw} ${hh}"/>
          <PathPointType Anchor="${hw} ${hh}"   LeftDirection="${hw} ${hh}"   RightDirection="${hw} ${hh}"/>
          <PathPointType Anchor="${hw} -${hh}"  LeftDirection="${hw} -${hh}"  RightDirection="${hw} -${hh}"/>
        </PathPointArray></GeometryPathType></PathGeometry>
      </Properties>
      <TextFramePreference TextColumnCount="1" TextColumnGutter="14.173"
        VerticalJustification="TopAlign" FirstBaselineOffset="EmboxHeight">
        <Properties><InsetSpacing type="list">
          <ListItem type="unit">0</ListItem><ListItem type="unit">0</ListItem>
          <ListItem type="unit">0</ListItem><ListItem type="unit">0</ListItem>
        </InsetSpacing></Properties>
      </TextFramePreference>
    </TextFrame>`;
}

/* ---- 图片框 XML（空占位，InDesign 中可置入图片） ---- */
function _gfXML(selfId, top, left, bottom, right, spreadId, pw, ph) {
  const w=right-left, h=bottom-top;
  const hw=(w/2).toFixed(3), hh=(h/2).toFixed(3);
  const cx=((left+right)/2-pw/2).toFixed(3), cy=((top+bottom)/2-ph/2).toFixed(3);
  return `    <Rectangle Self="${selfId}"
      ContentType="GraphicType" AppliedObjectStyle="ObjectStyle/$ID/[Normal Graphics Frame]"
      StrokeWeight="1" StrokeColor="Color/C=0 M=0 Y=0 K=15" FillColor="Color/None"
      ItemTransform="1 0 0 1 ${cx} ${cy}" ItemLayer="lyr1">
      <Properties>
        <PathGeometry><GeometryPathType PathOpen="false"><PathPointArray>
          <PathPointType Anchor="-${hw} -${hh}" LeftDirection="-${hw} -${hh}" RightDirection="-${hw} -${hh}"/>
          <PathPointType Anchor="-${hw} ${hh}"  LeftDirection="-${hw} ${hh}"  RightDirection="-${hw} ${hh}"/>
          <PathPointType Anchor="${hw} ${hh}"   LeftDirection="${hw} ${hh}"   RightDirection="${hw} ${hh}"/>
          <PathPointType Anchor="${hw} -${hh}"  LeftDirection="${hw} -${hh}"  RightDirection="${hw} -${hh}"/>
        </PathPointArray></GeometryPathType></PathGeometry>
      </Properties>
    </Rectangle>`;
}

/* ============================================================
   ZIP 构建器（纯 JS，无需 JSZip 库）
   mimetype → STORE，其余 → DEFLATE（与真实 IDML 格式一致）
============================================================ */
function _makeCRC32Table() {
  const t = new Uint32Array(256);
  for (let n = 0; n < 256; n++) {
    let c = n;
    for (let k = 0; k < 8; k++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
    t[n] = c >>> 0;
  }
  return t;
}
const _CRC32_TABLE = _makeCRC32Table();

function _crc32(data) {
  let c = 0xFFFFFFFF;
  for (let i = 0; i < data.length; i++)
    c = (_CRC32_TABLE[(c ^ data[i]) & 0xFF] ^ (c >>> 8)) >>> 0;
  return (c ^ 0xFFFFFFFF) >>> 0;
}

async function _deflateRaw(data) {
  const cs = new CompressionStream('deflate-raw');
  const writer = cs.writable.getWriter();
  writer.write(data); writer.close();
  const chunks = [];
  const reader = cs.readable.getReader();
  while (true) { const { done, value } = await reader.read(); if (done) break; chunks.push(value); }
  let size = 0; for (const c of chunks) size += c.length;
  const out = new Uint8Array(size); let pos = 0;
  for (const c of chunks) { out.set(c, pos); pos += c.length; }
  return out;
}

async function _buildZipStore(entries) {
  const enc = new TextEncoder();
  const localParts = [], cdEntries = [];
  let offset = 0;

  for (const entry of entries) {
    const name    = enc.encode(entry.name);
    const rawData = typeof entry.data === 'string' ? enc.encode(entry.data) : entry.data;
    const crc     = _crc32(rawData);
    const origSize = rawData.length;
    const isMime  = (entry.name === 'mimetype');
    let compData, method, verNeeded;
    if (isMime) {
      compData = rawData; method = 0; verNeeded = 10;
    } else {
      compData = await _deflateRaw(rawData);
      if (compData.length >= origSize) { compData = rawData; method = 0; verNeeded = 10; }
      else { method = 8; verNeeded = 20; }
    }
    const compSize = compData.length;
    const lh = new Uint8Array(30 + name.length);
    const lv = new DataView(lh.buffer);
    lv.setUint32(0, 0x04034b50, true); lv.setUint16(4, verNeeded, true);
    lv.setUint16(6, 0,          true); lv.setUint16(8, method,    true);
    lv.setUint16(10,0,          true); lv.setUint16(12,0,         true);
    lv.setUint32(14,crc,        true); lv.setUint32(18,compSize,  true);
    lv.setUint32(22,origSize,   true); lv.setUint16(26,name.length,true);
    lv.setUint16(28,0,          true);
    lh.set(name, 30);
    cdEntries.push({ name, crc, compSize, origSize, offset, method, verNeeded });
    localParts.push(lh, compData);
    offset += 30 + name.length + compSize;
  }

  const cdStart = offset;
  const cdChunks = cdEntries.map(cd => {
    const chunk = new Uint8Array(46 + cd.name.length);
    const dv = new DataView(chunk.buffer);
    dv.setUint32(0, 0x02014b50,true); dv.setUint16(4,20,true); dv.setUint16(6,cd.verNeeded,true);
    dv.setUint16(8, 0,true);          dv.setUint16(10,cd.method,true);
    dv.setUint16(12,0,true);          dv.setUint16(14,0,true);
    dv.setUint32(16,cd.crc,true);     dv.setUint32(20,cd.compSize,true);
    dv.setUint32(24,cd.origSize,true);dv.setUint16(28,cd.name.length,true);
    dv.setUint16(30,0,true);          dv.setUint16(32,0,true);
    dv.setUint16(34,0,true);          dv.setUint16(36,0,true);
    dv.setUint32(38,0,true);          dv.setUint32(42,cd.offset,true);
    chunk.set(cd.name, 46);
    return chunk;
  });

  const cdSize = cdChunks.reduce((s,c) => s+c.length, 0);
  const eocd = new Uint8Array(22);
  const ev = new DataView(eocd.buffer);
  ev.setUint32(0,0x06054b50,true); ev.setUint16(4,0,true); ev.setUint16(6,0,true);
  ev.setUint16(8,cdEntries.length,true); ev.setUint16(10,cdEntries.length,true);
  ev.setUint32(12,cdSize,true); ev.setUint32(16,cdStart,true); ev.setUint16(20,0,true);

  const total = offset + cdSize + eocd.length;
  const out = new Uint8Array(total);
  let pos = 0;
  for (const p of localParts) { out.set(p, pos); pos += p.length; }
  for (const c of cdChunks)   { out.set(c, pos); pos += c.length; }
  out.set(eocd, pos);
  return out;
}

/* ============================================================
   设置面板
============================================================ */
function openSettings() {
  document.getElementById('api-key-input').value = S.apiKey;
  document.getElementById('endpoint-input').value = S.endpoint;
  setProvider(S.provider, false);
  document.getElementById('settings-modal').classList.add('open');
}
function closeSettings() { document.getElementById('settings-modal').classList.remove('open'); }
function setProvider(p, save = false) {
  S.provider = p;
  ['deepseek','doubao','openai'].forEach(id => document.getElementById(`prov-${id}`).classList.toggle('active', id === p));
  document.getElementById('endpoint-row').style.display = p === 'doubao' ? 'block' : 'none';
  const sel = document.getElementById('model-select');
  if (p === 'deepseek') sel.innerHTML = `<option value="deepseek-chat">deepseek-chat（推荐）</option><option value="deepseek-reasoner">deepseek-reasoner（思考型）</option>`;
  else if (p === 'openai') sel.innerHTML = `<option value="gpt-4o">gpt-4o</option><option value="gpt-4o-mini">gpt-4o-mini</option>`;
  else sel.innerHTML = `<option value="custom">自定义（见端点ID）</option>`;
  if (S.model) sel.value = S.model;
}
function saveSettings() {
  S.apiKey   = document.getElementById('api-key-input').value.trim();
  S.model    = document.getElementById('model-select').value;
  S.endpoint = document.getElementById('endpoint-input').value.trim();
  localStorage.setItem('ld-v2', JSON.stringify({ apiKey:S.apiKey, provider:S.provider, model:S.model, endpoint:S.endpoint }));
  updateApiStatus(); closeSettings(); toast('设置已保存');
}
function loadSettings() {
  try {
    const c = JSON.parse(localStorage.getItem('ld-v2') || '{}');
    if (c.apiKey)   S.apiKey   = c.apiKey;
    if (c.provider) S.provider = c.provider;
    if (c.model)    S.model    = c.model;
    if (c.endpoint) S.endpoint = c.endpoint;
  } catch(e) {}
  updateApiStatus();
}
function updateApiStatus() {
  const dot = document.getElementById('api-dot');
  const lbl = document.getElementById('api-label');
  if (S.apiKey) { dot.className='api-dot ok'; lbl.textContent = ({deepseek:'DeepSeek',doubao:'豆包',openai:'OpenAI'}[S.provider]||'API') + ' 已连接'; }
  else { dot.className='api-dot'; lbl.textContent='未配置 API'; }
}

/* ============================================================
   全屏预览
============================================================ */
function toggleFullscreen() {
  const panel = document.getElementById('right-panel');
  const icon  = document.getElementById('fs-icon');

  if (!document.fullscreenElement) {
    panel.requestFullscreen().catch(() => toast('无法进入全屏，请检查浏览器权限'));
  } else {
    document.exitFullscreen();
  }
}

// 监听全屏状态变化（包含 ESC 退出），同步图标
document.addEventListener('fullscreenchange', () => {
  const icon = document.getElementById('fs-icon');
  if (!icon) return;
  if (document.fullscreenElement) {
    // 全屏中：显示「压缩」图标
    icon.innerHTML = '<path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>';
  } else {
    // 退出全屏：恢复「展开」图标
    icon.innerHTML = '<path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>';
  }
});

/* ============================================================
   Toast
============================================================ */
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => el.classList.remove('show'), 2800);
}
</script>
</body>
</html>
